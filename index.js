"use strict";var yc=Object.create;var _s=Object.defineProperty;var wc=Object.getOwnPropertyDescriptor;var bc=Object.getOwnPropertyNames;var Tc=Object.getPrototypeOf,kc=Object.prototype.hasOwnProperty;var Hi=n=>{throw TypeError(n)};var Sc=(n,e,t)=>e in n?_s(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var _c=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of bc(e))!kc.call(n,s)&&s!==t&&_s(n,s,{get:()=>e[s],enumerable:!(r=wc(e,s))||r.enumerable});return n};var Ec=(n,e,t)=>(t=n!=null?yc(Tc(n)):{},_c(e||!n||!n.__esModule?_s(t,"default",{value:n,enumerable:!0}):t,n));var y=(n,e,t)=>Sc(n,typeof e!="symbol"?e+"":e,t),Es=(n,e,t)=>e.has(n)||Hi("Cannot "+t);var d=(n,e,t)=>(Es(n,e,"read from private field"),t?t.call(n):e.get(n)),O=(n,e,t)=>e.has(n)?Hi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),x=(n,e,t,r)=>(Es(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t),G=(n,e,t)=>(Es(n,e,"access private method"),t);const Wi=require("siyuan"),Ns=!1;var eo=Array.isArray,Dc=Array.prototype.indexOf,Jn=Array.prototype.includes,ps=Array.from,to=Object.defineProperty,jn=Object.getOwnPropertyDescriptor,no=Object.getOwnPropertyDescriptors,xc=Object.prototype,Ac=Array.prototype,ai=Object.getPrototypeOf,Ki=Object.isExtensible;const Ht=()=>{};function Rc(n){return n()}function ss(n){for(var e=0;e<n.length;e++)n[e]()}function ro(){var n,e,t=new Promise((r,s)=>{n=r,e=s});return{promise:t,resolve:n,reject:e}}const he=2,Ls=4,Lr=8,so=1<<24,Et=16,Qe=32,Dn=64,oi=128,Be=512,ie=1024,we=2048,Dt=4096,Oe=8192,kt=16384,li=32768,er=65536,qi=1<<17,io=1<<18,ar=1<<19,ao=1<<20,Yt=1<<25,kn=32768,$s=1<<21,ci=1<<22,Wt=1<<23,Hn=Symbol("$state"),Ic=Symbol("legacy props"),Oc=Symbol(""),zn=new class extends Error{constructor(){super(...arguments);y(this,"name","StaleReactionError");y(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function oo(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Mc(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Cc(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Nc(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Lc(n){throw new Error("https://svelte.dev/e/effect_orphan")}function $c(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Uc(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function zc(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Fc(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Yc(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Pc(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const Bc=1,jc=2,Hc=16,Wc=2,Kc=4,qc=8,Gc=2,le=Symbol(),Qc="http://www.w3.org/1999/xhtml";function Xc(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function lo(n){return n===this.v}function co(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function uo(n){return!co(n,this.v)}let or=!1,Vc=!1;function Zc(){or=!0}let X=null;function tr(n){X=n}function ui(n,e=!1,t){X={p:X,i:!1,c:null,e:null,s:n,x:null,l:or&&!e?{s:null,u:null,$:[]}:null}}function hi(n){var e=X,t=e.e;if(t!==null){e.e=null;for(var r of t)Io(r)}return e.i=!0,X=e.p,{}}function $r(){return!or||X!==null&&X.l===null}let on=[];function ho(){var n=on;on=[],ss(n)}function yn(n){if(on.length===0&&!_r){var e=on;queueMicrotask(()=>{e===on&&ho()})}on.push(n)}function Jc(){for(;on.length>0;)ho()}function fo(n){var e=B;if(e===null)return z.f|=Wt,n;if(e.f&li)nr(n,e);else{if(!(e.f&oi))throw n;e.b.error(n)}}function nr(n,e){for(;e!==null;){if(e.f&oi)try{e.b.error(n);return}catch(t){n=t}e=e.parent}throw n}const eu=-7169;function te(n,e){n.f=n.f&eu|e}function fi(n){n.f&Be||n.deps===null?te(n,ie):te(n,Dt)}function vo(n){if(n!==null)for(const e of n)!(e.f&he)||!(e.f&kn)||(e.f^=kn,vo(e.deps))}function po(n,e,t){n.f&we?e.add(n):n.f&Dt&&t.add(n),vo(n.deps),te(n,ie)}const Gr=new Set;let $=null,Us=null,ue=null,Re=[],gs=null,zs=!1,_r=!1;var Kn,qn,un,Gn,Ir,Or,hn,Qn,ft,Fs,Ys,go;const Ii=class Ii{constructor(){O(this,ft);y(this,"committed",!1);y(this,"current",new Map);y(this,"previous",new Map);O(this,Kn,new Set);O(this,qn,new Set);O(this,un,0);O(this,Gn,0);O(this,Ir,null);O(this,Or,new Set);O(this,hn,new Set);y(this,"skipped_effects",new Set);y(this,"is_fork",!1);O(this,Qn,!1)}is_deferred(){return this.is_fork||d(this,Gn)>0}process(e){var s;Re=[],this.apply();var t=[],r=[];for(const i of e)G(this,ft,Fs).call(this,i,t,r);if(this.is_deferred()){G(this,ft,Ys).call(this,r),G(this,ft,Ys).call(this,t);for(const i of this.skipped_effects)bo(i)}else{for(const i of d(this,Kn))i();d(this,Kn).clear(),d(this,un)===0&&G(this,ft,go).call(this),Us=this,$=null,Gi(r),Gi(t),Us=null,(s=d(this,Ir))==null||s.resolve()}ue=null}capture(e,t){t!==le&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Wt||(this.current.set(e,e.v),ue==null||ue.set(e,e.v))}activate(){$=this,this.apply()}deactivate(){$===this&&($=null,ue=null)}flush(){if(this.activate(),Re.length>0){if(mo(),$!==null&&$!==this)return}else d(this,un)===0&&this.process([]);this.deactivate()}discard(){for(const e of d(this,qn))e(this);d(this,qn).clear()}increment(e){x(this,un,d(this,un)+1),e&&x(this,Gn,d(this,Gn)+1)}decrement(e){x(this,un,d(this,un)-1),e&&x(this,Gn,d(this,Gn)-1),!d(this,Qn)&&(x(this,Qn,!0),yn(()=>{x(this,Qn,!1),this.is_deferred()?Re.length>0&&this.flush():this.revive()}))}revive(){for(const e of d(this,Or))d(this,hn).delete(e),te(e,we),_t(e);for(const e of d(this,hn))te(e,Dt),_t(e);this.flush()}oncommit(e){d(this,Kn).add(e)}ondiscard(e){d(this,qn).add(e)}settled(){return(d(this,Ir)??x(this,Ir,ro())).promise}static ensure(){if($===null){const e=$=new Ii;Gr.add($),_r||yn(()=>{$===e&&e.flush()})}return $}apply(){}};Kn=new WeakMap,qn=new WeakMap,un=new WeakMap,Gn=new WeakMap,Ir=new WeakMap,Or=new WeakMap,hn=new WeakMap,Qn=new WeakMap,ft=new WeakSet,Fs=function(e,t,r){e.f^=ie;for(var s=e.first,i=null;s!==null;){var a=s.f,o=(a&(Qe|Dn))!==0,l=o&&(a&ie)!==0,c=l||(a&Oe)!==0||this.skipped_effects.has(s);if(!c&&s.fn!==null){o?s.f^=ie:i!==null&&a&(Ls|Lr|so)?i.b.defer_effect(s):a&Ls?t.push(s):zr(s)&&(a&Et&&d(this,hn).add(s),Ar(s));var u=s.first;if(u!==null){s=u;continue}}var h=s.parent;for(s=s.next;s===null&&h!==null;)h===i&&(i=null),s=h.next,h=h.parent}},Ys=function(e){for(var t=0;t<e.length;t+=1)po(e[t],d(this,Or),d(this,hn))},go=function(){var s;if(Gr.size>1){this.previous.clear();var e=ue,t=!0;for(const i of Gr){if(i===this){t=!1;continue}const a=[];for(const[l,c]of this.current){if(i.current.has(l))if(t&&c!==i.current.get(l))i.current.set(l,c);else continue;a.push(l)}if(a.length===0)continue;const o=[...i.current.keys()].filter(l=>!this.current.has(l));if(o.length>0){var r=Re;Re=[];const l=new Set,c=new Map;for(const u of a)yo(u,o,l,c);if(Re.length>0){$=i,i.apply();for(const u of Re)G(s=i,ft,Fs).call(s,u,[],[]);i.deactivate()}Re=r}}$=null,ue=e}this.committed=!0,Gr.delete(this)};let Kt=Ii;function tu(n){var e=_r;_r=!0;try{for(var t;;){if(Jc(),Re.length===0&&($==null||$.flush(),Re.length===0))return gs=null,t;mo()}}finally{_r=e}}function mo(){zs=!0;var n=null;try{for(var e=0;Re.length>0;){var t=Kt.ensure();if(e++>1e3){var r,s;nu()}t.process(Re),qt.clear()}}finally{zs=!1,gs=null}}function nu(){try{$c()}catch(n){nr(n,gs)}}let We=null;function Gi(n){var e=n.length;if(e!==0){for(var t=0;t<e;){var r=n[t++];if(!(r.f&(kt|Oe))&&zr(r)&&(We=new Set,Ar(r),r.deps===null&&r.first===null&&r.nodes===null&&(r.teardown===null&&r.ac===null?No(r):r.fn=null),(We==null?void 0:We.size)>0)){qt.clear();for(const s of We){if(s.f&(kt|Oe))continue;const i=[s];let a=s.parent;for(;a!==null;)We.has(a)&&(We.delete(a),i.push(a)),a=a.parent;for(let o=i.length-1;o>=0;o--){const l=i[o];l.f&(kt|Oe)||Ar(l)}}We.clear()}}We=null}}function yo(n,e,t,r){if(!t.has(n)&&(t.add(n),n.reactions!==null))for(const s of n.reactions){const i=s.f;i&he?yo(s,e,t,r):i&(ci|Et)&&!(i&we)&&wo(s,e,r)&&(te(s,we),_t(s))}}function wo(n,e,t){const r=t.get(n);if(r!==void 0)return r;if(n.deps!==null)for(const s of n.deps){if(Jn.call(e,s))return!0;if(s.f&he&&wo(s,e,t))return t.set(s,!0),!0}return t.set(n,!1),!1}function _t(n){for(var e=gs=n;e.parent!==null;){e=e.parent;var t=e.f;if(zs&&e===B&&t&Et&&!(t&io))return;if(t&(Dn|Qe)){if(!(t&ie))return;e.f^=ie}}Re.push(e)}function bo(n){if(!(n.f&Qe&&n.f&ie)){te(n,ie);for(var e=n.first;e!==null;)bo(e),e=e.next}}function ru(n){let e=0,t=Sn(0),r;return()=>{mi()&&(m(t),Oo(()=>(e===0&&(r=E(()=>n(()=>Er(t)))),e+=1,()=>{yn(()=>{e-=1,e===0&&(r==null||r(),r=void 0,Er(t))})})))}}var su=er|ar|oi;function iu(n,e,t){new au(n,e,t)}var ze,ii,it,fn,at,Fe,Te,ot,wt,$t,dn,Ut,Xn,vn,Vn,Zn,bt,ds,ae,ou,lu,Ps,Jr,es,Bs;class au{constructor(e,t,r){O(this,ae);y(this,"parent");y(this,"is_pending",!1);O(this,ze);O(this,ii,null);O(this,it);O(this,fn);O(this,at);O(this,Fe,null);O(this,Te,null);O(this,ot,null);O(this,wt,null);O(this,$t,null);O(this,dn,0);O(this,Ut,0);O(this,Xn,!1);O(this,vn,!1);O(this,Vn,new Set);O(this,Zn,new Set);O(this,bt,null);O(this,ds,ru(()=>(x(this,bt,Sn(d(this,dn))),()=>{x(this,bt,null)})));x(this,ze,e),x(this,it,t),x(this,fn,r),this.parent=B.b,this.is_pending=!!d(this,it).pending,x(this,at,wi(()=>{B.b=this;{var s=G(this,ae,Ps).call(this);try{x(this,Fe,Ye(()=>r(s)))}catch(i){this.error(i)}d(this,Ut)>0?G(this,ae,es).call(this):this.is_pending=!1}return()=>{var i;(i=d(this,$t))==null||i.remove()}},su))}defer_effect(e){po(e,d(this,Vn),d(this,Zn))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!d(this,it).pending}update_pending_count(e){G(this,ae,Bs).call(this,e),x(this,dn,d(this,dn)+e),!(!d(this,bt)||d(this,Xn))&&(x(this,Xn,!0),yn(()=>{x(this,Xn,!1),d(this,bt)&&rr(d(this,bt),d(this,dn))}))}get_effect_pending(){return d(this,ds).call(this),m(d(this,bt))}error(e){var t=d(this,it).onerror;let r=d(this,it).failed;if(d(this,vn)||!t&&!r)throw e;d(this,Fe)&&(Se(d(this,Fe)),x(this,Fe,null)),d(this,Te)&&(Se(d(this,Te)),x(this,Te,null)),d(this,ot)&&(Se(d(this,ot)),x(this,ot,null));var s=!1,i=!1;const a=()=>{if(s){Xc();return}s=!0,i&&Pc(),Kt.ensure(),x(this,dn,0),d(this,ot)!==null&&wn(d(this,ot),()=>{x(this,ot,null)}),this.is_pending=this.has_pending_snippet(),x(this,Fe,G(this,ae,Jr).call(this,()=>(x(this,vn,!1),Ye(()=>d(this,fn).call(this,d(this,ze)))))),d(this,Ut)>0?G(this,ae,es).call(this):this.is_pending=!1};yn(()=>{try{i=!0,t==null||t(e,a),i=!1}catch(o){nr(o,d(this,at)&&d(this,at).parent)}r&&x(this,ot,G(this,ae,Jr).call(this,()=>{Kt.ensure(),x(this,vn,!0);try{return Ye(()=>{r(d(this,ze),()=>e,()=>a)})}catch(o){return nr(o,d(this,at).parent),null}finally{x(this,vn,!1)}}))})}}ze=new WeakMap,ii=new WeakMap,it=new WeakMap,fn=new WeakMap,at=new WeakMap,Fe=new WeakMap,Te=new WeakMap,ot=new WeakMap,wt=new WeakMap,$t=new WeakMap,dn=new WeakMap,Ut=new WeakMap,Xn=new WeakMap,vn=new WeakMap,Vn=new WeakMap,Zn=new WeakMap,bt=new WeakMap,ds=new WeakMap,ae=new WeakSet,ou=function(){try{x(this,Fe,Ye(()=>d(this,fn).call(this,d(this,ze))))}catch(e){this.error(e)}},lu=function(){const e=d(this,it).pending;e&&(x(this,Te,Ye(()=>e(d(this,ze)))),yn(()=>{var t=G(this,ae,Ps).call(this);x(this,Fe,G(this,ae,Jr).call(this,()=>(Kt.ensure(),Ye(()=>d(this,fn).call(this,t))))),d(this,Ut)>0?G(this,ae,es).call(this):(wn(d(this,Te),()=>{x(this,Te,null)}),this.is_pending=!1)}))},Ps=function(){var e=d(this,ze);return this.is_pending&&(x(this,$t,Gt()),d(this,ze).before(d(this,$t)),e=d(this,$t)),e},Jr=function(e){var t=B,r=z,s=X;ht(d(this,at)),He(d(this,at)),tr(d(this,at).ctx);try{return e()}catch(i){return fo(i),null}finally{ht(t),He(r),tr(s)}},es=function(){const e=d(this,it).pending;d(this,Fe)!==null&&(x(this,wt,document.createDocumentFragment()),d(this,wt).append(d(this,$t)),Uo(d(this,Fe),d(this,wt))),d(this,Te)===null&&x(this,Te,Ye(()=>e(d(this,ze))))},Bs=function(e){var t;if(!this.has_pending_snippet()){this.parent&&G(t=this.parent,ae,Bs).call(t,e);return}if(x(this,Ut,d(this,Ut)+e),d(this,Ut)===0){this.is_pending=!1;for(const r of d(this,Vn))te(r,we),_t(r);for(const r of d(this,Zn))te(r,Dt),_t(r);d(this,Vn).clear(),d(this,Zn).clear(),d(this,Te)&&wn(d(this,Te),()=>{x(this,Te,null)}),d(this,wt)&&(d(this,ze).before(d(this,wt)),x(this,wt,null))}};function cu(n,e,t,r){const s=$r()?di:vi;var i=n.filter(f=>!f.settled);if(t.length===0&&i.length===0){r(e.map(s));return}var a=$,o=B,l=uu(),c=i.length===1?i[0].promise:i.length>1?Promise.all(i.map(f=>f.promise)):null;function u(f){l();try{r(f)}catch(p){o.f&kt||nr(p,o)}a==null||a.deactivate(),js()}if(t.length===0){c.then(()=>u(e.map(s)));return}function h(){l(),Promise.all(t.map(f=>hu(f))).then(f=>u([...e.map(s),...f])).catch(f=>nr(f,o))}c?c.then(h):h()}function uu(){var n=B,e=z,t=X,r=$;return function(i=!0){ht(n),He(e),tr(t),i&&(r==null||r.activate())}}function js(){ht(null),He(null),tr(null)}function di(n){var e=he|we,t=z!==null&&z.f&he?z:null;return B!==null&&(B.f|=ar),{ctx:X,deps:null,effects:null,equals:lo,f:e,fn:n,reactions:null,rv:0,v:le,wv:0,parent:t??B,ac:null}}function hu(n,e,t){let r=B;r===null&&Mc();var s=r.b,i=void 0,a=Sn(le),o=!z,l=new Map;return Tu(()=>{var p;var c=ro();i=c.promise;try{Promise.resolve(n()).then(c.resolve,c.reject).then(()=>{u===$&&u.committed&&u.deactivate(),js()})}catch(v){c.reject(v),js()}var u=$;if(o){var h=s.is_rendered();s.update_pending_count(1),u.increment(h),(p=l.get(u))==null||p.reject(zn),l.delete(u),l.set(u,c)}const f=(v,g=void 0)=>{if(u.activate(),g)g!==zn&&(a.f|=Wt,rr(a,g));else{a.f&Wt&&(a.f^=Wt),rr(a,v);for(const[w,T]of l){if(l.delete(w),w===u)break;T.reject(zn)}}o&&(s.update_pending_count(-1),u.decrement(h))};c.promise.then(f,v=>f(null,v||"unknown"))}),yi(()=>{for(const c of l.values())c.reject(zn)}),new Promise(c=>{function u(h){function f(){h===i?c(a):u(i)}h.then(f,f)}u(i)})}function vi(n){const e=di(n);return e.equals=uo,e}function To(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)Se(e[t])}}function fu(n){for(var e=n.parent;e!==null;){if(!(e.f&he))return e.f&kt?null:e;e=e.parent}return null}function pi(n){var e,t=B;ht(fu(n));try{n.f&=~kn,To(n),e=Po(n)}finally{ht(t)}return e}function ko(n){var e=pi(n);if(!n.equals(e)&&(n.wv=Fo(),(!($!=null&&$.is_fork)||n.deps===null)&&(n.v=e,n.deps===null))){te(n,ie);return}Xt||(ue!==null?(mi()||$!=null&&$.is_fork)&&ue.set(n,e):fi(n))}let Hs=new Set;const qt=new Map;let So=!1;function Sn(n,e){var t={f:0,v:n,reactions:null,equals:lo,rv:0,wv:0};return t}function Nt(n,e){const t=Sn(n);return _u(t),t}function ce(n,e=!1,t=!0){var s;const r=Sn(n);return e||(r.equals=uo),or&&t&&X!==null&&X.l!==null&&((s=X.l).s??(s.s=[])).push(r),r}function R(n,e,t=!1){z!==null&&(!Ge||z.f&qi)&&$r()&&z.f&(he|Et|ci|qi)&&(je===null||!Jn.call(je,n))&&Yc();let r=t?Fn(e):e;return rr(n,r)}function rr(n,e){if(!n.equals(e)){var t=n.v;Xt?qt.set(n,e):qt.set(n,t),n.v=e;var r=Kt.ensure();if(r.capture(n,t),n.f&he){const s=n;n.f&we&&pi(s),fi(s)}n.wv=Fo(),_o(n,we),$r()&&B!==null&&B.f&ie&&!(B.f&(Qe|Dn))&&(Ue===null?Eu([n]):Ue.push(n)),!r.is_fork&&Hs.size>0&&!So&&du()}return e}function du(){So=!1;for(const n of Hs)n.f&ie&&te(n,Dt),zr(n)&&Ar(n);Hs.clear()}function Er(n){R(n,n.v+1)}function _o(n,e){var t=n.reactions;if(t!==null)for(var r=$r(),s=t.length,i=0;i<s;i++){var a=t[i],o=a.f;if(!(!r&&a===B)){var l=(o&we)===0;if(l&&te(a,e),o&he){var c=a;ue==null||ue.delete(c),o&kn||(o&Be&&(a.f|=kn),_o(c,Dt))}else l&&(o&Et&&We!==null&&We.add(a),_t(a))}}}function Fn(n){if(typeof n!="object"||n===null||Hn in n)return n;const e=ai(n);if(e!==xc&&e!==Ac)return n;var t=new Map,r=eo(n),s=Nt(0),i=bn,a=o=>{if(bn===i)return o();var l=z,c=bn;He(null),Zi(i);var u=o();return He(l),Zi(c),u};return r&&t.set("length",Nt(n.length)),new Proxy(n,{defineProperty(o,l,c){(!("value"in c)||c.configurable===!1||c.enumerable===!1||c.writable===!1)&&zc();var u=t.get(l);return u===void 0?u=a(()=>{var h=Nt(c.value);return t.set(l,h),h}):R(u,c.value,!0),!0},deleteProperty(o,l){var c=t.get(l);if(c===void 0){if(l in o){const u=a(()=>Nt(le));t.set(l,u),Er(s)}}else R(c,le),Er(s);return!0},get(o,l,c){var p;if(l===Hn)return n;var u=t.get(l),h=l in o;if(u===void 0&&(!h||(p=jn(o,l))!=null&&p.writable)&&(u=a(()=>{var v=Fn(h?o[l]:le),g=Nt(v);return g}),t.set(l,u)),u!==void 0){var f=m(u);return f===le?void 0:f}return Reflect.get(o,l,c)},getOwnPropertyDescriptor(o,l){var c=Reflect.getOwnPropertyDescriptor(o,l);if(c&&"value"in c){var u=t.get(l);u&&(c.value=m(u))}else if(c===void 0){var h=t.get(l),f=h==null?void 0:h.v;if(h!==void 0&&f!==le)return{enumerable:!0,configurable:!0,value:f,writable:!0}}return c},has(o,l){var f;if(l===Hn)return!0;var c=t.get(l),u=c!==void 0&&c.v!==le||Reflect.has(o,l);if(c!==void 0||B!==null&&(!u||(f=jn(o,l))!=null&&f.writable)){c===void 0&&(c=a(()=>{var p=u?Fn(o[l]):le,v=Nt(p);return v}),t.set(l,c));var h=m(c);if(h===le)return!1}return u},set(o,l,c,u){var D;var h=t.get(l),f=l in o;if(r&&l==="length")for(var p=c;p<h.v;p+=1){var v=t.get(p+"");v!==void 0?R(v,le):p in o&&(v=a(()=>Nt(le)),t.set(p+"",v))}if(h===void 0)(!f||(D=jn(o,l))!=null&&D.writable)&&(h=a(()=>Nt(void 0)),R(h,Fn(c)),t.set(l,h));else{f=h.v!==le;var g=a(()=>Fn(c));R(h,g)}var w=Reflect.getOwnPropertyDescriptor(o,l);if(w!=null&&w.set&&w.set.call(u,c),!f){if(r&&typeof l=="string"){var T=t.get("length"),I=Number(l);Number.isInteger(I)&&I>=T.v&&R(T,I+1)}Er(s)}return!0},ownKeys(o){m(s);var l=Reflect.ownKeys(o).filter(h=>{var f=t.get(h);return f===void 0||f.v!==le});for(var[c,u]of t)u.v!==le&&!(c in o)&&l.push(c);return l},setPrototypeOf(){Fc()}})}var Qi,Eo,Do,xo;function vu(){if(Qi===void 0){Qi=window,Eo=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype,t=Text.prototype;Do=jn(e,"firstChild").get,xo=jn(e,"nextSibling").get,Ki(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),Ki(t)&&(t.__t=void 0)}}function Gt(n=""){return document.createTextNode(n)}function gi(n){return Do.call(n)}function Ur(n){return xo.call(n)}function b(n,e){return gi(n)}function Qr(n,e=!1){{var t=gi(n);return t instanceof Comment&&t.data===""?Ur(t):t}}function _(n,e=1,t=!1){let r=n;for(;e--;)r=Ur(r);return r}function pu(n){n.textContent=""}function Ao(){return!1}let Xi=!1;function gu(){Xi||(Xi=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{var e;if(!n.defaultPrevented)for(const t of n.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function ms(n){var e=z,t=B;He(null),ht(null);try{return n()}finally{He(e),ht(t)}}function mu(n,e,t,r=t){n.addEventListener(e,()=>ms(t));const s=n.__on_r;s?n.__on_r=()=>{s(),r(!0)}:n.__on_r=()=>r(!0),gu()}function Ro(n){B===null&&(z===null&&Lc(),Nc()),Xt&&Cc()}function yu(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function xt(n,e,t){var r=B;r!==null&&r.f&Oe&&(n|=Oe);var s={ctx:X,deps:null,nodes:null,f:n|we|Be,first:null,fn:e,last:null,next:null,parent:r,b:r&&r.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{Ar(s),s.f|=li}catch(o){throw Se(s),o}else e!==null&&_t(s);var i=s;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&!(i.f&ar)&&(i=i.first,n&Et&&n&er&&i!==null&&(i.f|=er)),i!==null&&(i.parent=r,r!==null&&yu(i,r),z!==null&&z.f&he&&!(n&Dn))){var a=z;(a.effects??(a.effects=[])).push(i)}return s}function mi(){return z!==null&&!Ge}function yi(n){const e=xt(Lr,null,!1);return te(e,ie),e.teardown=n,e}function Ws(n){Ro();var e=B.f,t=!z&&(e&Qe)!==0&&(e&li)===0;if(t){var r=X;(r.e??(r.e=[])).push(n)}else return Io(n)}function Io(n){return xt(Ls|ao,n,!1)}function wu(n){return Ro(),xt(Lr|ao,n,!0)}function bu(n){Kt.ensure();const e=xt(Dn|ar,n,!0);return(t={})=>new Promise(r=>{t.outro?wn(e,()=>{Se(e),r(void 0)}):(Se(e),r(void 0))})}function Tu(n){return xt(ci|ar,n,!0)}function Oo(n,e=0){return xt(Lr|e,n,!0)}function Pt(n,e=[],t=[],r=[]){cu(r,e,t,s=>{xt(Lr,()=>n(...s.map(m)),!0)})}function wi(n,e=0){var t=xt(Et|e,n,!0);return t}function Ye(n){return xt(Qe|ar,n,!0)}function Mo(n){var e=n.teardown;if(e!==null){const t=Xt,r=z;Vi(!0),He(null);try{e.call(null)}finally{Vi(t),He(r)}}}function Co(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){const s=t.ac;s!==null&&ms(()=>{s.abort(zn)});var r=t.next;t.f&Dn?t.parent=null:Se(t,e),t=r}}function ku(n){for(var e=n.first;e!==null;){var t=e.next;e.f&Qe||Se(e),e=t}}function Se(n,e=!0){var t=!1;(e||n.f&io)&&n.nodes!==null&&n.nodes.end!==null&&(Su(n.nodes.start,n.nodes.end),t=!0),Co(n,e&&!t),is(n,0),te(n,kt);var r=n.nodes&&n.nodes.t;if(r!==null)for(const i of r)i.stop();Mo(n);var s=n.parent;s!==null&&s.first!==null&&No(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function Su(n,e){for(;n!==null;){var t=n===e?null:Ur(n);n.remove(),n=t}}function No(n){var e=n.parent,t=n.prev,r=n.next;t!==null&&(t.next=r),r!==null&&(r.prev=t),e!==null&&(e.first===n&&(e.first=r),e.last===n&&(e.last=t))}function wn(n,e,t=!0){var r=[];Lo(n,r,!0);var s=()=>{t&&Se(n),e&&e()},i=r.length;if(i>0){var a=()=>--i||s();for(var o of r)o.out(a)}else s()}function Lo(n,e,t){if(!(n.f&Oe)){n.f^=Oe;var r=n.nodes&&n.nodes.t;if(r!==null)for(const o of r)(o.is_global||t)&&e.push(o);for(var s=n.first;s!==null;){var i=s.next,a=(s.f&er)!==0||(s.f&Qe)!==0&&(n.f&Et)!==0;Lo(s,e,a?t:!1),s=i}}}function bi(n){$o(n,!0)}function $o(n,e){if(n.f&Oe){n.f^=Oe,n.f&ie||(te(n,we),_t(n));for(var t=n.first;t!==null;){var r=t.next,s=(t.f&er)!==0||(t.f&Qe)!==0;$o(t,s?e:!1),t=r}var i=n.nodes&&n.nodes.t;if(i!==null)for(const a of i)(a.is_global||e)&&a.in()}}function Uo(n,e){if(n.nodes)for(var t=n.nodes.start,r=n.nodes.end;t!==null;){var s=t===r?null:Ur(t);e.append(t),t=s}}let ts=!1,Xt=!1;function Vi(n){Xt=n}let z=null,Ge=!1;function He(n){z=n}let B=null;function ht(n){B=n}let je=null;function _u(n){z!==null&&(je===null?je=[n]:je.push(n))}let ke=null,xe=0,Ue=null;function Eu(n){Ue=n}let zo=1,ln=0,bn=ln;function Zi(n){bn=n}function Fo(){return++zo}function zr(n){var e=n.f;if(e&we)return!0;if(e&he&&(n.f&=~kn),e&Dt){for(var t=n.deps,r=t.length,s=0;s<r;s++){var i=t[s];if(zr(i)&&ko(i),i.wv>n.wv)return!0}e&Be&&ue===null&&te(n,ie)}return!1}function Yo(n,e,t=!0){var r=n.reactions;if(r!==null&&!(je!==null&&Jn.call(je,n)))for(var s=0;s<r.length;s++){var i=r[s];i.f&he?Yo(i,e,!1):e===i&&(t?te(i,we):i.f&ie&&te(i,Dt),_t(i))}}function Po(n){var g;var e=ke,t=xe,r=Ue,s=z,i=je,a=X,o=Ge,l=bn,c=n.f;ke=null,xe=0,Ue=null,z=c&(Qe|Dn)?null:n,je=null,tr(n.ctx),Ge=!1,bn=++ln,n.ac!==null&&(ms(()=>{n.ac.abort(zn)}),n.ac=null);try{n.f|=$s;var u=n.fn,h=u(),f=n.deps,p=$==null?void 0:$.is_fork;if(ke!==null){var v;if(p||is(n,xe),f!==null&&xe>0)for(f.length=xe+ke.length,v=0;v<ke.length;v++)f[xe+v]=ke[v];else n.deps=f=ke;if(mi()&&n.f&Be)for(v=xe;v<f.length;v++)((g=f[v]).reactions??(g.reactions=[])).push(n)}else!p&&f!==null&&xe<f.length&&(is(n,xe),f.length=xe);if($r()&&Ue!==null&&!Ge&&f!==null&&!(n.f&(he|Dt|we)))for(v=0;v<Ue.length;v++)Yo(Ue[v],n);if(s!==null&&s!==n){if(ln++,s.deps!==null)for(let w=0;w<t;w+=1)s.deps[w].rv=ln;if(e!==null)for(const w of e)w.rv=ln;Ue!==null&&(r===null?r=Ue:r.push(...Ue))}return n.f&Wt&&(n.f^=Wt),h}catch(w){return fo(w)}finally{n.f^=$s,ke=e,xe=t,Ue=r,z=s,je=i,tr(a),Ge=o,bn=l}}function Du(n,e){let t=e.reactions;if(t!==null){var r=Dc.call(t,n);if(r!==-1){var s=t.length-1;s===0?t=e.reactions=null:(t[r]=t[s],t.pop())}}if(t===null&&e.f&he&&(ke===null||!Jn.call(ke,e))){var i=e;i.f&Be&&(i.f^=Be,i.f&=~kn),fi(i),To(i),is(i,0)}}function is(n,e){var t=n.deps;if(t!==null)for(var r=e;r<t.length;r++)Du(n,t[r])}function Ar(n){var e=n.f;if(!(e&kt)){te(n,ie);var t=B,r=ts;B=n,ts=!0;try{e&(Et|so)?ku(n):Co(n),Mo(n);var s=Po(n);n.teardown=typeof s=="function"?s:null,n.wv=zo;var i;Ns&&Vc&&n.f&we&&n.deps}finally{ts=r,B=t}}}async function xu(){await Promise.resolve(),tu()}function m(n){var e=n.f,t=(e&he)!==0;if(z!==null&&!Ge){var r=B!==null&&(B.f&kt)!==0;if(!r&&(je===null||!Jn.call(je,n))){var s=z.deps;if(z.f&$s)n.rv<ln&&(n.rv=ln,ke===null&&s!==null&&s[xe]===n?xe++:ke===null?ke=[n]:ke.push(n));else{(z.deps??(z.deps=[])).push(n);var i=n.reactions;i===null?n.reactions=[z]:Jn.call(i,z)||i.push(z)}}}if(Xt&&qt.has(n))return qt.get(n);if(t){var a=n;if(Xt){var o=a.v;return(!(a.f&ie)&&a.reactions!==null||jo(a))&&(o=pi(a)),qt.set(a,o),o}var l=(a.f&Be)===0&&!Ge&&z!==null&&(ts||(z.f&Be)!==0),c=a.deps===null;zr(a)&&(l&&(a.f|=Be),ko(a)),l&&!c&&Bo(a)}if(ue!=null&&ue.has(n))return ue.get(n);if(n.f&Wt)throw n.v;return n.v}function Bo(n){if(n.deps!==null){n.f|=Be;for(const e of n.deps)(e.reactions??(e.reactions=[])).push(n),e.f&he&&!(e.f&Be)&&Bo(e)}}function jo(n){if(n.v===le)return!0;if(n.deps===null)return!1;for(const e of n.deps)if(qt.has(e)||e.f&he&&jo(e))return!0;return!1}function E(n){var e=Ge;try{return Ge=!0,n()}finally{Ge=e}}function Au(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(Hn in n)Ks(n);else if(!Array.isArray(n))for(let e in n){const t=n[e];typeof t=="object"&&t&&Hn in t&&Ks(t)}}}function Ks(n,e=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!e.has(n)){e.add(n),n instanceof Date&&n.getTime();for(let r in n)try{Ks(n[r],e)}catch{}const t=ai(n);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const r=no(t);for(let s in r){const i=r[s].get;if(i)try{i.call(n)}catch{}}}}}const Ru=["touchstart","touchmove"];function Iu(n){return Ru.includes(n)}const Ou=new Set,Ji=new Set;function Mu(n,e,t,r={}){function s(i){if(r.capture||yr.call(e,i),!i.cancelBubble)return ms(()=>t==null?void 0:t.call(this,i))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?yn(()=>{e.addEventListener(n,s,r)}):e.addEventListener(n,s,r),s}function Le(n,e,t,r,s){var i={capture:r,passive:s},a=Mu(n,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&yi(()=>{e.removeEventListener(n,a,i)})}let ea=null;function yr(n){var w;var e=this,t=e.ownerDocument,r=n.type,s=((w=n.composedPath)==null?void 0:w.call(n))||[],i=s[0]||n.target;ea=n;var a=0,o=ea===n&&n.__root;if(o){var l=s.indexOf(o);if(l!==-1&&(e===document||e===window)){n.__root=e;return}var c=s.indexOf(e);if(c===-1)return;l<=c&&(a=l)}if(i=s[a]||n.target,i!==e){to(n,"currentTarget",{configurable:!0,get(){return i||t}});var u=z,h=B;He(null),ht(null);try{for(var f,p=[];i!==null;){var v=i.assignedSlot||i.parentNode||i.host||null;try{var g=i["__"+r];g!=null&&(!i.disabled||n.target===i)&&g.call(i,n)}catch(T){f?p.push(T):f=T}if(n.cancelBubble||v===e||v===null)break;i=v}if(f){for(let T of p)queueMicrotask(()=>{throw T});throw f}}finally{n.__root=e,delete n.currentTarget,He(u),ht(h)}}}function Cu(n){var e=document.createElement("template");return e.innerHTML=n.replaceAll("<!>","<!---->"),e.content}function Ho(n,e){var t=B;t.nodes===null&&(t.nodes={start:n,end:e,a:null,t:null})}function _e(n,e){var t=(e&Gc)!==0,r,s=!n.startsWith("<!>");return()=>{r===void 0&&(r=Cu(s?n:"<!>"+n),r=gi(r));var i=t||Eo?document.importNode(r,!0):r.cloneNode(!0);return Ho(i,i),i}}function Xr(){var n=document.createDocumentFragment(),e=document.createComment(""),t=Gt();return n.append(e,t),Ho(e,t),n}function re(n,e){n!==null&&n.before(e)}function C(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=t,n.nodeValue=t+"")}function Nu(n,e){return Lu(n,e)}const Ln=new Map;function Lu(n,{target:e,anchor:t,props:r={},events:s,context:i,intro:a=!0}){vu();var o=new Set,l=h=>{for(var f=0;f<h.length;f++){var p=h[f];if(!o.has(p)){o.add(p);var v=Iu(p);e.addEventListener(p,yr,{passive:v});var g=Ln.get(p);g===void 0?(document.addEventListener(p,yr,{passive:v}),Ln.set(p,1)):Ln.set(p,g+1)}}};l(ps(Ou)),Ji.add(l);var c=void 0,u=bu(()=>{var h=t??e.appendChild(Gt());return iu(h,{pending:()=>{}},f=>{if(i){ui({});var p=X;p.c=i}s&&(r.$$events=s),c=n(f,r)||{},i&&hi()}),()=>{var v;for(var f of o){e.removeEventListener(f,yr);var p=Ln.get(f);--p===0?(document.removeEventListener(f,yr),Ln.delete(f)):Ln.set(f,p)}Ji.delete(l),h!==t&&((v=h.parentNode)==null||v.removeChild(h))}});return qs.set(c,u),c}let qs=new WeakMap;function $u(n,e){const t=qs.get(n);return t?(qs.delete(n),t(e)):Promise.resolve()}var Ke,lt,Ae,pn,Mr,Cr,vs;class Uu{constructor(e,t=!0){y(this,"anchor");O(this,Ke,new Map);O(this,lt,new Map);O(this,Ae,new Map);O(this,pn,new Set);O(this,Mr,!0);O(this,Cr,()=>{var e=$;if(d(this,Ke).has(e)){var t=d(this,Ke).get(e),r=d(this,lt).get(t);if(r)bi(r),d(this,pn).delete(t);else{var s=d(this,Ae).get(t);s&&(d(this,lt).set(t,s.effect),d(this,Ae).delete(t),s.fragment.lastChild.remove(),this.anchor.before(s.fragment),r=s.effect)}for(const[i,a]of d(this,Ke)){if(d(this,Ke).delete(i),i===e)break;const o=d(this,Ae).get(a);o&&(Se(o.effect),d(this,Ae).delete(a))}for(const[i,a]of d(this,lt)){if(i===t||d(this,pn).has(i))continue;const o=()=>{if(Array.from(d(this,Ke).values()).includes(i)){var c=document.createDocumentFragment();Uo(a,c),c.append(Gt()),d(this,Ae).set(i,{effect:a,fragment:c})}else Se(a);d(this,pn).delete(i),d(this,lt).delete(i)};d(this,Mr)||!r?(d(this,pn).add(i),wn(a,o,!1)):o()}}});O(this,vs,e=>{d(this,Ke).delete(e);const t=Array.from(d(this,Ke).values());for(const[r,s]of d(this,Ae))t.includes(r)||(Se(s.effect),d(this,Ae).delete(r))});this.anchor=e,x(this,Mr,t)}ensure(e,t){var r=$,s=Ao();if(t&&!d(this,lt).has(e)&&!d(this,Ae).has(e))if(s){var i=document.createDocumentFragment(),a=Gt();i.append(a),d(this,Ae).set(e,{effect:Ye(()=>t(a)),fragment:i})}else d(this,lt).set(e,Ye(()=>t(this.anchor)));if(d(this,Ke).set(r,e),s){for(const[o,l]of d(this,lt))o===e?r.skipped_effects.delete(l):r.skipped_effects.add(l);for(const[o,l]of d(this,Ae))o===e?r.skipped_effects.delete(l.effect):r.skipped_effects.add(l.effect);r.oncommit(d(this,Cr)),r.ondiscard(d(this,vs))}else d(this,Cr).call(this)}}Ke=new WeakMap,lt=new WeakMap,Ae=new WeakMap,pn=new WeakMap,Mr=new WeakMap,Cr=new WeakMap,vs=new WeakMap;function rt(n,e,t=!1){var r=new Uu(n),s=t?er:0;function i(a,o){r.ensure(a,o)}wi(()=>{var a=!1;e((o,l=!0)=>{a=!0,i(l,o)}),a||i(!1,null)},s)}function zu(n,e,t){for(var r=[],s=e.length,i,a=e.length,o=0;o<s;o++){let h=e[o];wn(h,()=>{if(i){if(i.pending.delete(h),i.done.add(h),i.pending.size===0){var f=n.outrogroups;Gs(ps(i.done)),f.delete(i),f.size===0&&(n.outrogroups=null)}}else a-=1},!1)}if(a===0){var l=r.length===0&&t!==null;if(l){var c=t,u=c.parentNode;pu(u),u.append(c),n.items.clear()}Gs(e,!l)}else i={pending:new Set(e),done:new Set},(n.outrogroups??(n.outrogroups=new Set)).add(i)}function Gs(n,e=!0){for(var t=0;t<n.length;t++)Se(n[t],e)}var ta;function Fu(n,e,t,r,s,i=null){var a=n,o=new Map;{var l=n;a=l.appendChild(Gt())}var c=null,u=vi(()=>{var w=t();return eo(w)?w:w==null?[]:ps(w)}),h,f=!0;function p(){g.fallback=c,Yu(g,h,a,e,r),c!==null&&(h.length===0?c.f&Yt?(c.f^=Yt,wr(c,null,a)):bi(c):wn(c,()=>{c=null}))}var v=wi(()=>{h=m(u);for(var w=h.length,T=new Set,I=$,D=Ao(),N=0;N<w;N+=1){var U=h[N],K=r(U,N),j=f?null:o.get(K);j?(j.v&&rr(j.v,U),j.i&&rr(j.i,N),D&&I.skipped_effects.delete(j.e)):(j=Pu(o,f?a:ta??(ta=Gt()),U,K,N,s,e,t),f||(j.e.f|=Yt),o.set(K,j)),T.add(K)}if(w===0&&i&&!c&&(f?c=Ye(()=>i(a)):(c=Ye(()=>i(ta??(ta=Gt()))),c.f|=Yt)),!f)if(D){for(const[vt,De]of o)T.has(vt)||I.skipped_effects.add(De.e);I.oncommit(p),I.ondiscard(()=>{})}else p();m(u)}),g={effect:v,items:o,outrogroups:null,fallback:c};f=!1}function pr(n){for(;n!==null&&!(n.f&Qe);)n=n.next;return n}function Yu(n,e,t,r,s){var vt;var i=e.length,a=n.items,o=pr(n.effect.first),l,c=null,u=[],h=[],f,p,v,g;for(g=0;g<i;g+=1){if(f=e[g],p=s(f,g),v=a.get(p).e,n.outrogroups!==null)for(const De of n.outrogroups)De.pending.delete(v),De.done.delete(v);if(v.f&Yt)if(v.f^=Yt,v===o)wr(v,null,t);else{var w=c?c.next:o;v===n.effect.last&&(n.effect.last=v.prev),v.prev&&(v.prev.next=v.next),v.next&&(v.next.prev=v.prev),Lt(n,c,v),Lt(n,v,w),wr(v,w,t),c=v,u=[],h=[],o=pr(c.next);continue}if(v.f&Oe&&bi(v),v!==o){if(l!==void 0&&l.has(v)){if(u.length<h.length){var T=h[0],I;c=T.prev;var D=u[0],N=u[u.length-1];for(I=0;I<u.length;I+=1)wr(u[I],T,t);for(I=0;I<h.length;I+=1)l.delete(h[I]);Lt(n,D.prev,N.next),Lt(n,c,D),Lt(n,N,T),o=T,c=N,g-=1,u=[],h=[]}else l.delete(v),wr(v,o,t),Lt(n,v.prev,v.next),Lt(n,v,c===null?n.effect.first:c.next),Lt(n,c,v),c=v;continue}for(u=[],h=[];o!==null&&o!==v;)(l??(l=new Set)).add(o),h.push(o),o=pr(o.next);if(o===null)continue}v.f&Yt||u.push(v),c=v,o=pr(v.next)}if(n.outrogroups!==null){for(const De of n.outrogroups)De.pending.size===0&&(Gs(ps(De.done)),(vt=n.outrogroups)==null||vt.delete(De));n.outrogroups.size===0&&(n.outrogroups=null)}if(o!==null||l!==void 0){var U=[];if(l!==void 0)for(v of l)v.f&Oe||U.push(v);for(;o!==null;)!(o.f&Oe)&&o!==n.fallback&&U.push(o),o=pr(o.next);var K=U.length;if(K>0){var j=i===0?t:null;zu(n,U,j)}}}function Pu(n,e,t,r,s,i,a,o){var l=a&Bc?a&Hc?Sn(t):ce(t,!1,!1):null,c=a&jc?Sn(s):null;return{v:l,i:c,e:Ye(()=>(i(e,l??t,c??s,o),()=>{n.delete(r)}))}}function wr(n,e,t){if(n.nodes)for(var r=n.nodes.start,s=n.nodes.end,i=e&&!(e.f&Yt)?e.nodes.start:t;r!==null;){var a=Ur(r);if(i.before(r),r===s)return;r=a}}function Lt(n,e,t){e===null?n.effect.first=t:e.next=t,t===null?n.effect.last=e:t.prev=e}const na=[...` 	
\r\f¬†\v\uFEFF`];function Bu(n,e,t){var r=n==null?"":""+n;if(e&&(r=r?r+" "+e:e),t){for(var s in t)if(t[s])r=r?r+" "+s:s;else if(r.length)for(var i=s.length,a=0;(a=r.indexOf(s,a))>=0;){var o=a+i;(a===0||na.includes(r[a-1]))&&(o===r.length||na.includes(r[o]))?r=(a===0?"":r.substring(0,a))+r.substring(o+1):a=o}}return r===""?null:r}function ju(n,e){return n==null?null:String(n)}function cn(n,e,t,r,s,i){var a=n.__className;if(a!==t||a===void 0){var o=Bu(t,r,i);o==null?n.removeAttribute("class"):n.className=o,n.__className=t}else if(i&&s!==i)for(var l in i){var c=!!i[l];(s==null||c!==!!s[l])&&n.classList.toggle(l,c)}return i}function Ds(n,e,t,r){var s=n.__style;if(s!==e){var i=ju(e);i==null?n.removeAttribute("style"):n.style.cssText=i,n.__style=e}return r}const Hu=Symbol("is custom element"),Wu=Symbol("is html");function gr(n,e,t,r){var s=Ku(n);s[e]!==(s[e]=t)&&(e==="loading"&&(n[Oc]=t),t==null?n.removeAttribute(e):typeof t!="string"&&qu(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function Ku(n){return n.__attributes??(n.__attributes={[Hu]:n.nodeName.includes("-"),[Wu]:n.namespaceURI===Qc})}var ra=new Map;function qu(n){var e=n.getAttribute("is")||n.nodeName,t=ra.get(e);if(t)return t;ra.set(e,t=[]);for(var r,s=n,i=Element.prototype;i!==s;){r=no(s);for(var a in r)r[a].set&&t.push(a);s=ai(s)}return t}function xs(n,e,t=e){var r=new WeakSet;mu(n,"input",async s=>{var i=s?n.defaultValue:n.value;if(i=As(n)?Rs(i):i,t(i),$!==null&&r.add($),await xu(),i!==(i=e())){var a=n.selectionStart,o=n.selectionEnd,l=n.value.length;if(n.value=i??"",o!==null){var c=n.value.length;a===o&&o===l&&c>l?(n.selectionStart=c,n.selectionEnd=c):(n.selectionStart=a,n.selectionEnd=Math.min(o,c))}}}),E(e)==null&&n.value&&(t(As(n)?Rs(n.value):n.value),$!==null&&r.add($)),Oo(()=>{var s=e();if(n===document.activeElement){var i=Us??$;if(r.has(i))return}As(n)&&s===Rs(n.value)||n.type==="date"&&!s&&!n.value||s!==n.value&&(n.value=s??"")})}function As(n){var e=n.type;return e==="number"||e==="range"}function Rs(n){return n===""?null:+n}function Wo(n=!1){const e=X,t=e.l.u;if(!t)return;let r=()=>Au(e.s);if(n){let s=0,i={};const a=di(()=>{let o=!1;const l=e.s;for(const c in l)l[c]!==i[c]&&(i[c]=l[c],o=!0);return o&&s++,s});r=()=>m(a)}t.b.length&&wu(()=>{sa(e,r),ss(t.b)}),Ws(()=>{const s=E(()=>t.m.map(Rc));return()=>{for(const i of s)typeof i=="function"&&i()}}),t.a.length&&Ws(()=>{sa(e,r),ss(t.a)})}function sa(n,e){if(n.l.s)for(const t of n.l.s)m(t);e()}function Ti(n,e,t){if(n==null)return e(void 0),t&&t(void 0),Ht;const r=E(()=>n.subscribe(e,t));return r.unsubscribe?()=>r.unsubscribe():r}const $n=[];function Gu(n,e){return{subscribe:ys(n,e).subscribe}}function ys(n,e=Ht){let t=null;const r=new Set;function s(o){if(co(n,o)&&(n=o,t)){const l=!$n.length;for(const c of r)c[1](),$n.push(c,n);if(l){for(let c=0;c<$n.length;c+=2)$n[c][0]($n[c+1]);$n.length=0}}}function i(o){s(o(n))}function a(o,l=Ht){const c=[o,l];return r.add(c),r.size===1&&(t=e(s,i)||Ht),o(n),()=>{r.delete(c),r.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:a}}function Ee(n,e,t){const r=!Array.isArray(n),s=r?[n]:n;if(!s.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const i=e.length<2;return Gu(t,(a,o)=>{let l=!1;const c=[];let u=0,h=Ht;const f=()=>{if(u)return;h();const v=e(r?c[0]:c,a,o);i?a(v):h=typeof v=="function"?v:Ht},p=s.map((v,g)=>Ti(v,w=>{c[g]=w,u&=~(1<<g),l&&f()},()=>{u|=1<<g}));return l=!0,f(),function(){ss(p),h(),l=!1}})}function Qu(n){let e;return Ti(n,t=>e=t)(),e}let Vr=!1,Qs=Symbol();function Xu(n,e,t){const r=t[e]??(t[e]={store:null,source:ce(void 0),unsubscribe:Ht});if(r.store!==n&&!(Qs in t))if(r.unsubscribe(),r.store=n??null,n==null)r.source.v=void 0,r.unsubscribe=Ht;else{var s=!0;r.unsubscribe=Ti(n,i=>{s?r.source.v=i:R(r.source,i)}),s=!1}return n&&Qs in t?Qu(n):m(r.source)}function Vu(){const n={};function e(){yi(()=>{for(var t in n)n[t].unsubscribe();to(n,Qs,{enumerable:!1,value:!0})})}return[n,e]}function Zu(n){var e=Vr;try{return Vr=!1,[n(),Vr]}finally{Vr=e}}function sn(n,e,t,r){var I;var s=!or||(t&Wc)!==0,i=(t&qc)!==0,a=r,o=!0,l=()=>(o&&(o=!1,a=r),a),c;{var u=Hn in n||Ic in n;c=((I=jn(n,e))==null?void 0:I.set)??(u&&e in n?D=>n[e]=D:void 0)}var h,f=!1;[h,f]=Zu(()=>n[e]),h===void 0&&r!==void 0&&(h=l(),c&&(s&&Uc(),c(h)));var p;if(s?p=()=>{var D=n[e];return D===void 0?l():(o=!0,D)}:p=()=>{var D=n[e];return D!==void 0&&(a=void 0),D===void 0?a:D},s&&!(t&Kc))return p;if(c){var v=n.$$legacy;return function(D,N){return arguments.length>0?((!s||!N||v||f)&&c(N?p():D),D):p()}}var g=!1,w=vi(()=>(g=!1,p()));m(w);var T=B;return function(D,N){if(arguments.length>0){const U=N?m(w):s&&i?Fn(D):D;return R(w,U),g=!0,a!==void 0&&(a=U),D}return Xt&&g||T.f&kt?w.v:m(w)}}function Ko(n){X===null&&oo(),or&&X.l!==null?Ju(X).m.push(n):Ws(()=>{const e=E(n);if(typeof e=="function")return e})}function qo(n){X===null&&oo(),Ko(()=>()=>E(n))}function Ju(n){var e=n.l;return e.u??(e.u={a:[],b:[],m:[]})}const eh="5";var Ja;typeof window<"u"&&((Ja=window.__svelte??(window.__svelte={})).v??(Ja.v=new Set)).add(eh);Zc();function th(n){if(n.length===0)return{totalTasks:0,activeTasks:0,disabledTasks:0,completionRate:0,missRate:0,totalCompletions:0,totalMisses:0,bestCurrentStreak:0,bestOverallStreak:0,overdueCount:0,dueTodayCount:0,dueThisWeekCount:0,averageHealth:0};const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate()),r=new Date(t);r.setDate(r.getDate()+1);const s=new Date(t);s.setDate(s.getDate()+7);let i=0,a=0,o=0,l=0,c=0,u=0,h=0,f=0,p=0,v=0;for(const D of n){D.enabled?i++:a++,o+=D.completionCount||0,l+=D.missCount||0;const N=D.currentStreak||0;N>c&&(c=N);const U=D.bestStreak||0;U>u&&(u=U);const K=Go(D);if(v+=K,D.dueAt){const j=new Date(D.dueAt);j<e&&D.status!=="done"&&h++,j>=t&&j<r&&f++,j>=t&&j<s&&p++}}const g=o+l,w=g>0?o/g*100:0,T=g>0?l/g*100:0,I=n.length>0?v/n.length:0;return{totalTasks:n.length,activeTasks:i,disabledTasks:a,completionRate:Math.round(w*10)/10,missRate:Math.round(T*10)/10,totalCompletions:o,totalMisses:l,bestCurrentStreak:c,bestOverallStreak:u,overdueCount:h,dueTodayCount:f,dueThisWeekCount:p,averageHealth:Math.round(I)}}function Go(n){const e=n.completionCount||0,t=n.missCount||0,r=e+t;if(r===0)return 100;let i=e/r*70;const a=n.currentStreak||0,o=Math.min(30,a*3);return i+=o,Math.round(Math.min(100,i))}function nh(n){let e=0,t=0,r=0;for(const s of n){const i=Go(s);i>=80?e++:i>=50?t++:r++}return{healthy:e,moderate:t,struggling:r}}function Qo(){return{totalTasks:0,activeTasks:0,disabledTasks:0,completionRate:0,missRate:0,totalCompletions:0,totalMisses:0,bestCurrentStreak:0,bestOverallStreak:0,overdueCount:0,dueTodayCount:0,dueThisWeekCount:0,averageHealth:0,healthBreakdown:{healthy:0,moderate:0,struggling:0},lastUpdated:Date.now(),isStale:!1}}const{subscribe:ia,set:aa,update:rh}=ys(Qo()),lr={subscribe:ia,recalculate(n){const e=th(n),t=nh(n);aa({...e,healthBreakdown:t,lastUpdated:Date.now(),isStale:!1})},markStale(){rh(n=>({...n,isStale:!0}))},reset(){aa(Qo())},getSnapshot(){let n;return ia(e=>{n=e})(),n}},sh=ys(!1),ih=Ee(lr,n=>`${n.completionRate.toFixed(1)}%`),ah=Ee(lr,n=>`${n.missRate.toFixed(1)}%`),oh=Ee(lr,n=>{const{healthy:e,moderate:t,struggling:r}=n.healthBreakdown;return`‚úÖ ${e} | ‚ö†Ô∏è ${t} | üî¥ ${r}`}),lh=Ee(lr,n=>{const e=n.averageHealth;return e>=90?"excellent":e>=70?"good":e>=50?"fair":"poor"}),ch=Ee(lr,n=>{const e=n.bestCurrentStreak;return e>=30?"üî•üî•üî•":e>=10?"üî•üî•":e>=3?"üî•":"‚ú®"}),uh={year:"numeric",month:"short",day:"numeric"},hh={hour:"2-digit",minute:"2-digit"},fh={style:"decimal",maximumFractionDigits:2},oa={locale:"en-US",fallbackLocale:"en-US",messages:{},dateFormat:uh,timeFormat:hh,numberFormat:fh};function dh(){const{subscribe:n,set:e,update:t}=ys(oa);return{subscribe:n,init(r,s){t(i=>({...i,messages:r,locale:s||i.locale}))},setLocale(r){t(s=>({...s,locale:r}))},setMessages(r){t(s=>({...s,messages:{...s.messages,...r}}))},setDateFormat(r){t(s=>({...s,dateFormat:r}))},setTimeFormat(r){t(s=>({...s,timeFormat:r}))},setNumberFormat(r){t(s=>({...s,numberFormat:r}))},reset(){e(oa)}}}const At=dh();Ee(At,n=>n.messages);Ee(At,n=>n.locale);const vh=Ee(At,n=>(e,t)=>{const r=e.split(".");let s=n.messages;for(const i of r)if(s&&typeof s=="object"&&i in s)s=s[i];else return e;return typeof s!="string"?e:t?s.replace(/\{(\w+)\}/g,(i,a)=>t[a]!==void 0?String(t[a]):`{${a}}`):s});Ee(At,n=>(e,t)=>{const r=e instanceof Date?e:new Date(e);if(isNaN(r.getTime()))return"";const s=t||n.dateFormat;return new Intl.DateTimeFormat(n.locale,s).format(r)});Ee(At,n=>(e,t)=>{const r=e instanceof Date?e:new Date(e);if(isNaN(r.getTime()))return"";const s=t||n.timeFormat;return new Intl.DateTimeFormat(n.locale,s).format(r)});Ee(At,n=>(e,t,r)=>{const s=e instanceof Date?e:new Date(e);if(isNaN(s.getTime()))return"";const i=t||n.dateFormat,a=r||n.timeFormat,o=new Intl.DateTimeFormat(n.locale,i).format(s),l=new Intl.DateTimeFormat(n.locale,a).format(s);return`${o} ${l}`});Ee(At,n=>(e,t)=>{const r=t||n.numberFormat;return new Intl.NumberFormat(n.locale,r).format(e)});Ee(At,n=>(e,t=0)=>new Intl.NumberFormat(n.locale,{style:"percent",minimumFractionDigits:t,maximumFractionDigits:t}).format(e/100));Ee(At,n=>e=>{const t=e instanceof Date?e:new Date(e);if(isNaN(t.getTime()))return"";const r=new Date,s=t.getTime()-r.getTime(),i=Math.round(s/1e3),a=Math.round(i/60),o=Math.round(a/60),l=Math.round(o/24),c=Math.round(l/7),u=Math.round(l/30),h=Math.round(l/365),f=new Intl.RelativeTimeFormat(n.locale,{numeric:"auto"});return Math.abs(h)>=1?f.format(h,"year"):Math.abs(u)>=1?f.format(u,"month"):Math.abs(c)>=1?f.format(c,"week"):Math.abs(l)>=1?f.format(l,"day"):Math.abs(o)>=1?f.format(o,"hour"):Math.abs(a)>=1?f.format(a,"minute"):f.format(i,"second")});var ph=_e('<span class="stale-indicator svelte-12vg5jz"> </span>'),gh=_e('<div class="loading-state svelte-12vg5jz"><div class="spinner svelte-12vg5jz"></div> <p class="svelte-12vg5jz"> </p></div>'),mh=_e('<div class="tracker-content svelte-12vg5jz"><div class="metrics-grid svelte-12vg5jz"><div><div class="metric-icon svelte-12vg5jz">‚úÖ</div> <div class="metric-value svelte-12vg5jz"> </div> <div class="metric-label svelte-12vg5jz"> </div> <div class="metric-detail svelte-12vg5jz"> </div></div> <div><div class="metric-icon svelte-12vg5jz">‚ùå</div> <div class="metric-value svelte-12vg5jz"> </div> <div class="metric-label svelte-12vg5jz"> </div> <div class="metric-detail svelte-12vg5jz"> </div></div> <div class="metric-card streak-card svelte-12vg5jz"><div class="metric-icon svelte-12vg5jz"> </div> <div class="metric-value svelte-12vg5jz"> </div> <div class="metric-label svelte-12vg5jz"> </div> <div class="metric-detail svelte-12vg5jz"> </div></div> <div><div class="metric-icon svelte-12vg5jz">üí™</div> <div class="metric-value svelte-12vg5jz"> </div> <div class="metric-label svelte-12vg5jz"> </div> <div class="metric-detail svelte-12vg5jz"> </div></div></div> <div class="task-counts svelte-12vg5jz"><h3 class="svelte-12vg5jz"> </h3> <div class="counts-grid svelte-12vg5jz"><div class="count-item svelte-12vg5jz"><span class="count-value svelte-12vg5jz"> </span> <span class="count-label svelte-12vg5jz"> </span></div> <div class="count-item svelte-12vg5jz"><span class="count-value svelte-12vg5jz"> </span> <span class="count-label svelte-12vg5jz"> </span></div> <div class="count-item svelte-12vg5jz"><span class="count-value svelte-12vg5jz"> </span> <span class="count-label svelte-12vg5jz"> </span></div> <div class="count-item overdue-item svelte-12vg5jz"><span class="count-value svelte-12vg5jz"> </span> <span class="count-label svelte-12vg5jz"> </span></div></div></div> <div class="due-dates svelte-12vg5jz"><h3 class="svelte-12vg5jz"> </h3> <div class="due-dates-grid svelte-12vg5jz"><div class="due-item svelte-12vg5jz"><span class="due-icon svelte-12vg5jz">üìÖ</span> <span class="due-count svelte-12vg5jz"> </span> <span class="due-label svelte-12vg5jz"> </span></div> <div class="due-item svelte-12vg5jz"><span class="due-icon svelte-12vg5jz">üìÜ</span> <span class="due-count svelte-12vg5jz"> </span> <span class="due-label svelte-12vg5jz"> </span></div></div></div> <div class="health-breakdown svelte-12vg5jz"><h3 class="svelte-12vg5jz"> </h3> <div class="health-bar svelte-12vg5jz"><div class="health-segment health-segment-excellent svelte-12vg5jz"> </div> <div class="health-segment health-segment-moderate svelte-12vg5jz"> </div> <div class="health-segment health-segment-poor svelte-12vg5jz"> </div></div> <div class="health-legend svelte-12vg5jz"><span class="legend-item svelte-12vg5jz"><span class="legend-color legend-color-excellent svelte-12vg5jz"></span> </span> <span class="legend-item svelte-12vg5jz"><span class="legend-color legend-color-moderate svelte-12vg5jz"></span> </span> <span class="legend-item svelte-12vg5jz"><span class="legend-color legend-color-poor svelte-12vg5jz"></span> </span></div></div> <div class="tracker-footer svelte-12vg5jz"><small class="svelte-12vg5jz"> </small></div></div>'),yh=_e('<div class="tracker-dashboard svelte-12vg5jz"><div class="tracker-header svelte-12vg5jz"><h2 class="svelte-12vg5jz"> </h2> <!> <button class="close-button svelte-12vg5jz">‚úï</button></div> <!></div>');function wh(n,e){ui(e,!1);const t=()=>Xu(vh,"$t",r),[r,s]=Vu();let i=sn(e,"onClose",8,()=>{}),a=ce(),o=ce(!1),l=ce("0%"),c=ce("0%"),u=ce(""),h=ce("good"),f=ce("‚ú®");const p=lr.subscribe(L=>{R(a,L)}),v=sh.subscribe(L=>{R(o,L)}),g=ih.subscribe(L=>{R(l,L)}),w=ah.subscribe(L=>{R(c,L)}),T=oh.subscribe(L=>{R(u,L)}),I=lh.subscribe(L=>{R(h,L)}),D=ch.subscribe(L=>{R(f,L)});qo(()=>{p(),v(),g(),w(),T(),I(),D()});function N(L){switch(L){case"excellent":return"health-excellent";case"good":return"health-good";case"fair":return"health-fair";case"poor":return"health-poor";default:return"health-good"}}function U(L){return L>=80?"rate-excellent":L>=60?"rate-good":"rate-poor"}function K(L){return L<=20?"rate-excellent":L<=40?"rate-good":"rate-poor"}Wo();var j=yh(),vt=b(j),De=b(vt),bs=b(De),ur=_(De,2);{var Fr=L=>{var oe=ph(),pt=b(oe);Pt((gt,It)=>{gr(oe,"title",gt),C(pt,`‚ö†Ô∏è ${It??""}`)},[()=>(t(),E(()=>t()("analytics.recalculate"))),()=>(t(),E(()=>t()("analytics.staleData")))]),re(L,oe)};rt(ur,L=>{m(a),E(()=>m(a).isStale)&&L(Fr)})}var hr=_(ur,2),fr=_(vt,2);{var Yr=L=>{var oe=gh(),pt=_(b(oe),2),gt=b(pt);Pt(It=>C(gt,It),[()=>(t(),E(()=>t()("analytics.calculating")))]),re(L,oe)},dr=L=>{var oe=mh(),pt=b(oe),gt=b(pt),It=_(b(gt),2),Ts=b(It),Pr=_(It,2),M=b(Pr),Q=_(Pr,2),ve=b(Q),Ce=_(gt,2),pe=_(b(Ce),2),Xe=b(pe),Vt=_(pe,2),Ve=b(Vt),Ot=_(Vt,2),Zt=b(Ot),xn=_(Ce,2),Br=b(xn),Mt=b(Br),Ct=_(Br,2),An=b(Ct),Rn=_(Ct,2),In=b(Rn),Ze=_(Rn,2),Je=b(Ze),et=_(xn,2),V=_(b(et),2),Jt=b(V),en=_(V,2),mt=b(en),On=_(en,2),Mn=b(On),tn=_(pt,2),Cn=b(tn),ge=b(Cn),Nn=_(Cn,2),jr=b(Nn),vr=b(jr),Hr=b(vr),ks=_(vr,2),nn=b(ks),tt=_(jr,2),Wr=b(tt),Tl=b(Wr),kl=_(Wr,2),Sl=b(kl),Oi=_(tt,2),Mi=b(Oi),_l=b(Mi),El=_(Mi,2),Dl=b(El),xl=_(Oi,2),Ci=b(xl),Al=b(Ci),Rl=_(Ci,2),Il=b(Rl),Ni=_(tn,2),Li=b(Ni),Ol=b(Li),Ml=_(Li,2),$i=b(Ml),Ui=_(b($i),2),Cl=b(Ui),Nl=_(Ui,2),Ll=b(Nl),$l=_($i,2),zi=_(b($l),2),Ul=b(zi),zl=_(zi,2),Fl=b(zl),Fi=_(Ni,2),Yi=b(Fi),Yl=b(Yi),Pi=_(Yi,2),Kr=b(Pi),Pl=b(Kr),qr=_(Kr,2),Bl=b(qr),Ss=_(qr,2),jl=b(Ss),Hl=_(Pi,2),Bi=b(Hl),Wl=_(b(Bi)),ji=_(Bi,2),Kl=_(b(ji)),ql=_(ji,2),Gl=_(b(ql)),Ql=_(Fi,2),Xl=b(Ql),Vl=b(Xl);Pt((Zl,Jl,ec,tc,nc,rc,sc,ic,ac,oc,lc,cc,uc,hc,fc,dc,vc,pc,gc,mc)=>{cn(gt,1,`metric-card ${Zl??""}`,"svelte-12vg5jz"),C(Ts,m(l)),C(M,Jl),C(ve,`${m(a),E(()=>m(a).totalCompletions)??""} completions`),cn(Ce,1,`metric-card ${ec??""}`,"svelte-12vg5jz"),C(Xe,m(c)),C(Ve,tc),C(Zt,`${m(a),E(()=>m(a).totalMisses)??""} misses`),C(Mt,m(f)),C(An,(m(a),E(()=>m(a).bestCurrentStreak))),C(In,nc),C(Je,`Best: ${m(a),E(()=>m(a).bestOverallStreak)??""} üèÜ`),cn(et,1,`metric-card ${rc??""}`,"svelte-12vg5jz"),C(Jt,(m(a),E(()=>m(a).averageHealth))),C(mt,sc),C(Mn,m(u)),C(ge,ic),C(Hr,(m(a),E(()=>m(a).totalTasks))),C(nn,ac),C(Tl,(m(a),E(()=>m(a).activeTasks))),C(Sl,oc),C(_l,(m(a),E(()=>m(a).disabledTasks))),C(Dl,lc),C(Al,(m(a),E(()=>m(a).overdueCount))),C(Il,cc),C(Ol,uc),C(Cl,(m(a),E(()=>m(a).dueTodayCount))),C(Ll,hc),C(Ul,(m(a),E(()=>m(a).dueThisWeekCount))),C(Fl,fc),C(Yl,dc),Ds(Kr,`width: ${m(a),E(()=>m(a).totalTasks>0?m(a).healthBreakdown.healthy/m(a).totalTasks*100:0)??""}%`),gr(Kr,"title",`${m(a),E(()=>m(a).healthBreakdown.healthy)??""} healthy tasks`),C(Pl,(m(a),E(()=>m(a).healthBreakdown.healthy>0?m(a).healthBreakdown.healthy:""))),Ds(qr,`width: ${m(a),E(()=>m(a).totalTasks>0?m(a).healthBreakdown.moderate/m(a).totalTasks*100:0)??""}%`),gr(qr,"title",`${m(a),E(()=>m(a).healthBreakdown.moderate)??""} moderate tasks`),C(Bl,(m(a),E(()=>m(a).healthBreakdown.moderate>0?m(a).healthBreakdown.moderate:""))),Ds(Ss,`width: ${m(a),E(()=>m(a).totalTasks>0?m(a).healthBreakdown.struggling/m(a).totalTasks*100:0)??""}%`),gr(Ss,"title",`${m(a),E(()=>m(a).healthBreakdown.struggling)??""} struggling tasks`),C(jl,(m(a),E(()=>m(a).healthBreakdown.struggling>0?m(a).healthBreakdown.struggling:""))),C(Wl,` ${vc??""}: ${m(a),E(()=>m(a).healthBreakdown.healthy)??""}`),C(Kl,` ${pc??""}: ${m(a),E(()=>m(a).healthBreakdown.moderate)??""}`),C(Gl,` ${gc??""}: ${m(a),E(()=>m(a).healthBreakdown.struggling)??""}`),C(Vl,`Last updated: ${mc??""}`)},[()=>(m(a),E(()=>U(m(a).completionRate))),()=>(t(),E(()=>t()("analytics.completionRate"))),()=>(m(a),E(()=>K(m(a).missRate))),()=>(t(),E(()=>t()("analytics.missRate"))),()=>(t(),E(()=>t()("analytics.currentStreak"))),()=>(m(h),E(()=>N(m(h)))),()=>(t(),E(()=>t()("analytics.avgHealthScore"))),()=>(t(),E(()=>t()("analytics.taskOverview"))),()=>(t(),E(()=>t()("analytics.totalTasks"))),()=>(t(),E(()=>t()("analytics.activeTasks"))),()=>(t(),E(()=>t()("analytics.disabledTasks"))),()=>(t(),E(()=>t()("analytics.overdueTasks"))),()=>(t(),E(()=>t()("tasks.upcoming"))),()=>(t(),E(()=>t()("tasks.dueToday"))),()=>(t(),E(()=>t()("tasks.dueThisWeek"))),()=>(t(),E(()=>t()("analytics.healthDistribution"))),()=>(t(),E(()=>t()("analytics.healthyRange"))),()=>(t(),E(()=>t()("analytics.moderateRange"))),()=>(t(),E(()=>t()("analytics.strugglingRange"))),()=>(m(a),E(()=>new Date(m(a).lastUpdated).toLocaleString()))]),re(L,oe)};rt(fr,L=>{m(o)?L(Yr):L(dr,!1)})}Pt((L,oe)=>{C(bs,`üìä ${L??""}`),gr(hr,"aria-label",oe)},[()=>(t(),E(()=>t()("analytics.trackerAndAnalytics"))),()=>(t(),E(()=>t()("close")))]),Le("click",hr,function(...L){var oe;(oe=i())==null||oe.apply(this,L)}),re(n,j),hi(),s()}var bh=_e('<div class="rtm-loading svelte-1ia8gc3">Loading tasks...</div>'),Th=_e('<button class="rtm-btn-danger-text svelte-1ia8gc3">Delete</button>'),kh=_e('<div class="rtm-edit-form svelte-1ia8gc3"><h4 class="svelte-1ia8gc3"> </h4> <label class="rtm-field svelte-1ia8gc3"><span class="svelte-1ia8gc3">Name</span> <input type="text" placeholder="Task name" class="svelte-1ia8gc3"/></label> <label class="rtm-field svelte-1ia8gc3"><span class="svelte-1ia8gc3">Due Date</span> <input type="datetime-local" class="svelte-1ia8gc3"/></label> <label class="rtm-field svelte-1ia8gc3"><span class="svelte-1ia8gc3">Description</span> <textarea placeholder="Optional description" rows="3" class="svelte-1ia8gc3"></textarea></label> <div class="rtm-form-actions svelte-1ia8gc3"><button class="rtm-btn-primary svelte-1ia8gc3"> </button> <button class="rtm-btn-secondary svelte-1ia8gc3">Cancel</button> <!></div></div>'),Sh=_e('<div class="rtm-empty-state svelte-1ia8gc3"><p>No recurring tasks yet</p> <button class="rtm-btn-secondary svelte-1ia8gc3">Create your first task</button></div>'),_h=_e('<div class="rtm-task-recurrence svelte-1ia8gc3"> </div>'),Eh=_e('<div><div class="rtm-task-info svelte-1ia8gc3"><div class="rtm-task-name svelte-1ia8gc3"> </div> <div class="rtm-task-due svelte-1ia8gc3"> </div> <!></div> <div class="rtm-task-actions svelte-1ia8gc3"><button class="rtm-btn-icon svelte-1ia8gc3" title="Complete">‚úì</button> <button class="rtm-btn-icon svelte-1ia8gc3" title="Edit">‚úèÔ∏è</button> <button class="rtm-btn-icon rtm-btn-danger svelte-1ia8gc3" title="Delete">üóëÔ∏è</button></div></div>'),Dh=_e('<div class="rtm-task-list svelte-1ia8gc3"></div>'),xh=_e('<div class="rtm-tasks-panel"><div class="rtm-panel-header svelte-1ia8gc3"><h3 class="svelte-1ia8gc3">Recurring Tasks</h3> <button class="rtm-btn-primary svelte-1ia8gc3">+ New Task</button></div> <!></div>'),Ah=_e('<div class="rtm-settings-panel svelte-1ia8gc3"><h3 class="svelte-1ia8gc3">Settings</h3> <p>Settings panel coming soon...</p></div>'),Rh=_e('<div class="rtm-dashboard svelte-1ia8gc3"><div class="rtm-tabs svelte-1ia8gc3"><button>üìã Tasks</button> <button>üìä Tracker</button> <button>‚öôÔ∏è Settings</button></div> <div class="rtm-content svelte-1ia8gc3"><!></div></div>');function Ih(n,e){ui(e,!1);let t=sn(e,"taskStorage",8),r=sn(e,"recurrenceEngine",8,void 0),s=sn(e,"taskScheduler",8,void 0),i=sn(e,"notificationService",8,void 0),a=sn(e,"eventBus",8),o=sn(e,"plugin",8);r(),s(),i(),o();let l=ce([]),c=ce(!0),u=ce("tasks"),h=ce(null),f=ce(!1),p=ce(""),v=ce(""),g=ce(""),w=null,T=null,I=null;Ko(async()=>{await D(),w=a().on("task:refresh",()=>{D()}),T=a().on("task:saved",({task:M,isNew:Q})=>{Q?R(l,[...m(l),M]):R(l,m(l).map(ve=>ve.id===M.id?M:ve)),R(h,null),R(f,!1)}),I=a().on("task:edit",M=>{M.task?(R(h,M.task),R(p,M.task.name),R(v,M.task.dueAt?M.task.dueAt.slice(0,16):""),R(g,M.task.description||"")):(R(f,!0),R(p,""),R(v,""),R(g,""))})}),qo(()=>{w==null||w(),T==null||T(),I==null||I()});async function D(){R(c,!0);try{const M=await t().loadActive();R(l,Array.from(M.values()))}catch(M){console.error("[Dashboard] Failed to load tasks:",M)}finally{R(c,!1)}}function N(){R(f,!0),R(h,null),R(p,""),R(v,""),R(g,"")}function U(M){R(h,M),R(f,!1),R(p,M.name),R(v,M.dueAt?M.dueAt.slice(0,16):""),R(g,M.description||"")}async function K(){try{if(m(f)){const M=new Date().toISOString(),Q={id:crypto.randomUUID?crypto.randomUUID():Date.now().toString(36),name:m(p),dueAt:m(v)?new Date(m(v)).toISOString():M,frequency:{type:"daily",interval:1},enabled:!0,description:m(g)||void 0,createdAt:M,updatedAt:M};await t().saveTask(Q),a().emit("task:saved",{task:Q,isNew:!0})}else if(m(h)){const M={...m(h),name:m(p),dueAt:m(v)?new Date(m(v)).toISOString():m(h).dueAt,description:m(g)||void 0};await t().saveTask(M),a().emit("task:saved",{task:M,isNew:!1})}}catch(M){console.error("[Dashboard] Failed to save task:",M)}}async function j(M){try{await t().deleteTask(M),R(l,m(l).filter(Q=>Q.id!==M))}catch(Q){console.error("[Dashboard] Failed to delete task:",Q)}}async function vt(M){a().emit("task:complete",{taskId:M}),await D()}function De(){R(h,null),R(f,!1),R(p,""),R(v,""),R(g,"")}function bs(M){const Q=new Date(M),ve=new Date,Ce=Q.getTime()-ve.getTime(),pe=Math.floor(Ce/(1e3*60*60*24));return pe<0?`Overdue by ${Math.abs(pe)} day(s)`:pe===0?"Due today":pe===1?"Due tomorrow":`Due in ${pe} days`}function ur(M){const Q=new Date,ve=new Date(M.dueAt),Ce=new Date(Q.getFullYear(),Q.getMonth(),Q.getDate()),pe=new Date(ve.getFullYear(),ve.getMonth(),ve.getDate());return pe<Ce?"overdue":pe.getTime()===Ce.getTime()?"today":"upcoming"}Wo();var Fr=Rh(),hr=b(Fr),fr=b(hr);let Yr;var dr=_(fr,2);let L;var oe=_(dr,2);let pt;var gt=_(hr,2),It=b(gt);{var Ts=M=>{var Q=xh(),ve=b(Q),Ce=_(b(ve),2),pe=_(ve,2);{var Xe=Ve=>{var Ot=bh();re(Ve,Ot)},Vt=Ve=>{var Ot=Xr(),Zt=Qr(Ot);{var xn=Mt=>{var Ct=kh(),An=b(Ct),Rn=b(An),In=_(An,2),Ze=_(b(In),2),Je=_(In,2),et=_(b(Je),2),V=_(Je,2),Jt=_(b(V),2),en=_(V,2),mt=b(en),On=b(mt),Mn=_(mt,2),tn=_(Mn,2);{var Cn=ge=>{var Nn=Th();Le("click",Nn,()=>{m(h)&&j(m(h).id)}),re(ge,Nn)};rt(tn,ge=>{m(h)&&ge(Cn)})}Pt(ge=>{C(Rn,m(f)?"New Task":"Edit Task"),mt.disabled=ge,C(On,m(f)?"Create":"Save")},[()=>(m(p),E(()=>!m(p).trim()))]),xs(Ze,()=>m(p),ge=>R(p,ge)),xs(et,()=>m(v),ge=>R(v,ge)),xs(Jt,()=>m(g),ge=>R(g,ge)),Le("click",mt,K),Le("click",Mn,De),re(Mt,Ct)},Br=Mt=>{var Ct=Xr(),An=Qr(Ct);{var Rn=Ze=>{var Je=Sh(),et=_(b(Je),2);Le("click",et,N),re(Ze,Je)},In=Ze=>{var Je=Dh();Fu(Je,5,()=>m(l),et=>et.id,(et,V)=>{var Jt=Eh();let en;var mt=b(Jt),On=b(mt),Mn=b(On),tn=_(On,2),Cn=b(tn),ge=_(tn,2);{var Nn=nn=>{var tt=_h(),Wr=b(tt);Pt(()=>C(Wr,`üîÑ ${m(V),E(()=>m(V).frequency.naturalLanguage||m(V).frequency.type||"Recurring")??""}`)),re(nn,tt)};rt(ge,nn=>{m(V),E(()=>{var tt;return(tt=m(V).frequency)==null?void 0:tt.rruleString})&&nn(Nn)})}var jr=_(mt,2),vr=b(jr),Hr=_(vr,2),ks=_(Hr,2);Pt((nn,tt)=>{en=cn(Jt,1,"rtm-task-card svelte-1ia8gc3",null,en,nn),C(Mn,(m(V),E(()=>m(V).name))),C(Cn,tt)},[()=>({overdue:ur(m(V))==="overdue",today:ur(m(V))==="today"}),()=>(m(V),E(()=>bs(m(V).dueAt)))]),Le("click",vr,()=>vt(m(V).id)),Le("click",Hr,()=>U(m(V))),Le("click",ks,()=>j(m(V).id)),re(et,Jt)}),re(Ze,Je)};rt(An,Ze=>{m(l),E(()=>m(l).length===0)?Ze(Rn):Ze(In,!1)},!0)}re(Mt,Ct)};rt(Zt,Mt=>{m(f)||m(h)?Mt(xn):Mt(Br,!1)},!0)}re(Ve,Ot)};rt(pe,Ve=>{m(c)?Ve(Xe):Ve(Vt,!1)})}Le("click",Ce,N),re(M,Q)},Pr=M=>{var Q=Xr(),ve=Qr(Q);{var Ce=Xe=>{wh(Xe,{onClose:()=>R(u,"tasks")})},pe=Xe=>{var Vt=Xr(),Ve=Qr(Vt);{var Ot=Zt=>{var xn=Ah();re(Zt,xn)};rt(Ve,Zt=>{m(u)==="settings"&&Zt(Ot)},!0)}re(Xe,Vt)};rt(ve,Xe=>{m(u)==="tracker"?Xe(Ce):Xe(pe,!1)},!0)}re(M,Q)};rt(It,M=>{m(u)==="tasks"?M(Ts):M(Pr,!1)})}Pt(()=>{Yr=cn(fr,1,"rtm-tab svelte-1ia8gc3",null,Yr,{active:m(u)==="tasks"}),L=cn(dr,1,"rtm-tab svelte-1ia8gc3",null,L,{active:m(u)==="tracker"}),pt=cn(oe,1,"rtm-tab svelte-1ia8gc3",null,pt,{active:m(u)==="settings"})}),Le("click",fr,()=>R(u,"tasks")),Le("click",dr,()=>R(u,"tracker")),Le("click",oe,()=>R(u,"settings")),re(n,Fr),hi()}const Yn="recurring-tasks-active",ns="recurring-tasks-archive",la="recurring-tasks",ca="recurring-tasks.json.bak",ua="n8n-event-settings",ha="n8n-event-queue",Oh="notification-state",fa="scheduler-emitted-occurrences",da={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},Xo=60*1e3,Mh=30*1e3,Is=2e3,va="shehab-note-recurring-plugin",pa="1.0.0",Ch=60*60*1e3,Nh=3,ga=10,Xs=100,ma="last-run-timestamp",ya="custom-recurring-task-id",wa="custom-recurring-task-due",ba="custom-recurring-task-enabled",Lh=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function ws(n,e,t){const r={timestamp:new Date().toISOString()},s=`[${n.toUpperCase()}] [${r.timestamp}]`;n==="error"?console.error(s,e,t||""):n==="warn"?console.warn(s,e,t||""):n==="debug"&&Lh?console.debug(s,e,t||""):n==="info"&&console.log(s,e,t||"")}function ki(n,e){ws("debug",n,e)}function F(n,e){ws("info",n,e)}function W(n,e){ws("warn",n,e)}function A(n,e){ws("error",n,e)}function $h(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function nt(n){if(typeof n!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(n))}function Ta(n,e){for(var t="",r=0,s=-1,i=0,a,o=0;o<=n.length;++o){if(o<n.length)a=n.charCodeAt(o);else{if(a===47)break;a=47}if(a===47){if(!(s===o-1||i===1))if(s!==o-1&&i===2){if(t.length<2||r!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){var l=t.lastIndexOf("/");if(l!==t.length-1){l===-1?(t="",r=0):(t=t.slice(0,l),r=t.length-1-t.lastIndexOf("/")),s=o,i=0;continue}}else if(t.length===2||t.length===1){t="",r=0,s=o,i=0;continue}}e&&(t.length>0?t+="/..":t="..",r=2)}else t.length>0?t+="/"+n.slice(s+1,o):t=n.slice(s+1,o),r=o-s-1;s=o,i=0}else a===46&&i!==-1?++i:i=-1}return t}function Uh(n,e){var t=e.dir||e.root,r=e.base||(e.name||"")+(e.ext||"");return t?t===e.root?t+r:t+n+r:r}var Wn={resolve:function(){for(var e="",t=!1,r,s=arguments.length-1;s>=-1&&!t;s--){var i;s>=0?i=arguments[s]:(r===void 0&&(r=process.cwd()),i=r),nt(i),i.length!==0&&(e=i+"/"+e,t=i.charCodeAt(0)===47)}return e=Ta(e,!t),t?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(nt(e),e.length===0)return".";var t=e.charCodeAt(0)===47,r=e.charCodeAt(e.length-1)===47;return e=Ta(e,!t),e.length===0&&!t&&(e="."),e.length>0&&r&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return nt(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var r=arguments[t];nt(r),r.length>0&&(e===void 0?e=r:e+="/"+r)}return e===void 0?".":Wn.normalize(e)},relative:function(e,t){if(nt(e),nt(t),e===t||(e=Wn.resolve(e),t=Wn.resolve(t),e===t))return"";for(var r=1;r<e.length&&e.charCodeAt(r)===47;++r);for(var s=e.length,i=s-r,a=1;a<t.length&&t.charCodeAt(a)===47;++a);for(var o=t.length,l=o-a,c=i<l?i:l,u=-1,h=0;h<=c;++h){if(h===c){if(l>c){if(t.charCodeAt(a+h)===47)return t.slice(a+h+1);if(h===0)return t.slice(a+h)}else i>c&&(e.charCodeAt(r+h)===47?u=h:h===0&&(u=0));break}var f=e.charCodeAt(r+h),p=t.charCodeAt(a+h);if(f!==p)break;f===47&&(u=h)}var v="";for(h=r+u+1;h<=s;++h)(h===s||e.charCodeAt(h)===47)&&(v.length===0?v+="..":v+="/..");return v.length>0?v+t.slice(a+u):(a+=u,t.charCodeAt(a)===47&&++a,t.slice(a))},_makeLong:function(e){return e},dirname:function(e){if(nt(e),e.length===0)return".";for(var t=e.charCodeAt(0),r=t===47,s=-1,i=!0,a=e.length-1;a>=1;--a)if(t=e.charCodeAt(a),t===47){if(!i){s=a;break}}else i=!1;return s===-1?r?"/":".":r&&s===1?"//":e.slice(0,s)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');nt(e);var r=0,s=-1,i=!0,a;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var o=t.length-1,l=-1;for(a=e.length-1;a>=0;--a){var c=e.charCodeAt(a);if(c===47){if(!i){r=a+1;break}}else l===-1&&(i=!1,l=a+1),o>=0&&(c===t.charCodeAt(o)?--o===-1&&(s=a):(o=-1,s=l))}return r===s?s=l:s===-1&&(s=e.length),e.slice(r,s)}else{for(a=e.length-1;a>=0;--a)if(e.charCodeAt(a)===47){if(!i){r=a+1;break}}else s===-1&&(i=!1,s=a+1);return s===-1?"":e.slice(r,s)}},extname:function(e){nt(e);for(var t=-1,r=0,s=-1,i=!0,a=0,o=e.length-1;o>=0;--o){var l=e.charCodeAt(o);if(l===47){if(!i){r=o+1;break}continue}s===-1&&(i=!1,s=o+1),l===46?t===-1?t=o:a!==1&&(a=1):t!==-1&&(a=-1)}return t===-1||s===-1||a===0||a===1&&t===s-1&&t===r+1?"":e.slice(t,s)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return Uh("/",e)},parse:function(e){nt(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var r=e.charCodeAt(0),s=r===47,i;s?(t.root="/",i=1):i=0;for(var a=-1,o=0,l=-1,c=!0,u=e.length-1,h=0;u>=i;--u){if(r=e.charCodeAt(u),r===47){if(!c){o=u+1;break}continue}l===-1&&(c=!1,l=u+1),r===46?a===-1?a=u:h!==1&&(h=1):a!==-1&&(h=-1)}return a===-1||l===-1||h===0||h===1&&a===l-1&&a===o+1?l!==-1&&(o===0&&s?t.base=t.name=e.slice(1,l):t.base=t.name=e.slice(o,l)):(o===0&&s?(t.name=e.slice(1,a),t.base=e.slice(1,l)):(t.name=e.slice(o,a),t.base=e.slice(o,l)),t.ext=e.slice(a,l)),o>0?t.dir=e.slice(0,o-1):s&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};Wn.posix=Wn;var zh=Wn;const ka=$h(zh),Sa=new Set;function br(n){const e=`${n.feature}:${n.capability}:${n.message}`;Sa.has(e)||(Sa.add(e),W(n.message,{feature:n.feature,capability:n.capability,cause:n.cause}))}class Vo extends Error{constructor(t,r,s){super(s);y(this,"capability");y(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=r}}class Zo extends Error{constructor(t,r,s,i){super(s);y(this,"capability");y(this,"feature");y(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=r,this.cause=i}}class Fh{constructor(e=globalThis){y(this,"supportedCapabilities");y(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,r,s;return typeof((s=(r=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:r.system)==null?void 0:s.dataDir)=="string"}getDataDir(){var e,t,r;return this.isDataDirAvailable()?((r=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:r.dataDir)??null:null}async setBlockAttrs(e,t){const r=this.getSetBlockAttrs();try{await r(e,t)}catch(s){throw new Zo("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",s)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new Vo("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Yh=".tmp";class Ph{constructor(e,t){y(this,"plugin");y(this,"apiAdapter");y(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(Yn);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){A("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),F(`Saved ${e.tasks.length} active tasks`)}catch(t){throw A("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(Yn,e);return}const r=this.resolveStoragePath(Yn);if(!r){await this.plugin.saveData(Yn,e);return}const s=ka.dirname(r);await t.mkdir(s,{recursive:!0});const i=`${r}${Yh}`,a=JSON.stringify(e),o=await t.open(i,"w");try{await o.writeFile(a,"utf8"),await o.sync()}finally{await o.close()}try{await t.rename(i,r)}catch{await t.rm(r,{force:!0}),await t.rename(i,r)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await import("fs");return this.fsPromises=e.promises,this.fsPromises}catch(e){return W("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),r=this.plugin.name;return!t||!r?(t||br({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):ka.join(t,"storage",`p${r}`,`${e}.json`)}}const _a=1,Ea=1e3;class Bh{constructor(e){y(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),r=this.groupByYear(e);for(const[s,i]of r.entries())await this.appendTasksToYear(t,s,i);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const r=this.filterChunks(t.chunks,e),s=[];for(const o of r){const l=await this.loadChunk(o.key);if(l)for(const c of l.tasks)this.matchesQuery(c,e)&&s.push(c)}const i=(e==null?void 0:e.offset)??0,a=(e==null?void 0:e.limit)??s.length;return s.slice(i,i+a)}async loadIndex(){try{const e=await this.plugin.loadData(ns);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??_a,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){A("Failed to load archive index",e)}return{version:_a,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(ns,e)}catch(t){throw A("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${ns}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){A("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(r){throw A("Failed to save archive chunk",{key:e,err:r}),r}}groupByYear(e){const t=new Map;for(const r of e){const s=this.getCompletionTimestamp(r),i=new Date(s).getFullYear(),a=t.get(i);a?a.push(r):t.set(i,[r])}return t}async appendTasksToYear(e,t,r){let s=[...r];for(;s.length>0;){const i=this.findOrCreateChunk(e,t),a=await this.loadChunk(i.key)||{tasks:[]},o=Ea-a.tasks.length,l=s.slice(0,o);a.tasks.push(...l),s=s.slice(l.length);const c=this.updateChunkMeta(i,l);i.count=c.count,i.start=c.start,i.end=c.end,await this.saveChunk(i.key,a),e.totalCount+=l.length}}findOrCreateChunk(e,t){const s=e.chunks.filter(o=>o.year===t).sort((o,l)=>o.sequence-l.sequence).at(-1);if(s&&s.count<Ea)return s;const i=s?s.sequence+1:1,a={key:this.buildChunkKey(t,i),year:t,sequence:i,count:0};return e.chunks.push(a),a}updateChunkMeta(e,t){let r=e.start,s=e.end;for(const i of t){const a=this.getCompletionTimestamp(i);(!r||a<r)&&(r=a),(!s||a>s)&&(s=a)}return{...e,count:e.count+t.length,start:r,end:s}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const r=t!=null&&t.from?new Date(t.from).getTime():null,s=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(i=>{const a=i.start?new Date(i.start).getTime():null,o=i.end?new Date(i.end).getTime():null;return!(r&&o&&o<r||s&&a&&a>s)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const r=this.getCompletionTimestamp(e),s=new Date(r).getTime();return!(t.from&&s<new Date(t.from).getTime()||t.to&&s>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class jh{constructor(e,t=50){y(this,"pendingState",null);y(this,"writeInProgress",!1);y(this,"scheduledTimer",null);y(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){A("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return A("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const Jo=(n,e,t)=>{const r=n instanceof RegExp?Da(n,t):n,s=e instanceof RegExp?Da(e,t):e,i=r!==null&&s!=null&&Hh(r,s,t);return i&&{start:i[0],end:i[1],pre:t.slice(0,i[0]),body:t.slice(i[0]+r.length,i[1]),post:t.slice(i[1]+s.length)}},Da=(n,e)=>{const t=e.match(n);return t?t[0]:null},Hh=(n,e,t)=>{let r,s,i,a,o,l=t.indexOf(n),c=t.indexOf(e,l+1),u=l;if(l>=0&&c>0){if(n===e)return[l,c];for(r=[],i=t.length;u>=0&&!o;){if(u===l)r.push(u),l=t.indexOf(n,u+1);else if(r.length===1){const h=r.pop();h!==void 0&&(o=[h,c])}else s=r.pop(),s!==void 0&&s<i&&(i=s,a=c),c=t.indexOf(e,u+1);u=l<c&&l>=0?l:c}r.length&&a!==void 0&&(o=[i,a])}return o},el="\0SLASH"+Math.random()+"\0",tl="\0OPEN"+Math.random()+"\0",Si="\0CLOSE"+Math.random()+"\0",nl="\0COMMA"+Math.random()+"\0",rl="\0PERIOD"+Math.random()+"\0",Wh=new RegExp(el,"g"),Kh=new RegExp(tl,"g"),qh=new RegExp(Si,"g"),Gh=new RegExp(nl,"g"),Qh=new RegExp(rl,"g"),Xh=/\\\\/g,Vh=/\\{/g,Zh=/\\}/g,Jh=/\\,/g,ef=/\\./g,tf=1e5;function Os(n){return isNaN(n)?n.charCodeAt(0):parseInt(n,10)}function nf(n){return n.replace(Xh,el).replace(Vh,tl).replace(Zh,Si).replace(Jh,nl).replace(ef,rl)}function rf(n){return n.replace(Wh,"\\").replace(Kh,"{").replace(qh,"}").replace(Gh,",").replace(Qh,".")}function sl(n){if(!n)return[""];const e=[],t=Jo("{","}",n);if(!t)return n.split(",");const{pre:r,body:s,post:i}=t,a=r.split(",");a[a.length-1]+="{"+s+"}";const o=sl(i);return i.length&&(a[a.length-1]+=o.shift(),a.push.apply(a,o)),e.push.apply(e,a),e}function sf(n,e={}){if(!n)return[];const{max:t=tf}=e;return n.slice(0,2)==="{}"&&(n="\\{\\}"+n.slice(2)),Tr(nf(n),t,!0).map(rf)}function af(n){return"{"+n+"}"}function of(n){return/^-?0\d/.test(n)}function lf(n,e){return n<=e}function cf(n,e){return n>=e}function Tr(n,e,t){const r=[],s=Jo("{","}",n);if(!s)return[n];const i=s.pre,a=s.post.length?Tr(s.post,e,!1):[""];if(/\$$/.test(s.pre))for(let o=0;o<a.length&&o<e;o++){const l=i+"{"+s.body+"}"+a[o];r.push(l)}else{const o=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(s.body),l=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(s.body),c=o||l,u=s.body.indexOf(",")>=0;if(!c&&!u)return s.post.match(/,(?!,).*\}/)?(n=s.pre+"{"+s.body+Si+s.post,Tr(n,e,!0)):[n];let h;if(c)h=s.body.split(/\.\./);else if(h=sl(s.body),h.length===1&&h[0]!==void 0&&(h=Tr(h[0],e,!1).map(af),h.length===1))return a.map(p=>s.pre+h[0]+p);let f;if(c&&h[0]!==void 0&&h[1]!==void 0){const p=Os(h[0]),v=Os(h[1]),g=Math.max(h[0].length,h[1].length);let w=h.length===3&&h[2]!==void 0?Math.abs(Os(h[2])):1,T=lf;v<p&&(w*=-1,T=cf);const D=h.some(of);f=[];for(let N=p;T(N,v);N+=w){let U;if(l)U=String.fromCharCode(N),U==="\\"&&(U="");else if(U=String(N),D){const K=g-U.length;if(K>0){const j=new Array(K+1).join("0");N<0?U="-"+j+U.slice(1):U=j+U}}f.push(U)}}else{f=[];for(let p=0;p<h.length;p++)f.push.apply(f,Tr(h[p],e,!1))}for(let p=0;p<f.length;p++)for(let v=0;v<a.length&&r.length<e;v++){const g=i+f[p]+a[v];(!t||c||g)&&r.push(g)}}return r}const uf=1024*64,as=n=>{if(typeof n!="string")throw new TypeError("invalid pattern");if(n.length>uf)throw new TypeError("pattern is too long")},hf={"[:alnum:]":["\\p{L}\\p{Nl}\\p{Nd}",!0],"[:alpha:]":["\\p{L}\\p{Nl}",!0],"[:ascii:]":["\\x00-\\x7f",!1],"[:blank:]":["\\p{Zs}\\t",!0],"[:cntrl:]":["\\p{Cc}",!0],"[:digit:]":["\\p{Nd}",!0],"[:graph:]":["\\p{Z}\\p{C}",!0,!0],"[:lower:]":["\\p{Ll}",!0],"[:print:]":["\\p{C}",!0],"[:punct:]":["\\p{P}",!0],"[:space:]":["\\p{Z}\\t\\r\\n\\v\\f",!0],"[:upper:]":["\\p{Lu}",!0],"[:word:]":["\\p{L}\\p{Nl}\\p{Nd}\\p{Pc}",!0],"[:xdigit:]":["A-Fa-f0-9",!1]},mr=n=>n.replace(/[[\]\\-]/g,"\\$&"),ff=n=>n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),xa=n=>n.join(""),df=(n,e)=>{const t=e;if(n.charAt(t)!=="[")throw new Error("not in a brace expression");const r=[],s=[];let i=t+1,a=!1,o=!1,l=!1,c=!1,u=t,h="";e:for(;i<n.length;){const g=n.charAt(i);if((g==="!"||g==="^")&&i===t+1){c=!0,i++;continue}if(g==="]"&&a&&!l){u=i+1;break}if(a=!0,g==="\\"&&!l){l=!0,i++;continue}if(g==="["&&!l){for(const[w,[T,I,D]]of Object.entries(hf))if(n.startsWith(w,i)){if(h)return["$.",!1,n.length-t,!0];i+=w.length,D?s.push(T):r.push(T),o=o||I;continue e}}if(l=!1,h){g>h?r.push(mr(h)+"-"+mr(g)):g===h&&r.push(mr(g)),h="",i++;continue}if(n.startsWith("-]",i+1)){r.push(mr(g+"-")),i+=2;continue}if(n.startsWith("-",i+1)){h=g,i+=2;continue}r.push(mr(g)),i++}if(u<i)return["",!1,0,!1];if(!r.length&&!s.length)return["$.",!1,n.length-t,!0];if(s.length===0&&r.length===1&&/^\\?.$/.test(r[0])&&!c){const g=r[0].length===2?r[0].slice(-1):r[0];return[ff(g),!1,u-t,!1]}const f="["+(c?"^":"")+xa(r)+"]",p="["+(c?"":"^")+xa(s)+"]";return[r.length&&s.length?"("+f+"|"+p+")":r.length?f:p,o,u-t,!0]},kr=(n,{windowsPathsNoEscape:e=!1,magicalBraces:t=!0}={})=>t?e?n.replace(/\[([^\/\\])\]/g,"$1"):n.replace(/((?!\\).|^)\[([^\/\\])\]/g,"$1$2").replace(/\\([^\/])/g,"$1"):e?n.replace(/\[([^\/\\{}])\]/g,"$1"):n.replace(/((?!\\).|^)\[([^\/\\{}])\]/g,"$1$2").replace(/\\([^\/{}])/g,"$1"),vf=new Set(["!","?","+","*","@"]),Aa=n=>vf.has(n),pf="(?!(?:^|/)\\.\\.?(?:$|/))",Zr="(?!\\.)",gf=new Set(["[","."]),mf=new Set(["..","."]),yf=new Set("().*{}+?[]^$\\!"),wf=n=>n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),_i="[^/]",Ra=_i+"*?",Ia=_i+"+?";var ee,ne,Tt,q,Z,zt,gn,Ft,ct,mn,Nr,En,il,Qt,rs,Vs,al;const me=class me{constructor(e,t,r={}){O(this,En);y(this,"type");O(this,ee);O(this,ne);O(this,Tt,!1);O(this,q,[]);O(this,Z);O(this,zt);O(this,gn);O(this,Ft,!1);O(this,ct);O(this,mn);O(this,Nr,!1);this.type=e,e&&x(this,ne,!0),x(this,Z,t),x(this,ee,d(this,Z)?d(d(this,Z),ee):this),x(this,ct,d(this,ee)===this?r:d(d(this,ee),ct)),x(this,gn,d(this,ee)===this?[]:d(d(this,ee),gn)),e==="!"&&!d(d(this,ee),Ft)&&d(this,gn).push(this),x(this,zt,d(this,Z)?d(d(this,Z),q).length:0)}get hasMagic(){if(d(this,ne)!==void 0)return d(this,ne);for(const e of d(this,q))if(typeof e!="string"&&(e.type||e.hasMagic))return x(this,ne,!0);return d(this,ne)}toString(){return d(this,mn)!==void 0?d(this,mn):this.type?x(this,mn,this.type+"("+d(this,q).map(e=>String(e)).join("|")+")"):x(this,mn,d(this,q).map(e=>String(e)).join(""))}push(...e){for(const t of e)if(t!==""){if(typeof t!="string"&&!(t instanceof me&&d(t,Z)===this))throw new Error("invalid part: "+t);d(this,q).push(t)}}toJSON(){var t;const e=this.type===null?d(this,q).slice().map(r=>typeof r=="string"?r:r.toJSON()):[this.type,...d(this,q).map(r=>r.toJSON())];return this.isStart()&&!this.type&&e.unshift([]),this.isEnd()&&(this===d(this,ee)||d(d(this,ee),Ft)&&((t=d(this,Z))==null?void 0:t.type)==="!")&&e.push({}),e}isStart(){var t;if(d(this,ee)===this)return!0;if(!((t=d(this,Z))!=null&&t.isStart()))return!1;if(d(this,zt)===0)return!0;const e=d(this,Z);for(let r=0;r<d(this,zt);r++){const s=d(e,q)[r];if(!(s instanceof me&&s.type==="!"))return!1}return!0}isEnd(){var t,r,s;if(d(this,ee)===this||((t=d(this,Z))==null?void 0:t.type)==="!")return!0;if(!((r=d(this,Z))!=null&&r.isEnd()))return!1;if(!this.type)return(s=d(this,Z))==null?void 0:s.isEnd();const e=d(this,Z)?d(d(this,Z),q).length:0;return d(this,zt)===e-1}copyIn(e){typeof e=="string"?this.push(e):this.push(e.clone(this))}clone(e){const t=new me(this.type,e);for(const r of d(this,q))t.copyIn(r);return t}static fromGlob(e,t={}){var s;const r=new me(null,void 0,t);return G(s=me,Qt,rs).call(s,e,r,0,t),r}toMMPattern(){if(this!==d(this,ee))return d(this,ee).toMMPattern();const e=this.toString(),[t,r,s,i]=this.toRegExpSource();if(!(s||d(this,ne)||d(this,ct).nocase&&!d(this,ct).nocaseMagicOnly&&e.toUpperCase()!==e.toLowerCase()))return r;const o=(d(this,ct).nocase?"i":"")+(i?"u":"");return Object.assign(new RegExp(`^${t}$`,o),{_src:t,_glob:e})}get options(){return d(this,ct)}toRegExpSource(e){var l;const t=e??!!d(this,ct).dot;if(d(this,ee)===this&&G(this,En,il).call(this),!this.type){const c=this.isStart()&&this.isEnd()&&!d(this,q).some(v=>typeof v!="string"),u=d(this,q).map(v=>{var D;const[g,w,T,I]=typeof v=="string"?G(D=me,Qt,al).call(D,v,d(this,ne),c):v.toRegExpSource(e);return x(this,ne,d(this,ne)||T),x(this,Tt,d(this,Tt)||I),g}).join("");let h="";if(this.isStart()&&typeof d(this,q)[0]=="string"&&!(d(this,q).length===1&&mf.has(d(this,q)[0]))){const g=gf,w=t&&g.has(u.charAt(0))||u.startsWith("\\.")&&g.has(u.charAt(2))||u.startsWith("\\.\\.")&&g.has(u.charAt(4)),T=!t&&!e&&g.has(u.charAt(0));h=w?pf:T?Zr:""}let f="";return this.isEnd()&&d(d(this,ee),Ft)&&((l=d(this,Z))==null?void 0:l.type)==="!"&&(f="(?:$|\\/)"),[h+u+f,kr(u),x(this,ne,!!d(this,ne)),d(this,Tt)]}const r=this.type==="*"||this.type==="+",s=this.type==="!"?"(?:(?!(?:":"(?:";let i=G(this,En,Vs).call(this,t);if(this.isStart()&&this.isEnd()&&!i&&this.type!=="!"){const c=this.toString();return x(this,q,[c]),this.type=null,x(this,ne,void 0),[c,kr(this.toString()),!1,!1]}let a=!r||e||t||!Zr?"":G(this,En,Vs).call(this,!0);a===i&&(a=""),a&&(i=`(?:${i})(?:${a})*?`);let o="";if(this.type==="!"&&d(this,Nr))o=(this.isStart()&&!t?Zr:"")+Ia;else{const c=this.type==="!"?"))"+(this.isStart()&&!t&&!e?Zr:"")+Ra+")":this.type==="@"?")":this.type==="?"?")?":this.type==="+"&&a?")":this.type==="*"&&a?")?":`)${this.type}`;o=s+i+c}return[o,kr(i),x(this,ne,!!d(this,ne)),d(this,Tt)]}};ee=new WeakMap,ne=new WeakMap,Tt=new WeakMap,q=new WeakMap,Z=new WeakMap,zt=new WeakMap,gn=new WeakMap,Ft=new WeakMap,ct=new WeakMap,mn=new WeakMap,Nr=new WeakMap,En=new WeakSet,il=function(){if(this!==d(this,ee))throw new Error("should only call on root");if(d(this,Ft))return this;this.toString(),x(this,Ft,!0);let e;for(;e=d(this,gn).pop();){if(e.type!=="!")continue;let t=e,r=d(t,Z);for(;r;){for(let s=d(t,zt)+1;!r.type&&s<d(r,q).length;s++)for(const i of d(e,q)){if(typeof i=="string")throw new Error("string part in extglob AST??");i.copyIn(d(r,q)[s])}t=r,r=d(t,Z)}}return this},Qt=new WeakSet,rs=function(e,t,r,s){var p,v;let i=!1,a=!1,o=-1,l=!1;if(t.type===null){let g=r,w="";for(;g<e.length;){const T=e.charAt(g++);if(i||T==="\\"){i=!i,w+=T;continue}if(a){g===o+1?(T==="^"||T==="!")&&(l=!0):T==="]"&&!(g===o+2&&l)&&(a=!1),w+=T;continue}else if(T==="["){a=!0,o=g,l=!1,w+=T;continue}if(!s.noext&&Aa(T)&&e.charAt(g)==="("){t.push(w),w="";const I=new me(T,t);g=G(p=me,Qt,rs).call(p,e,I,g,s),t.push(I);continue}w+=T}return t.push(w),g}let c=r+1,u=new me(null,t);const h=[];let f="";for(;c<e.length;){const g=e.charAt(c++);if(i||g==="\\"){i=!i,f+=g;continue}if(a){c===o+1?(g==="^"||g==="!")&&(l=!0):g==="]"&&!(c===o+2&&l)&&(a=!1),f+=g;continue}else if(g==="["){a=!0,o=c,l=!1,f+=g;continue}if(Aa(g)&&e.charAt(c)==="("){u.push(f),f="";const w=new me(g,u);u.push(w),c=G(v=me,Qt,rs).call(v,e,w,c,s);continue}if(g==="|"){u.push(f),f="",h.push(u),u=new me(null,t);continue}if(g===")")return f===""&&d(t,q).length===0&&x(t,Nr,!0),u.push(f),f="",t.push(...h,u),c;f+=g}return t.type=null,x(t,ne,void 0),x(t,q,[e.substring(r-1)]),c},Vs=function(e){return d(this,q).map(t=>{if(typeof t=="string")throw new Error("string type in extglob ast??");const[r,s,i,a]=t.toRegExpSource(e);return x(this,Tt,d(this,Tt)||a),r}).filter(t=>!(this.isStart()&&this.isEnd())||!!t).join("|")},al=function(e,t,r=!1){let s=!1,i="",a=!1;for(let o=0;o<e.length;o++){const l=e.charAt(o);if(s){s=!1,i+=(yf.has(l)?"\\":"")+l;continue}if(l==="\\"){o===e.length-1?i+="\\\\":s=!0;continue}if(l==="["){const[c,u,h,f]=df(e,o);if(h){i+=c,a=a||u,o+=h-1,t=t||f;continue}}if(l==="*"){i+=r&&e==="*"?Ia:Ra,t=!0;continue}if(l==="?"){i+=_i,t=!0;continue}i+=wf(l)}return[i,kr(e),!!t,a]},O(me,Qt);let os=me;const bf=(n,{windowsPathsNoEscape:e=!1,magicalBraces:t=!1}={})=>t?e?n.replace(/[?*()[\]{}]/g,"[$&]"):n.replace(/[?*()[\]\\{}]/g,"\\$&"):e?n.replace(/[?*()[\]]/g,"[$&]"):n.replace(/[?*()[\]\\]/g,"\\$&"),be=(n,e,t={})=>(as(e),!t.nocomment&&e.charAt(0)==="#"?!1:new sr(e,t).match(n)),Tf=/^\*+([^+@!?\*\[\(]*)$/,kf=n=>e=>!e.startsWith(".")&&e.endsWith(n),Sf=n=>e=>e.endsWith(n),_f=n=>(n=n.toLowerCase(),e=>!e.startsWith(".")&&e.toLowerCase().endsWith(n)),Ef=n=>(n=n.toLowerCase(),e=>e.toLowerCase().endsWith(n)),Df=/^\*+\.\*+$/,xf=n=>!n.startsWith(".")&&n.includes("."),Af=n=>n!=="."&&n!==".."&&n.includes("."),Rf=/^\.\*+$/,If=n=>n!=="."&&n!==".."&&n.startsWith("."),Of=/^\*+$/,Mf=n=>n.length!==0&&!n.startsWith("."),Cf=n=>n.length!==0&&n!=="."&&n!=="..",Nf=/^\?+([^+@!?\*\[\(]*)?$/,Lf=([n,e=""])=>{const t=ol([n]);return e?(e=e.toLowerCase(),r=>t(r)&&r.toLowerCase().endsWith(e)):t},$f=([n,e=""])=>{const t=ll([n]);return e?(e=e.toLowerCase(),r=>t(r)&&r.toLowerCase().endsWith(e)):t},Uf=([n,e=""])=>{const t=ll([n]);return e?r=>t(r)&&r.endsWith(e):t},zf=([n,e=""])=>{const t=ol([n]);return e?r=>t(r)&&r.endsWith(e):t},ol=([n])=>{const e=n.length;return t=>t.length===e&&!t.startsWith(".")},ll=([n])=>{const e=n.length;return t=>t.length===e&&t!=="."&&t!==".."},cl=typeof process=="object"&&process?typeof process.env=="object"&&process.env&&process.env.__MINIMATCH_TESTING_PLATFORM__||process.platform:"posix",Oa={win32:{sep:"\\"},posix:{sep:"/"}},Ff=cl==="win32"?Oa.win32.sep:Oa.posix.sep;be.sep=Ff;const $e=Symbol("globstar **");be.GLOBSTAR=$e;const Yf="[^/]",Pf=Yf+"*?",Bf="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",jf="(?:(?!(?:\\/|^)\\.).)*?",Hf=(n,e={})=>t=>be(t,n,e);be.filter=Hf;const Ne=(n,e={})=>Object.assign({},n,e),Wf=n=>{if(!n||typeof n!="object"||!Object.keys(n).length)return be;const e=be;return Object.assign((r,s,i={})=>e(r,s,Ne(n,i)),{Minimatch:class extends e.Minimatch{constructor(s,i={}){super(s,Ne(n,i))}static defaults(s){return e.defaults(Ne(n,s)).Minimatch}},AST:class extends e.AST{constructor(s,i,a={}){super(s,i,Ne(n,a))}static fromGlob(s,i={}){return e.AST.fromGlob(s,Ne(n,i))}},unescape:(r,s={})=>e.unescape(r,Ne(n,s)),escape:(r,s={})=>e.escape(r,Ne(n,s)),filter:(r,s={})=>e.filter(r,Ne(n,s)),defaults:r=>e.defaults(Ne(n,r)),makeRe:(r,s={})=>e.makeRe(r,Ne(n,s)),braceExpand:(r,s={})=>e.braceExpand(r,Ne(n,s)),match:(r,s,i={})=>e.match(r,s,Ne(n,i)),sep:e.sep,GLOBSTAR:$e})};be.defaults=Wf;const ul=(n,e={})=>(as(n),e.nobrace||!/\{(?:(?!\{).)*\}/.test(n)?[n]:sf(n));be.braceExpand=ul;const Kf=(n,e={})=>new sr(n,e).makeRe();be.makeRe=Kf;const qf=(n,e,t={})=>{const r=new sr(e,t);return n=n.filter(s=>r.match(s)),r.options.nonull&&!n.length&&n.push(e),n};be.match=qf;const Ma=/[?*]|[+@!]\(.*?\)|\[|\]/,Gf=n=>n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");class sr{constructor(e,t={}){y(this,"options");y(this,"set");y(this,"pattern");y(this,"windowsPathsNoEscape");y(this,"nonegate");y(this,"negate");y(this,"comment");y(this,"empty");y(this,"preserveMultipleSlashes");y(this,"partial");y(this,"globSet");y(this,"globParts");y(this,"nocase");y(this,"isWindows");y(this,"platform");y(this,"windowsNoMagicRoot");y(this,"regexp");as(e),t=t||{},this.options=t,this.pattern=e,this.platform=t.platform||cl,this.isWindows=this.platform==="win32",this.windowsPathsNoEscape=!!t.windowsPathsNoEscape||t.allowWindowsEscape===!1,this.windowsPathsNoEscape&&(this.pattern=this.pattern.replace(/\\/g,"/")),this.preserveMultipleSlashes=!!t.preserveMultipleSlashes,this.regexp=null,this.negate=!1,this.nonegate=!!t.nonegate,this.comment=!1,this.empty=!1,this.partial=!!t.partial,this.nocase=!!this.options.nocase,this.windowsNoMagicRoot=t.windowsNoMagicRoot!==void 0?t.windowsNoMagicRoot:!!(this.isWindows&&this.nocase),this.globSet=[],this.globParts=[],this.set=[],this.make()}hasMagic(){if(this.options.magicalBraces&&this.set.length>1)return!0;for(const e of this.set)for(const t of e)if(typeof t!="string")return!0;return!1}debug(...e){}make(){const e=this.pattern,t=this.options;if(!t.nocomment&&e.charAt(0)==="#"){this.comment=!0;return}if(!e){this.empty=!0;return}this.parseNegate(),this.globSet=[...new Set(this.braceExpand())],t.debug&&(this.debug=(...i)=>console.error(...i)),this.debug(this.pattern,this.globSet);const r=this.globSet.map(i=>this.slashSplit(i));this.globParts=this.preprocess(r),this.debug(this.pattern,this.globParts);let s=this.globParts.map((i,a,o)=>{if(this.isWindows&&this.windowsNoMagicRoot){const l=i[0]===""&&i[1]===""&&(i[2]==="?"||!Ma.test(i[2]))&&!Ma.test(i[3]),c=/^[a-z]:/i.test(i[0]);if(l)return[...i.slice(0,4),...i.slice(4).map(u=>this.parse(u))];if(c)return[i[0],...i.slice(1).map(u=>this.parse(u))]}return i.map(l=>this.parse(l))});if(this.debug(this.pattern,s),this.set=s.filter(i=>i.indexOf(!1)===-1),this.isWindows)for(let i=0;i<this.set.length;i++){const a=this.set[i];a[0]===""&&a[1]===""&&this.globParts[i][2]==="?"&&typeof a[3]=="string"&&/^[a-z]:$/i.test(a[3])&&(a[2]="?")}this.debug(this.pattern,this.set)}preprocess(e){if(this.options.noglobstar)for(let r=0;r<e.length;r++)for(let s=0;s<e[r].length;s++)e[r][s]==="**"&&(e[r][s]="*");const{optimizationLevel:t=1}=this.options;return t>=2?(e=this.firstPhasePreProcess(e),e=this.secondPhasePreProcess(e)):t>=1?e=this.levelOneOptimize(e):e=this.adjascentGlobstarOptimize(e),e}adjascentGlobstarOptimize(e){return e.map(t=>{let r=-1;for(;(r=t.indexOf("**",r+1))!==-1;){let s=r;for(;t[s+1]==="**";)s++;s!==r&&t.splice(r,s-r)}return t})}levelOneOptimize(e){return e.map(t=>(t=t.reduce((r,s)=>{const i=r[r.length-1];return s==="**"&&i==="**"?r:s===".."&&i&&i!==".."&&i!=="."&&i!=="**"?(r.pop(),r):(r.push(s),r)},[]),t.length===0?[""]:t))}levelTwoFileOptimize(e){Array.isArray(e)||(e=this.slashSplit(e));let t=!1;do{if(t=!1,!this.preserveMultipleSlashes){for(let s=1;s<e.length-1;s++){const i=e[s];s===1&&i===""&&e[0]===""||(i==="."||i==="")&&(t=!0,e.splice(s,1),s--)}e[0]==="."&&e.length===2&&(e[1]==="."||e[1]==="")&&(t=!0,e.pop())}let r=0;for(;(r=e.indexOf("..",r+1))!==-1;){const s=e[r-1];s&&s!=="."&&s!==".."&&s!=="**"&&(t=!0,e.splice(r-1,2),r-=2)}}while(t);return e.length===0?[""]:e}firstPhasePreProcess(e){let t=!1;do{t=!1;for(let r of e){let s=-1;for(;(s=r.indexOf("**",s+1))!==-1;){let a=s;for(;r[a+1]==="**";)a++;a>s&&r.splice(s+1,a-s);let o=r[s+1];const l=r[s+2],c=r[s+3];if(o!==".."||!l||l==="."||l===".."||!c||c==="."||c==="..")continue;t=!0,r.splice(s,1);const u=r.slice(0);u[s]="**",e.push(u),s--}if(!this.preserveMultipleSlashes){for(let a=1;a<r.length-1;a++){const o=r[a];a===1&&o===""&&r[0]===""||(o==="."||o==="")&&(t=!0,r.splice(a,1),a--)}r[0]==="."&&r.length===2&&(r[1]==="."||r[1]==="")&&(t=!0,r.pop())}let i=0;for(;(i=r.indexOf("..",i+1))!==-1;){const a=r[i-1];if(a&&a!=="."&&a!==".."&&a!=="**"){t=!0;const l=i===1&&r[i+1]==="**"?["."]:[];r.splice(i-1,2,...l),r.length===0&&r.push(""),i-=2}}}}while(t);return e}secondPhasePreProcess(e){for(let t=0;t<e.length-1;t++)for(let r=t+1;r<e.length;r++){const s=this.partsMatch(e[t],e[r],!this.preserveMultipleSlashes);if(s){e[t]=[],e[r]=s;break}}return e.filter(t=>t.length)}partsMatch(e,t,r=!1){let s=0,i=0,a=[],o="";for(;s<e.length&&i<t.length;)if(e[s]===t[i])a.push(o==="b"?t[i]:e[s]),s++,i++;else if(r&&e[s]==="**"&&t[i]===e[s+1])a.push(e[s]),s++;else if(r&&t[i]==="**"&&e[s]===t[i+1])a.push(t[i]),i++;else if(e[s]==="*"&&t[i]&&(this.options.dot||!t[i].startsWith("."))&&t[i]!=="**"){if(o==="b")return!1;o="a",a.push(e[s]),s++,i++}else if(t[i]==="*"&&e[s]&&(this.options.dot||!e[s].startsWith("."))&&e[s]!=="**"){if(o==="a")return!1;o="b",a.push(t[i]),s++,i++}else return!1;return e.length===t.length&&a}parseNegate(){if(this.nonegate)return;const e=this.pattern;let t=!1,r=0;for(let s=0;s<e.length&&e.charAt(s)==="!";s++)t=!t,r++;r&&(this.pattern=e.slice(r)),this.negate=t}matchOne(e,t,r=!1){const s=this.options;if(this.isWindows){const g=typeof e[0]=="string"&&/^[a-z]:$/i.test(e[0]),w=!g&&e[0]===""&&e[1]===""&&e[2]==="?"&&/^[a-z]:$/i.test(e[3]),T=typeof t[0]=="string"&&/^[a-z]:$/i.test(t[0]),I=!T&&t[0]===""&&t[1]===""&&t[2]==="?"&&typeof t[3]=="string"&&/^[a-z]:$/i.test(t[3]),D=w?3:g?0:void 0,N=I?3:T?0:void 0;if(typeof D=="number"&&typeof N=="number"){const[U,K]=[e[D],t[N]];U.toLowerCase()===K.toLowerCase()&&(t[N]=U,N>D?t=t.slice(N):D>N&&(e=e.slice(D)))}}const{optimizationLevel:i=1}=this.options;i>=2&&(e=this.levelTwoFileOptimize(e)),this.debug("matchOne",this,{file:e,pattern:t}),this.debug("matchOne",e.length,t.length);for(var a=0,o=0,l=e.length,c=t.length;a<l&&o<c;a++,o++){this.debug("matchOne loop");var u=t[o],h=e[a];if(this.debug(t,u,h),u===!1)return!1;if(u===$e){this.debug("GLOBSTAR",[t,u,h]);var f=a,p=o+1;if(p===c){for(this.debug("** at the end");a<l;a++)if(e[a]==="."||e[a]===".."||!s.dot&&e[a].charAt(0)===".")return!1;return!0}for(;f<l;){var v=e[f];if(this.debug(`
globstar while`,e,f,t,p,v),this.matchOne(e.slice(f),t.slice(p),r))return this.debug("globstar found match!",f,l,v),!0;if(v==="."||v===".."||!s.dot&&v.charAt(0)==="."){this.debug("dot detected!",e,f,t,p);break}this.debug("globstar swallow a segment, and continue"),f++}return!!(r&&(this.debug(`
>>> no match, partial?`,e,f,t,p),f===l))}let g;if(typeof u=="string"?(g=h===u,this.debug("string match",u,h,g)):(g=u.test(h),this.debug("pattern match",u,h,g)),!g)return!1}if(a===l&&o===c)return!0;if(a===l)return r;if(o===c)return a===l-1&&e[a]==="";throw new Error("wtf?")}braceExpand(){return ul(this.pattern,this.options)}parse(e){as(e);const t=this.options;if(e==="**")return $e;if(e==="")return"";let r,s=null;(r=e.match(Of))?s=t.dot?Cf:Mf:(r=e.match(Tf))?s=(t.nocase?t.dot?Ef:_f:t.dot?Sf:kf)(r[1]):(r=e.match(Nf))?s=(t.nocase?t.dot?$f:Lf:t.dot?Uf:zf)(r):(r=e.match(Df))?s=t.dot?Af:xf:(r=e.match(Rf))&&(s=If);const i=os.fromGlob(e,this.options).toMMPattern();return s&&typeof i=="object"&&Reflect.defineProperty(i,"test",{value:s}),i}makeRe(){if(this.regexp||this.regexp===!1)return this.regexp;const e=this.set;if(!e.length)return this.regexp=!1,this.regexp;const t=this.options,r=t.noglobstar?Pf:t.dot?Bf:jf,s=new Set(t.nocase?["i"]:[]);let i=e.map(l=>{const c=l.map(h=>{if(h instanceof RegExp)for(const f of h.flags.split(""))s.add(f);return typeof h=="string"?Gf(h):h===$e?$e:h._src});c.forEach((h,f)=>{const p=c[f+1],v=c[f-1];h!==$e||v===$e||(v===void 0?p!==void 0&&p!==$e?c[f+1]="(?:\\/|"+r+"\\/)?"+p:c[f]=r:p===void 0?c[f-1]=v+"(?:\\/|\\/"+r+")?":p!==$e&&(c[f-1]=v+"(?:\\/|\\/"+r+"\\/)"+p,c[f+1]=$e))});const u=c.filter(h=>h!==$e);if(this.partial&&u.length>=1){const h=[];for(let f=1;f<=u.length;f++)h.push(u.slice(0,f).join("/"));return"(?:"+h.join("|")+")"}return u.join("/")}).join("|");const[a,o]=e.length>1?["(?:",")"]:["",""];i="^"+a+i+o+"$",this.partial&&(i="^(?:\\/|"+a+i.slice(1,-1)+o+")$"),this.negate&&(i="^(?!"+i+").+$");try{this.regexp=new RegExp(i,[...s].join(""))}catch{this.regexp=!1}return this.regexp}slashSplit(e){return this.preserveMultipleSlashes?e.split("/"):this.isWindows&&/^\/\/[^\/]+/.test(e)?["",...e.split(/\/+/)]:e.split(/\/+/)}match(e,t=this.partial){if(this.debug("match",e,this.pattern),this.comment)return!1;if(this.empty)return e==="";if(e==="/"&&t)return!0;const r=this.options;this.isWindows&&(e=e.split("\\").join("/"));const s=this.slashSplit(e);this.debug(this.pattern,"split",s);const i=this.set;this.debug(this.pattern,"set",i);let a=s[s.length-1];if(!a)for(let o=s.length-2;!a&&o>=0;o--)a=s[o];for(let o=0;o<i.length;o++){const l=i[o];let c=s;if(r.matchBase&&l.length===1&&(c=[a]),this.matchOne(c,l,t))return r.flipNegate?!0:!this.negate}return r.flipNegate?!1:this.negate}static defaults(e){return be.defaults(e).Minimatch}}be.AST=os;be.Minimatch=sr;be.escape=bf;be.unescape=kr;const Qf={id:"default",name:"Default",description:"Include all tasks",includePaths:[],excludePaths:[],includeTags:[],excludeTags:[],includeRegex:void 0,excludeRegex:void 0,regexTargets:["taskText"],excludeStatusTypes:[]},Ca={enabled:!1,mode:"all",activeProfileId:"default",profiles:[Qf]};class Xf{constructor(e){y(this,"includePathMatchers",[]);y(this,"excludePathMatchers",[]);y(this,"includeTagsSet",new Set);y(this,"excludeTagsSet",new Set);y(this,"includeRegex");y(this,"excludeRegex");y(this,"regexTargets");if(this.includePathMatchers=e.includePaths.map(t=>new sr(this.normalizePath(t),{dot:!0,matchBase:!0})),this.excludePathMatchers=e.excludePaths.map(t=>new sr(this.normalizePath(t),{dot:!0,matchBase:!0})),this.includeTagsSet=new Set(e.includeTags.map(t=>this.normalizeTag(t))),this.excludeTagsSet=new Set(e.excludeTags.map(t=>this.normalizeTag(t))),e.includeRegex)try{this.includeRegex=new RegExp(e.includeRegex)}catch{}if(e.excludeRegex)try{this.excludeRegex=new RegExp(e.excludeRegex)}catch{}this.regexTargets=new Set(e.regexTargets)}matches(e){const t=e.path?this.normalizePath(e.path):void 0,r=e.tags??[],s=e.name||"",i=this.regexTargets.has("taskText"),a=this.regexTargets.has("path"),o=this.regexTargets.has("fileName");let l;if(this.excludePathMatchers.length>0&&t){for(const c of this.excludePathMatchers)if(c.match(t))return!1}if(this.includePathMatchers.length>0){if(!t)return!1;let c=!1;for(const u of this.includePathMatchers)if(u.match(t)){c=!0;break}if(!c)return!1}if(this.excludeTagsSet.size>0&&r.length>0){for(const c of r)if(this.excludeTagsSet.has(this.normalizeTag(c)))return!1}if(this.includeTagsSet.size>0){if(r.length===0)return!1;let c=!1;for(const u of r)if(this.includeTagsSet.has(this.normalizeTag(u))){c=!0;break}if(!c)return!1}if(this.excludeRegex&&(i&&this.excludeRegex.test(s)||a&&t&&this.excludeRegex.test(t)||o&&(l=t?this.extractFileName(t):e.path?this.extractFileName(e.path):void 0,l&&this.excludeRegex.test(l))))return!1;if(this.includeRegex){let c=!1;if(i&&this.includeRegex.test(s)||a&&t&&this.includeRegex.test(t)?c=!0:o&&(l=l??(t?this.extractFileName(t):e.path?this.extractFileName(e.path):void 0),l&&this.includeRegex.test(l)&&(c=!0)),!c)return!1}return!0}explain(e){const t=e.path?this.normalizePath(e.path):void 0,r=e.tags??[],s=e.name||"",i=this.regexTargets.has("taskText"),a=this.regexTargets.has("path"),o=this.regexTargets.has("fileName");let l;if(this.excludePathMatchers.length>0&&t){for(const c of this.excludePathMatchers)if(c.match(t))return{included:!1,reason:"Excluded by path pattern",matchedRule:{type:"excludePath",pattern:c.pattern}}}if(this.includePathMatchers.length>0){if(!t)return{included:!1,reason:"includePaths set but task has no path metadata"};let c=!1;for(const u of this.includePathMatchers)if(u.match(t)){c=!0;break}if(!c)return{included:!1,reason:"Did not match any includePath pattern"}}if(this.excludeTagsSet.size>0&&r.length>0)for(const c of r){const u=this.normalizeTag(c);if(this.excludeTagsSet.has(u))return{included:!1,reason:"Excluded by tag",matchedRule:{type:"excludeTag",pattern:u}}}if(this.includeTagsSet.size>0){if(r.length===0)return{included:!1,reason:"includeTags set but task has no tags"};let c=!1;for(const u of r)if(this.includeTagsSet.has(this.normalizeTag(u))){c=!0;break}if(!c)return{included:!1,reason:"Did not match any includeTag"}}if(this.excludeRegex){if(i&&this.excludeRegex.test(s))return{included:!1,reason:"Excluded by regex",matchedRule:{type:"excludeRegex",pattern:this.excludeRegex.source,target:"taskText"}};if(a&&t&&this.excludeRegex.test(t))return{included:!1,reason:"Excluded by regex",matchedRule:{type:"excludeRegex",pattern:this.excludeRegex.source,target:"path"}};if(o&&(l=t?this.extractFileName(t):e.path?this.extractFileName(e.path):void 0,l&&this.excludeRegex.test(l)))return{included:!1,reason:"Excluded by regex",matchedRule:{type:"excludeRegex",pattern:this.excludeRegex.source,target:"fileName"}}}if(this.includeRegex){let c=!1;if(i&&this.includeRegex.test(s)||a&&t&&this.includeRegex.test(t)?c=!0:o&&(l=l??(t?this.extractFileName(t):e.path?this.extractFileName(e.path):void 0),l&&this.includeRegex.test(l)&&(c=!0)),!c)return{included:!1,reason:"Did not match includeRegex",matchedRule:{type:"includeRegex",pattern:this.includeRegex.source}}}return{included:!0,reason:"Passed all filters"}}normalizePath(e){return e.replace(/\\/g,"/").replace(/^\/+/,"")}normalizeTag(e){return e.startsWith("#")?e.toLowerCase():`#${e}`.toLowerCase()}extractFileName(e){return e.split("/").pop()||""}}const an=class an{constructor(){y(this,"config");y(this,"compiled",null);y(this,"cachedTagRemovalRegex");y(this,"lastCachedTag");this.config=Ca}static getInstance(){return an.instance||(an.instance=new an),an.instance}initialize(e){this.updateConfig(e)}updateConfig(e){this.config=e,this.compile()}compile(){if(!this.config.enabled){this.compiled=null;return}const e=this.config.profiles.find(t=>t.id===this.config.activeProfileId)||this.config.profiles[0];if(!e){this.compiled=null;return}this.compiled=new Xf(e)}shouldTreatAsTask(e,t){if(!this.config.enabled)return!0;if(this.config.mode==="tag"&&this.config.tag){const i=this.extractTagsFromContent(e),a=this.normalizeTag(this.config.tag);return i.some(o=>this.normalizeTag(o)===a)}if(!this.compiled)return!0;const r=this.extractTagsFromContent(e),s={name:e,path:t,tags:r};return this.compiled.matches(s)}shouldIncludeTask(e){if(!this.config.enabled)return!0;if(this.config.mode==="tag"&&this.config.tag){const t=this.normalizeTag(this.config.tag);return(e.tags||[]).some(r=>this.normalizeTag(r)===t)}return this.compiled?this.compiled.matches(e):!0}explainTask(e){return this.compiled?this.compiled.explain(e):{included:!0,reason:"Global filter disabled"}}extractTagsFromContent(e){return e.match(/#[\w\/-]+/g)||[]}normalizeTag(e){return e.startsWith("#")?e.toLowerCase():`#${e}`.toLowerCase()}getConfig(){return this.config}getActiveProfile(){return this.config.profiles.find(e=>e.id===this.config.activeProfileId)}setActiveProfile(e){this.config.profiles.some(t=>t.id===e)&&(this.config.activeProfileId=e,this.compile())}reset(){this.updateConfig(Ca)}removeTagFromDescription(e){if(!this.config.enabled||this.config.mode!=="tag"||!this.config.tag||!this.config.removeFromDescription)return e;if(!this.cachedTagRemovalRegex||this.lastCachedTag!==this.config.tag){const t=this.normalizeTag(this.config.tag);this.cachedTagRemovalRegex=new RegExp(`\\s*${t.replace("#","\\#")}\\s*`,"gi"),this.lastCachedTag=this.config.tag}return e.replace(this.cachedTagRemovalRegex," ").trim()}};y(an,"instance");let ls=an;class Vf{constructor(e,t=new Fh){y(this,"plugin");y(this,"activeTasks");y(this,"blockIndex",new Map);y(this,"taskBlockIndex",new Map);y(this,"dueIndex",new Map);y(this,"activeStore");y(this,"archiveStore");y(this,"persistence");y(this,"blockAttrSyncEnabled",!0);y(this,"blockApi");y(this,"apiAdapter");y(this,"blockAttrRetryQueue",new Map);y(this,"blockAttrRetryTimeouts",new Map);this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Ph(e,t),this.archiveStore=new Bh(e),this.persistence=new jh(this.activeStore)}async init(){await this.migrateLegacyStorage();const e=await this.activeStore.loadActive(),t=ls.getInstance(),r=new Map;for(const[s,i]of e.entries())t.shouldIncludeTask(i)&&r.set(s,i);this.activeTasks=r,F(`Loaded ${this.activeTasks.size} active tasks from storage (after global filter)`),this.rebuildBlockIndex(),this.rebuildDueIndex()}async loadActiveTasks(e=1e3,t){const r=await this.activeStore.loadActive(),s=Array.from(r.values()),i=ls.getInstance(),a=s.filter(c=>i.shouldIncludeTask(c)),o=a.length;if(o===0)return[];const l=[];for(let c=0;c<o;c+=e){const u=a.slice(c,Math.min(c+e,o));l.push(...u),t&&t(l.length,o),await new Promise(h=>setTimeout(h,0))}return l}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));F(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);F(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),r=this.dueIndex.get(t);r&&(r.delete(e.id),r.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),r=[];for(const[s]of this.dueIndex)s<=t&&r.push(...this.getTasksForDueKey(s));return r}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const r=[];for(const s of t){const i=this.activeTasks.get(s);if(!i){this.removeStaleDueIndexEntry(e,s,"missing task");continue}if(!i.enabled){this.removeStaleDueIndexEntry(e,s,"task disabled");continue}if(i.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,s,"date mismatch");continue}r.push(i)}return r}removeStaleDueIndexEntry(e,t,r){const s=this.dueIndex.get(e);s&&(s.delete(t),s.size===0&&this.dueIndex.delete(e),W("Removed stale due index entry",{taskId:t,dateKey:e,reason:r}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id);if(t&&e.version!==void 0&&t.version!==void 0&&e.version<t.version)throw new Error(`Concurrent modification detected for task "${e.name}". Please refresh and try again.`);e.version=(e.version??0)+1;const r=this.activeTasks.get(e.id),s=this.taskBlockIndex.get(e.id);s&&s!==e.linkedBlockId&&(this.blockIndex.delete(s),this.taskBlockIndex.delete(e.id)),r&&r.enabled&&(r.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(r),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrsWithRetry(e),s&&s!==e.linkedBlockId&&await this.clearBlockAttrs(s)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[ya]:e.id,[wa]:e.dueAt,[ba]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[ya]:"",[wa]:"",[ba]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){br({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(r){r instanceof Vo?(br({feature:r.feature,capability:r.capability,message:r.message}),this.blockAttrSyncEnabled=!1):r instanceof Zo?(br({feature:r.feature,capability:r.capability,message:r.message,cause:r.cause}),this.queueBlockAttrRetry(e,t)):(br({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:r}),this.blockAttrSyncEnabled=!1)}}}queueBlockAttrRetry(e,t){const r=this.blockAttrRetryQueue.get(e),s=((r==null?void 0:r.attempts)??0)+1;if(s>3){W(`Block attr sync for ${e} failed after 3 retries, giving up`),this.blockAttrRetryQueue.delete(e),this.blockAttrRetryTimeouts.delete(e);return}this.blockAttrRetryQueue.set(e,{attrs:t,attempts:s});const i=this.blockAttrRetryTimeouts.get(e);i!==void 0&&globalThis.clearTimeout(i);const a=globalThis.setTimeout(()=>{this.blockAttrRetryTimeouts.delete(e);const o=this.blockAttrRetryQueue.get(e);o&&(this.blockAttrRetryQueue.delete(e),this.updateBlockAttrs(e,o.attrs).catch(()=>{}))},2e3*s);this.blockAttrRetryTimeouts.set(e,a)}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(r=>new Date(r.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(r=>{const s=new Date(r.dueAt);return s>=e&&s<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(Yn);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(la);if(!t)return;const r=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(r.length===0)return;await this.plugin.saveData(ca,t),F(`Created legacy backup at ${ca}`);const s=r.filter(o=>!o.enabled&&o.lastCompletedAt),i=r.filter(o=>!s.includes(o)),a=new Map(i.map(o=>[o.id,o]));this.persistence.requestSave({tasks:Array.from(a.values())}),await this.persistence.flush(),s.length>0&&await this.archiveStore.archiveTasks(s),F("Legacy storage migration complete",{activeCount:i.length,archivedCount:s.length,legacyKey:la,activeKey:Yn,archiveIndexKey:ns})}async syncTaskToBlockAttrsWithRetry(e){try{await this.syncTaskToBlockAttrs(e)}catch(t){W(`Initial block sync failed for task ${e.id}, retry queued if transient`,{taskId:e.id,error:t instanceof Error?t.message:String(t)})}}stopSyncRetryProcessor(){for(const e of this.blockAttrRetryTimeouts.values())globalThis.clearTimeout(e);this.blockAttrRetryTimeouts.clear(),this.blockAttrRetryQueue.clear()}}var Zs=["MO","TU","WE","TH","FR","SA","SU"],ye=function(){function n(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return n.fromStr=function(e){return new n(Zs.indexOf(e))},n.prototype.nth=function(e){return this.n===e?this:new n(this.weekday,e)},n.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},n.prototype.toString=function(){var e=Zs[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},n.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},n}(),J=function(n){return n!=null},st=function(n){return typeof n=="number"},Na=function(n){return typeof n=="string"&&Zs.includes(n)},Ie=Array.isArray,dt=function(n,e){e===void 0&&(e=n),arguments.length===1&&(e=n,n=0);for(var t=[],r=n;r<e;r++)t.push(r);return t},Y=function(n,e){var t=0,r=[];if(Ie(n))for(;t<e;t++)r[t]=[].concat(n);else for(;t<e;t++)r[t]=n;return r},Zf=function(n){return Ie(n)?n:[n]};function Un(n,e,t){t===void 0&&(t=" ");var r=String(n);return e=e>>0,r.length>e?String(r):(e=e-r.length,e>t.length&&(t+=Y(t,e/t.length)),t.slice(0,e)+String(r))}var Jf=function(n,e,t){var r=n.split(e);return t?r.slice(0,t).concat([r.slice(t).join(e)]):r},Pe=function(n,e){var t=n%e;return t*e<0?t+e:t},Ms=function(n,e){return{div:Math.floor(n/e),mod:Pe(n,e)}},ut=function(n){return!J(n)||n.length===0},se=function(n){return!ut(n)},H=function(n,e){return se(n)&&n.indexOf(e)!==-1},_n=function(n,e,t,r,s,i){return r===void 0&&(r=0),s===void 0&&(s=0),i===void 0&&(i=0),new Date(Date.UTC(n,e-1,t,r,s,i))},ed=[31,28,31,30,31,30,31,31,30,31,30,31],hl=1e3*60*60*24,fl=9999,dl=_n(1970,1,1),td=[6,0,1,2,3,4,5],Dr=function(n){return n%4===0&&n%100!==0||n%400===0},vl=function(n){return n instanceof Date},Sr=function(n){return vl(n)&&!isNaN(n.getTime())},nd=function(n,e){var t=n.getTime(),r=e.getTime(),s=t-r;return Math.round(s/hl)},Js=function(n){return nd(n,dl)},pl=function(n){return new Date(dl.getTime()+n*hl)},rd=function(n){var e=n.getUTCMonth();return e===1&&Dr(n.getUTCFullYear())?29:ed[e]},ir=function(n){return td[n.getUTCDay()]},La=function(n,e){var t=_n(n,e+1,1);return[ir(t),rd(t)]},gl=function(n,e){return e=e||n,new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},ei=function(n){var e=new Date(n.getTime());return e},$a=function(n){for(var e=[],t=0;t<n.length;t++)e.push(ei(n[t]));return e},Rr=function(n){n.sort(function(e,t){return e.getTime()-t.getTime()})},Ei=function(n,e){e===void 0&&(e=!0);var t=new Date(n);return[Un(t.getUTCFullYear().toString(),4,"0"),Un(t.getUTCMonth()+1,2,"0"),Un(t.getUTCDate(),2,"0"),"T",Un(t.getUTCHours(),2,"0"),Un(t.getUTCMinutes(),2,"0"),Un(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},Di=function(n){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(n);if(!t)throw new Error("Invalid UNTIL value: ".concat(n));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},Ua=function(n,e){var t=n.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},sd=function(n,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,r=new Date(Ua(n,t)),s=new Date(Ua(n,e??"UTC")),i=s.getTime()-r.getTime();return new Date(n.getTime()-i)},Pn=function(){function n(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return n.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,r=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(r)return!1}else if(this.method==="before"){if(r)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},n.prototype.add=function(e){return this._result.push(e),!0},n.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},n.prototype.clone=function(){return new n(this.method,this.args)},n}(),ti=function(n,e){return ti=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])},ti(n,e)};function xi(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");ti(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var Me=function(){return Me=Object.assign||function(e){for(var t,r=1,s=arguments.length;r<s;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},Me.apply(this,arguments)};function k(n,e,t){if(t||arguments.length===2)for(var r=0,s=e.length,i;r<s;r++)(i||!(r in e))&&(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return n.concat(i||Array.prototype.slice.call(e))}var za=function(n){xi(e,n);function e(t,r,s){var i=n.call(this,t,r)||this;return i.iterator=s,i}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Pn),cs={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},Fa=function(n,e){return n.indexOf(e)!==-1},id=function(n){return n.toString()},ad=function(n,e,t){return"".concat(e," ").concat(t,", ").concat(n)},Rt=function(){function n(e,t,r,s){if(t===void 0&&(t=id),r===void 0&&(r=cs),s===void 0&&(s=ad),this.text=[],this.language=r||cs,this.gettext=t,this.dateFormatter=s,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var i=[].concat(this.options.bymonthday),a=[].concat(this.options.bynmonthday);i.sort(function(u,h){return u-h}),a.sort(function(u,h){return h-u}),this.bymonthday=i.concat(a),this.bymonthday.length||(this.bymonthday=null)}if(J(this.origOptions.byweekday)){var o=Ie(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],l=String(o);this.byweekday={allWeeks:o.filter(function(u){return!u.n}),someWeeks:o.filter(function(u){return!!u.n}),isWeekdays:l.indexOf("MO")!==-1&&l.indexOf("TU")!==-1&&l.indexOf("WE")!==-1&&l.indexOf("TH")!==-1&&l.indexOf("FR")!==-1&&l.indexOf("SA")===-1&&l.indexOf("SU")===-1,isEveryDay:l.indexOf("MO")!==-1&&l.indexOf("TU")!==-1&&l.indexOf("WE")!==-1&&l.indexOf("TH")!==-1&&l.indexOf("FR")!==-1&&l.indexOf("SA")!==-1&&l.indexOf("SU")!==-1};var c=function(u,h){return u.weekday-h.weekday};this.byweekday.allWeeks.sort(c),this.byweekday.someWeeks.sort(c),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return n.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in n.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var r in e.origOptions){if(Fa(["dtstart","tzid","wkst","freq"],r))return!0;if(!Fa(n.IMPLEMENTED[e.options.freq],r))return!1}return t},n.prototype.isFullyConvertible=function(){return n.isFullyConvertible(this.rrule)},n.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in n.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[S.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},n.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},n.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},n.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},n.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},n.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},n.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},n.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},n.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},n.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},n.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},n.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,r=this.gettext;if(e===-1)return r("last");var s=Math.abs(e);switch(s){case 1:case 21:case 31:t=s+r("st");break;case 2:case 22:t=s+r("nd");break;case 3:case 23:t=s+r("rd");break;default:t=s+r("th")}return e<0?t+" "+r("last"):t},n.prototype.monthtext=function(e){return this.language.monthNames[e-1]},n.prototype.weekdaytext=function(e){var t=st(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},n.prototype.plural=function(e){return e%100!==1},n.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},n.prototype.list=function(e,t,r,s){var i=this;s===void 0&&(s=","),Ie(e)||(e=[e]);var a=function(l,c,u){for(var h="",f=0;f<l.length;f++)f!==0&&(f===l.length-1?h+=" "+u+" ":h+=c+" "),h+=l[f];return h};t=t||function(l){return l.toString()};var o=function(l){return t&&t.call(i,l)};return r?a(e.map(o),s,r):e.map(o).join(s+" ")},n}(),od=function(){function n(e){this.done=!0,this.rules=e}return n.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},n.prototype.isDone=function(){return this.done&&this.symbol===null},n.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var r=void 0;e=null;for(var s in this.rules){r=this.rules[s];var i=r.exec(this.text);i&&(e===null||i[0].length>e[0].length)&&(e=i,t=s)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},n.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},n.prototype.acceptNumber=function(){return this.accept("number")},n.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},n}();function ml(n,e){e===void 0&&(e=cs);var t={},r=new od(e.tokens);if(!r.start(n))return null;return s(),t;function s(){r.expect("every");var f=r.acceptNumber();if(f&&(t.interval=parseInt(f[0],10)),r.isDone())throw new Error("Unexpected end");switch(r.symbol){case"day(s)":t.freq=S.DAILY,r.nextSymbol()&&(a(),h());break;case"weekday(s)":t.freq=S.WEEKLY,t.byweekday=[S.MO,S.TU,S.WE,S.TH,S.FR],r.nextSymbol(),a(),h();break;case"week(s)":t.freq=S.WEEKLY,r.nextSymbol()&&(i(),a(),h());break;case"hour(s)":t.freq=S.HOURLY,r.nextSymbol()&&(i(),h());break;case"minute(s)":t.freq=S.MINUTELY,r.nextSymbol()&&(i(),h());break;case"month(s)":t.freq=S.MONTHLY,r.nextSymbol()&&(i(),h());break;case"year(s)":t.freq=S.YEARLY,r.nextSymbol()&&(i(),h());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=S.WEEKLY;var p=r.symbol.substr(0,2).toUpperCase();if(t.byweekday=[S[p]],!r.nextSymbol())return;for(;r.accept("comma");){if(r.isDone())throw new Error("Unexpected end");var v=l();if(!v)throw new Error("Unexpected symbol "+r.symbol+", expected weekday");t.byweekday.push(S[v]),r.nextSymbol()}a(),u(),h();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=S.YEARLY,t.bymonth=[o()],!r.nextSymbol())return;for(;r.accept("comma");){if(r.isDone())throw new Error("Unexpected end");var g=o();if(!g)throw new Error("Unexpected symbol "+r.symbol+", expected month");t.bymonth.push(g),r.nextSymbol()}i(),h();break;default:throw new Error("Unknown symbol")}}function i(){var f=r.accept("on"),p=r.accept("the");if(f||p)do{var v=c(),g=l(),w=o();if(v)g?(r.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(S[g].nth(v))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(v),r.accept("day(s)"));else if(g)r.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(S[g]);else if(r.symbol==="weekday(s)")r.nextSymbol(),t.byweekday||(t.byweekday=[S.MO,S.TU,S.WE,S.TH,S.FR]);else if(r.symbol==="week(s)"){r.nextSymbol();var T=r.acceptNumber();if(!T)throw new Error("Unexpected symbol "+r.symbol+", expected week number");for(t.byweekno=[parseInt(T[0],10)];r.accept("comma");){if(T=r.acceptNumber(),!T)throw new Error("Unexpected symbol "+r.symbol+"; expected monthday");t.byweekno.push(parseInt(T[0],10))}}else if(w)r.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(w);else return}while(r.accept("comma")||r.accept("the")||r.accept("on"))}function a(){var f=r.accept("at");if(f)do{var p=r.acceptNumber();if(!p)throw new Error("Unexpected symbol "+r.symbol+", expected hour");for(t.byhour=[parseInt(p[0],10)];r.accept("comma");){if(p=r.acceptNumber(),!p)throw new Error("Unexpected symbol "+r.symbol+"; expected hour");t.byhour.push(parseInt(p[0],10))}}while(r.accept("comma")||r.accept("at"))}function o(){switch(r.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function l(){switch(r.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return r.symbol.substr(0,2).toUpperCase();default:return!1}}function c(){switch(r.symbol){case"last":return r.nextSymbol(),-1;case"first":return r.nextSymbol(),1;case"second":return r.nextSymbol(),r.accept("last")?-2:2;case"third":return r.nextSymbol(),r.accept("last")?-3:3;case"nth":var f=parseInt(r.value[1],10);if(f<-366||f>366)throw new Error("Nth out of range: "+f);return r.nextSymbol(),r.accept("last")?-f:f;default:return!1}}function u(){r.accept("on"),r.accept("the");var f=c();if(f)for(t.bymonthday=[f],r.nextSymbol();r.accept("comma");){if(f=c(),!f)throw new Error("Unexpected symbol "+r.symbol+"; expected monthday");t.bymonthday.push(f),r.nextSymbol()}}function h(){if(r.symbol==="until"){var f=Date.parse(r.text);if(!f)throw new Error("Cannot parse until date:"+r.text);t.until=new Date(f)}else r.accept("for")&&(t.count=parseInt(r.value[0],10),r.expect("number"))}}var P;(function(n){n[n.YEARLY=0]="YEARLY",n[n.MONTHLY=1]="MONTHLY",n[n.WEEKLY=2]="WEEKLY",n[n.DAILY=3]="DAILY",n[n.HOURLY=4]="HOURLY",n[n.MINUTELY=5]="MINUTELY",n[n.SECONDLY=6]="SECONDLY"})(P||(P={}));function Ai(n){return n<P.HOURLY}var ld=function(n,e){return e===void 0&&(e=cs),new S(ml(n,e)||void 0)},cr=["count","until","interval","byweekday","bymonthday","bymonth"];Rt.IMPLEMENTED=[];Rt.IMPLEMENTED[P.HOURLY]=cr;Rt.IMPLEMENTED[P.MINUTELY]=cr;Rt.IMPLEMENTED[P.DAILY]=["byhour"].concat(cr);Rt.IMPLEMENTED[P.WEEKLY]=cr;Rt.IMPLEMENTED[P.MONTHLY]=cr;Rt.IMPLEMENTED[P.YEARLY]=["byweekno","byyearday"].concat(cr);var cd=function(n,e,t,r){return new Rt(n,e,t,r).toString()},ud=Rt.isFullyConvertible,us=function(){function n(e,t,r,s){this.hour=e,this.minute=t,this.second=r,this.millisecond=s||0}return n.prototype.getHours=function(){return this.hour},n.prototype.getMinutes=function(){return this.minute},n.prototype.getSeconds=function(){return this.second},n.prototype.getMilliseconds=function(){return this.millisecond},n.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},n}(),hd=function(n){xi(e,n);function e(t,r,s,i,a,o,l){var c=n.call(this,i,a,o,l)||this;return c.year=t,c.month=r,c.day=s,c}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return ir(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var r=Math.floor(this.month/12),s=Pe(this.month,12);this.month=s,this.year+=r,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,r){r>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-r))+t*7:this.day+=-(this.getWeekday()-r)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,r,s){for(r&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var i=Ms(this.hour,24),a=i.div,o=i.mod;if(a&&(this.hour=o,this.addDaily(a)),ut(s)||H(s,this.hour))break}},e.prototype.addMinutes=function(t,r,s,i){for(r&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var a=Ms(this.minute,60),o=a.div,l=a.mod;if(o&&(this.minute=l,this.addHours(o,!1,s)),(ut(s)||H(s,this.hour))&&(ut(i)||H(i,this.minute)))break}},e.prototype.addSeconds=function(t,r,s,i,a){for(r&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var o=Ms(this.second,60),l=o.div,c=o.mod;if(l&&(this.second=c,this.addMinutes(l,!1,s,i)),(ut(s)||H(s,this.hour))&&(ut(i)||H(i,this.minute))&&(ut(a)||H(a,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=La(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>fl))return;t=La(this.year,this.month-1)[1]}}},e.prototype.add=function(t,r){var s=t.freq,i=t.interval,a=t.wkst,o=t.byhour,l=t.byminute,c=t.bysecond;switch(s){case P.YEARLY:return this.addYears(i);case P.MONTHLY:return this.addMonths(i);case P.WEEKLY:return this.addWeekly(i,a);case P.DAILY:return this.addDaily(i);case P.HOURLY:return this.addHours(i,r,o);case P.MINUTELY:return this.addMinutes(i,r,o,l);case P.SECONDLY:return this.addSeconds(i,r,o,l,c)}},e}(us);function yl(n){for(var e=[],t=Object.keys(n),r=0,s=t;r<s.length;r++){var i=s[r];H(Pd,i)||e.push(i),vl(n[i])&&!Sr(n[i])&&e.push(i)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return Me({},n)}function fd(n){var e=Me(Me({},Ri),yl(n));if(J(e.byeaster)&&(e.freq=S.YEARLY),!(J(e.freq)&&S.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(n.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),J(e.wkst)?st(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=S.MO.weekday,J(e.bysetpos)){st(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var r=e.bysetpos[t];if(r===0||!(r>=-366&&r<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||se(e.byweekno)||se(e.byyearday)||e.bymonthday||se(e.bymonthday)||J(e.byweekday)||J(e.byeaster)))switch(e.freq){case S.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case S.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case S.WEEKLY:e.byweekday=[ir(e.dtstart)];break}if(J(e.bymonth)&&!Ie(e.bymonth)&&(e.bymonth=[e.bymonth]),J(e.byyearday)&&!Ie(e.byyearday)&&st(e.byyearday)&&(e.byyearday=[e.byyearday]),!J(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(Ie(e.bymonthday)){for(var s=[],i=[],t=0;t<e.bymonthday.length;t++){var r=e.bymonthday[t];r>0?s.push(r):r<0&&i.push(r)}e.bymonthday=s,e.bynmonthday=i}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(J(e.byweekno)&&!Ie(e.byweekno)&&(e.byweekno=[e.byweekno]),!J(e.byweekday))e.bynweekday=null;else if(st(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(Na(e.byweekday))e.byweekday=[ye.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof ye)!e.byweekday.n||e.freq>S.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var a=[],o=[],t=0;t<e.byweekday.length;t++){var l=e.byweekday[t];if(st(l)){a.push(l);continue}else if(Na(l)){a.push(ye.fromStr(l).weekday);continue}!l.n||e.freq>S.MONTHLY?a.push(l.weekday):o.push([l.weekday,l.n])}e.byweekday=se(a)?a:null,e.bynweekday=se(o)?o:null}return J(e.byhour)?st(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<S.HOURLY?[e.dtstart.getUTCHours()]:null,J(e.byminute)?st(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<S.MINUTELY?[e.dtstart.getUTCMinutes()]:null,J(e.bysecond)?st(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<S.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function dd(n){var e=n.dtstart.getTime()%1e3;if(!Ai(n.freq))return[];var t=[];return n.byhour.forEach(function(r){n.byminute.forEach(function(s){n.bysecond.forEach(function(i){t.push(new us(r,s,i,e))})})}),t}function ni(n){var e=n.split(`
`).map(vd).filter(function(t){return t!==null});return Me(Me({},e[0]),e[1])}function hs(n){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(n);if(!t)return e;var r=t[1],s=t[2];return r&&(e.tzid=r),e.dtstart=Di(s),e}function vd(n){if(n=n.replace(/^\s+|\s+$/,""),!n.length)return null;var e=/^([A-Z]+?)[:;]/.exec(n.toUpperCase());if(!e)return Ya(n);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return Ya(n);case"DTSTART":return hs(n);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(n))}}function Ya(n){var e=n.replace(/^RRULE:/i,""),t=hs(e),r=n.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return r.forEach(function(s){var i=s.split("="),a=i[0],o=i[1];switch(a.toUpperCase()){case"FREQ":t.freq=P[o.toUpperCase()];break;case"WKST":t.wkst=qe[o.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var l=pd(o),c=a.toLowerCase();t[c]=l;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=gd(o);break;case"DTSTART":case"TZID":var u=hs(n);t.tzid=u.tzid,t.dtstart=u.dtstart;break;case"UNTIL":t.until=Di(o);break;case"BYEASTER":t.byeaster=Number(o);break;default:throw new Error("Unknown RRULE property '"+a+"'")}}),t}function pd(n){if(n.indexOf(",")!==-1){var e=n.split(",");return e.map(Pa)}return Pa(n)}function Pa(n){return/^[+-]?\d+$/.test(n)?Number(n):n}function gd(n){var e=n.split(",");return e.map(function(t){if(t.length===2)return qe[t];var r=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!r||r.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var s=Number(r[1]),i=r[2],a=qe[i].weekday;return new ye(a,s)})}var fs=function(){function n(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(n.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),n.prototype.toString=function(){var e=Ei(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},n.prototype.getTime=function(){return this.date.getTime()},n.prototype.rezonedDate=function(){return this.isUTC?this.date:sd(this.date,this.tzid)},n}();function ri(n){for(var e=[],t="",r=Object.keys(n),s=Object.keys(Ri),i=0;i<r.length;i++)if(r[i]!=="tzid"&&H(s,r[i])){var a=r[i].toUpperCase(),o=n[r[i]],l="";if(!(!J(o)||Ie(o)&&!o.length)){switch(a){case"FREQ":l=S.FREQUENCIES[n.freq];break;case"WKST":st(o)?l=new ye(o).toString():l=o.toString();break;case"BYWEEKDAY":a="BYDAY",l=Zf(o).map(function(p){return p instanceof ye?p:Ie(p)?new ye(p[0],p[1]):new ye(p)}).toString();break;case"DTSTART":t=md(o,n.tzid);break;case"UNTIL":l=Ei(o,!n.tzid);break;default:if(Ie(o)){for(var c=[],u=0;u<o.length;u++)c[u]=String(o[u]);l=c.toString()}else l=String(o)}l&&e.push([a,l])}}var h=e.map(function(p){var v=p[0],g=p[1];return"".concat(v,"=").concat(g.toString())}).join(";"),f="";return h!==""&&(f="RRULE:".concat(h)),[t,f].filter(function(p){return!!p}).join(`
`)}function md(n,e){return n?"DTSTART"+new fs(new Date(n),e).toString():""}function yd(n,e){return Array.isArray(n)?!Array.isArray(e)||n.length!==e.length?!1:n.every(function(t,r){return t.getTime()===e[r].getTime()}):n instanceof Date?e instanceof Date&&n.getTime()===e.getTime():n===e}var wd=function(){function n(){this.all=!1,this.before=[],this.after=[],this.between=[]}return n.prototype._cacheAdd=function(e,t,r){t&&(t=t instanceof Date?ei(t):$a(t)),e==="all"?this.all=t:(r._value=t,this[e].push(r))},n.prototype._cacheGet=function(e,t){var r=!1,s=t?Object.keys(t):[],i=function(u){for(var h=0;h<s.length;h++){var f=s[h];if(!yd(t[f],u[f]))return!0}return!1},a=this[e];if(e==="all")r=this.all;else if(Ie(a))for(var o=0;o<a.length;o++){var l=a[o];if(!(s.length&&i(l))){r=l._value;break}}if(!r&&this.all){for(var c=new Pn(e,t),o=0;o<this.all.length&&c.accept(this.all[o]);o++);r=c.getValue(),this._cacheAdd(e,r,t)}return Ie(r)?$a(r):r instanceof Date?ei(r):r},n}(),bd=k(k(k(k(k(k(k(k(k(k(k(k(k([],Y(1,31),!0),Y(2,28),!0),Y(3,31),!0),Y(4,30),!0),Y(5,31),!0),Y(6,30),!0),Y(7,31),!0),Y(8,31),!0),Y(9,30),!0),Y(10,31),!0),Y(11,30),!0),Y(12,31),!0),Y(1,7),!0),Td=k(k(k(k(k(k(k(k(k(k(k(k(k([],Y(1,31),!0),Y(2,29),!0),Y(3,31),!0),Y(4,30),!0),Y(5,31),!0),Y(6,30),!0),Y(7,31),!0),Y(8,31),!0),Y(9,30),!0),Y(10,31),!0),Y(11,30),!0),Y(12,31),!0),Y(1,7),!0),kd=dt(1,29),Sd=dt(1,30),Bt=dt(1,31),fe=dt(1,32),_d=k(k(k(k(k(k(k(k(k(k(k(k(k([],fe,!0),Sd,!0),fe,!0),Bt,!0),fe,!0),Bt,!0),fe,!0),fe,!0),Bt,!0),fe,!0),Bt,!0),fe,!0),fe.slice(0,7),!0),Ed=k(k(k(k(k(k(k(k(k(k(k(k(k([],fe,!0),kd,!0),fe,!0),Bt,!0),fe,!0),Bt,!0),fe,!0),fe,!0),Bt,!0),fe,!0),Bt,!0),fe,!0),fe.slice(0,7),!0),Dd=dt(-28,0),xd=dt(-29,0),jt=dt(-30,0),de=dt(-31,0),Ad=k(k(k(k(k(k(k(k(k(k(k(k(k([],de,!0),xd,!0),de,!0),jt,!0),de,!0),jt,!0),de,!0),de,!0),jt,!0),de,!0),jt,!0),de,!0),de.slice(0,7),!0),Rd=k(k(k(k(k(k(k(k(k(k(k(k(k([],de,!0),Dd,!0),de,!0),jt,!0),de,!0),jt,!0),de,!0),de,!0),jt,!0),de,!0),jt,!0),de,!0),de.slice(0,7),!0),Id=[0,31,60,91,121,152,182,213,244,274,305,335,366],Od=[0,31,59,90,120,151,181,212,243,273,304,334,365],Ba=function(){for(var n=[],e=0;e<55;e++)n=n.concat(dt(7));return n}();function Md(n,e){var t=_n(n,1,1),r=Dr(n)?366:365,s=Dr(n+1)?366:365,i=Js(t),a=ir(t),o=Me(Me({yearlen:r,nextyearlen:s,yearordinal:i,yearweekday:a},Cd(n)),{wnomask:null});if(ut(e.byweekno))return o;o.wnomask=Y(0,r+7);var l,c,u=l=Pe(7-a+e.wkst,7);u>=4?(u=0,c=o.yearlen+Pe(a-e.wkst,7)):c=r-u;for(var h=Math.floor(c/7),f=Pe(c,7),p=Math.floor(h+f/4),v=0;v<e.byweekno.length;v++){var g=e.byweekno[v];if(g<0&&(g+=p+1),g>0&&g<=p){var w=void 0;g>1?(w=u+(g-1)*7,u!==l&&(w-=7-l)):w=u;for(var T=0;T<7&&(o.wnomask[w]=1,w++,o.wdaymask[w]!==e.wkst);T++);}}if(H(e.byweekno,1)){var w=u+p*7;if(u!==l&&(w-=7-l),w<r)for(var v=0;v<7&&(o.wnomask[w]=1,w+=1,o.wdaymask[w]!==e.wkst);v++);}if(u){var I=void 0;if(H(e.byweekno,-1))I=-1;else{var D=ir(_n(n-1,1,1)),N=Pe(7-D.valueOf()+e.wkst,7),U=Dr(n-1)?366:365,K=void 0;N>=4?(N=0,K=U+Pe(D-e.wkst,7)):K=r-u,I=Math.floor(52+Pe(K,7)/4)}if(H(e.byweekno,I))for(var w=0;w<u;w++)o.wnomask[w]=1}return o}function Cd(n){var e=Dr(n)?366:365,t=_n(n,1,1),r=ir(t);return e===365?{mmask:bd,mdaymask:Ed,nmdaymask:Rd,wdaymask:Ba.slice(r),mrange:Od}:{mmask:Td,mdaymask:_d,nmdaymask:Ad,wdaymask:Ba.slice(r),mrange:Id}}function Nd(n,e,t,r,s,i){var a={lastyear:n,lastmonth:e,nwdaymask:[]},o=[];if(i.freq===S.YEARLY)if(ut(i.bymonth))o=[[0,t]];else for(var l=0;l<i.bymonth.length;l++)e=i.bymonth[l],o.push(r.slice(e-1,e+1));else i.freq===S.MONTHLY&&(o=[r.slice(e-1,e+1)]);if(ut(o))return a;a.nwdaymask=Y(0,t);for(var l=0;l<o.length;l++)for(var c=o[l],u=c[0],h=c[1]-1,f=0;f<i.bynweekday.length;f++){var p=void 0,v=i.bynweekday[f],g=v[0],w=v[1];w<0?(p=h+(w+1)*7,p-=Pe(s[p]-g,7)):(p=u+(w-1)*7,p+=Pe(7-s[p]+g,7)),u<=p&&p<=h&&(a.nwdaymask[p]=1)}return a}function Ld(n,e){e===void 0&&(e=0);var t=n%19,r=Math.floor(n/100),s=n%100,i=Math.floor(r/4),a=r%4,o=Math.floor((r+8)/25),l=Math.floor((r-o+1)/3),c=Math.floor(19*t+r-i-l+15)%30,u=Math.floor(s/4),h=s%4,f=Math.floor(32+2*a+2*u-c-h)%7,p=Math.floor((t+11*c+22*f)/451),v=Math.floor((c+f-7*p+114)/31),g=(c+f-7*p+114)%31+1,w=Date.UTC(n,v-1,g+e),T=Date.UTC(n,0,1);return[Math.ceil((w-T)/(1e3*60*60*24))]}var $d=function(){function n(e){this.options=e}return n.prototype.rebuild=function(e,t){var r=this.options;if(e!==this.lastyear&&(this.yearinfo=Md(e,r)),se(r.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var s=this.yearinfo,i=s.yearlen,a=s.mrange,o=s.wdaymask;this.monthinfo=Nd(e,t,i,a,o,r)}J(r.byeaster)&&(this.eastermask=Ld(e,r.byeaster))},Object.defineProperty(n.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),n.prototype.ydayset=function(){return[dt(this.yearlen),0,this.yearlen]},n.prototype.mdayset=function(e,t){for(var r=this.mrange[t-1],s=this.mrange[t],i=Y(null,this.yearlen),a=r;a<s;a++)i[a]=a;return[i,r,s]},n.prototype.wdayset=function(e,t,r){for(var s=Y(null,this.yearlen+7),i=Js(_n(e,t,r))-this.yearordinal,a=i,o=0;o<7&&(s[i]=i,++i,this.wdaymask[i]!==this.options.wkst);o++);return[s,a,i]},n.prototype.ddayset=function(e,t,r){var s=Y(null,this.yearlen),i=Js(_n(e,t,r))-this.yearordinal;return s[i]=i,[s,i,i+1]},n.prototype.htimeset=function(e,t,r,s){var i=this,a=[];return this.options.byminute.forEach(function(o){a=a.concat(i.mtimeset(e,o,r,s))}),Rr(a),a},n.prototype.mtimeset=function(e,t,r,s){var i=this.options.bysecond.map(function(a){return new us(e,t,a,s)});return Rr(i),i},n.prototype.stimeset=function(e,t,r,s){return[new us(e,t,r,s)]},n.prototype.getdayset=function(e){switch(e){case P.YEARLY:return this.ydayset.bind(this);case P.MONTHLY:return this.mdayset.bind(this);case P.WEEKLY:return this.wdayset.bind(this);case P.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},n.prototype.gettimeset=function(e){switch(e){case P.HOURLY:return this.htimeset.bind(this);case P.MINUTELY:return this.mtimeset.bind(this);case P.SECONDLY:return this.stimeset.bind(this)}},n}();function Ud(n,e,t,r,s,i){for(var a=[],o=0;o<n.length;o++){var l=void 0,c=void 0,u=n[o];u<0?(l=Math.floor(u/e.length),c=Pe(u,e.length)):(l=Math.floor((u-1)/e.length),c=Pe(u-1,e.length));for(var h=[],f=t;f<r;f++){var p=i[f];J(p)&&h.push(p)}var v=void 0;l<0?v=h.slice(l)[0]:v=h[l];var g=e[c],w=pl(s.yearordinal+v),T=gl(w,g);H(a,T)||a.push(T)}return Rr(a),a}function wl(n,e){var t=e.dtstart,r=e.freq,s=e.interval,i=e.until,a=e.bysetpos,o=e.count;if(o===0||s===0)return yt(n);var l=hd.fromDate(t),c=new $d(e);c.rebuild(l.year,l.month);for(var u=Yd(c,l,e);;){var h=c.getdayset(r)(l.year,l.month,l.day),f=h[0],p=h[1],v=h[2],g=Fd(f,p,v,c,e);if(se(a))for(var w=Ud(a,u,p,v,c,f),T=0;T<w.length;T++){var I=w[T];if(i&&I>i)return yt(n);if(I>=t){var D=ja(I,e);if(!n.accept(D)||o&&(--o,!o))return yt(n)}}else for(var T=p;T<v;T++){var N=f[T];if(J(N))for(var U=pl(c.yearordinal+N),K=0;K<u.length;K++){var j=u[K],I=gl(U,j);if(i&&I>i)return yt(n);if(I>=t){var D=ja(I,e);if(!n.accept(D)||o&&(--o,!o))return yt(n)}}}if(e.interval===0||(l.add(e,g),l.year>fl))return yt(n);Ai(r)||(u=c.gettimeset(r)(l.hour,l.minute,l.second,0)),c.rebuild(l.year,l.month)}}function zd(n,e,t){var r=t.bymonth,s=t.byweekno,i=t.byweekday,a=t.byeaster,o=t.bymonthday,l=t.bynmonthday,c=t.byyearday;return se(r)&&!H(r,n.mmask[e])||se(s)&&!n.wnomask[e]||se(i)&&!H(i,n.wdaymask[e])||se(n.nwdaymask)&&!n.nwdaymask[e]||a!==null&&!H(n.eastermask,e)||(se(o)||se(l))&&!H(o,n.mdaymask[e])&&!H(l,n.nmdaymask[e])||se(c)&&(e<n.yearlen&&!H(c,e+1)&&!H(c,-n.yearlen+e)||e>=n.yearlen&&!H(c,e+1-n.yearlen)&&!H(c,-n.nextyearlen+e-n.yearlen))}function ja(n,e){return new fs(n,e.tzid).rezonedDate()}function yt(n){return n.getValue()}function Fd(n,e,t,r,s){for(var i=!1,a=e;a<t;a++){var o=n[a];i=zd(r,o,s),i&&(n[o]=null)}return i}function Yd(n,e,t){var r=t.freq,s=t.byhour,i=t.byminute,a=t.bysecond;return Ai(r)?dd(t):r>=S.HOURLY&&se(s)&&!H(s,e.hour)||r>=S.MINUTELY&&se(i)&&!H(i,e.minute)||r>=S.SECONDLY&&se(a)&&!H(a,e.second)?[]:n.gettimeset(r)(e.hour,e.minute,e.second,e.millisecond)}var qe={MO:new ye(0),TU:new ye(1),WE:new ye(2),TH:new ye(3),FR:new ye(4),SA:new ye(5),SU:new ye(6)},Ri={freq:P.YEARLY,dtstart:null,interval:1,wkst:qe.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},Pd=Object.keys(Ri),S=function(){function n(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new wd,this.origOptions=yl(e);var r=fd(e).parsedOptions;this.options=r}return n.parseText=function(e,t){return ml(e,t)},n.fromText=function(e,t){return ld(e,t)},n.fromString=function(e){return new n(n.parseString(e)||void 0)},n.prototype._iter=function(e){return wl(e,this.options)},n.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},n.prototype._cacheAdd=function(e,t,r){if(this._cache)return this._cache._cacheAdd(e,t,r)},n.prototype.all=function(e){if(e)return this._iter(new za("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Pn("all",{})),this._cacheAdd("all",t)),t},n.prototype.between=function(e,t,r,s){if(r===void 0&&(r=!1),!Sr(e)||!Sr(t))throw new Error("Invalid date passed in to RRule.between");var i={before:t,after:e,inc:r};if(s)return this._iter(new za("between",i,s));var a=this._cacheGet("between",i);return a===!1&&(a=this._iter(new Pn("between",i)),this._cacheAdd("between",a,i)),a},n.prototype.before=function(e,t){if(t===void 0&&(t=!1),!Sr(e))throw new Error("Invalid date passed in to RRule.before");var r={dt:e,inc:t},s=this._cacheGet("before",r);return s===!1&&(s=this._iter(new Pn("before",r)),this._cacheAdd("before",s,r)),s},n.prototype.after=function(e,t){if(t===void 0&&(t=!1),!Sr(e))throw new Error("Invalid date passed in to RRule.after");var r={dt:e,inc:t},s=this._cacheGet("after",r);return s===!1&&(s=this._iter(new Pn("after",r)),this._cacheAdd("after",s,r)),s},n.prototype.count=function(){return this.all().length},n.prototype.toString=function(){return ri(this.origOptions)},n.prototype.toText=function(e,t,r){return cd(this,e,t,r)},n.prototype.isFullyConvertibleToText=function(){return ud(this)},n.prototype.clone=function(){return new n(this.origOptions)},n.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],n.YEARLY=P.YEARLY,n.MONTHLY=P.MONTHLY,n.WEEKLY=P.WEEKLY,n.DAILY=P.DAILY,n.HOURLY=P.HOURLY,n.MINUTELY=P.MINUTELY,n.SECONDLY=P.SECONDLY,n.MO=qe.MO,n.TU=qe.TU,n.WE=qe.WE,n.TH=qe.TH,n.FR=qe.FR,n.SA=qe.SA,n.SU=qe.SU,n.parseString=ni,n.optionsToString=ri,n}();function Bd(n,e,t,r,s,i){var a={},o=n.accept;function l(f,p){t.forEach(function(v){v.between(f,p,!0).forEach(function(g){a[Number(g)]=!0})})}s.forEach(function(f){var p=new fs(f,i).rezonedDate();a[Number(p)]=!0}),n.accept=function(f){var p=Number(f);return isNaN(p)?o.call(this,f):!a[p]&&(l(new Date(p-1),new Date(p+1)),!a[p])?(a[p]=!0,o.call(this,f)):!0},n.method==="between"&&(l(n.args.after,n.args.before),n.accept=function(f){var p=Number(f);return a[p]?!0:(a[p]=!0,o.call(this,f))});for(var c=0;c<r.length;c++){var u=new fs(r[c],i).rezonedDate();if(!n.accept(new Date(u.getTime())))break}e.forEach(function(f){wl(n,f.options)});var h=n._result;switch(Rr(h),n.method){case"all":case"between":return h;case"before":return h.length&&h[h.length-1]||null;case"after":default:return h.length&&h[0]||null}}var Ha={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function jd(n,e){var t=[],r=[],s=[],i=[],a=hs(n),o=a.dtstart,l=a.tzid,c=Gd(n,e.unfold);return c.forEach(function(u){var h;if(u){var f=qd(u),p=f.name,v=f.parms,g=f.value;switch(p.toUpperCase()){case"RRULE":if(v.length)throw new Error("unsupported RRULE parm: ".concat(v.join(",")));t.push(ni(u));break;case"RDATE":var w=(h=/RDATE(?:;TZID=([^:=]+))?/i.exec(u))!==null&&h!==void 0?h:[],T=w[1];T&&!l&&(l=T),r=r.concat(Wa(g,v));break;case"EXRULE":if(v.length)throw new Error("unsupported EXRULE parm: ".concat(v.join(",")));s.push(ni(g));break;case"EXDATE":i=i.concat(Wa(g,v));break;case"DTSTART":break;default:throw new Error("unsupported property: "+p)}}}),{dtstart:o,tzid:l,rrulevals:t,rdatevals:r,exrulevals:s,exdatevals:i}}function Hd(n,e){var t=jd(n,e),r=t.rrulevals,s=t.rdatevals,i=t.exrulevals,a=t.exdatevals,o=t.dtstart,l=t.tzid,c=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||r.length>1||s.length||i.length||a.length){var u=new Tn(c);return u.dtstart(o),u.tzid(l||void 0),r.forEach(function(f){u.rrule(new S(Cs(f,o,l),c))}),s.forEach(function(f){u.rdate(f)}),i.forEach(function(f){u.exrule(new S(Cs(f,o,l),c))}),a.forEach(function(f){u.exdate(f)}),e.compatible&&e.dtstart&&u.rdate(o),u}var h=r[0]||{};return new S(Cs(h,h.dtstart||e.dtstart||o,h.tzid||e.tzid||l),c)}function St(n,e){return e===void 0&&(e={}),Hd(n,Wd(e))}function Cs(n,e,t){return Me(Me({},n),{dtstart:e,tzid:t})}function Wd(n){var e=[],t=Object.keys(n),r=Object.keys(Ha);if(t.forEach(function(s){H(r,s)||e.push(s)}),e.length)throw new Error("Invalid options: "+e.join(", "));return Me(Me({},Ha),n)}function Kd(n){if(n.indexOf(":")===-1)return{name:"RRULE",value:n};var e=Jf(n,":",1),t=e[0],r=e[1];return{name:t,value:r}}function qd(n){var e=Kd(n),t=e.name,r=e.value,s=t.split(";");if(!s)throw new Error("empty property name");return{name:s[0].toUpperCase(),parms:s.slice(1),value:r}}function Gd(n,e){if(e===void 0&&(e=!1),n=n&&n.trim(),!n)throw new Error("Invalid empty string");if(!e)return n.split(/\s/);for(var t=n.split(`
`),r=0;r<t.length;){var s=t[r]=t[r].replace(/\s+$/g,"");s?r>0&&s[0]===" "?(t[r-1]+=s.slice(1),t.splice(r,1)):r+=1:t.splice(r,1)}return t}function Qd(n){n.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function Wa(n,e){return Qd(e),n.split(",").map(function(t){return Di(t)})}function Ka(n){var e=this;return function(t){if(t!==void 0&&(e["_".concat(n)]=t),e["_".concat(n)]!==void 0)return e["_".concat(n)];for(var r=0;r<e._rrule.length;r++){var s=e._rrule[r].origOptions[n];if(s)return s}}}var Tn=function(n){xi(e,n);function e(t){t===void 0&&(t=!1);var r=n.call(this,{},t)||this;return r.dtstart=Ka.apply(r,["dtstart"]),r.tzid=Ka.apply(r,["tzid"]),r._rrule=[],r._rdate=[],r._exrule=[],r._exdate=[],r}return e.prototype._iter=function(t){return Bd(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){qa(t,this._rrule)},e.prototype.exrule=function(t){qa(t,this._exrule)},e.prototype.rdate=function(t){Ga(t,this._rdate)},e.prototype.exdate=function(t){Ga(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return St(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return St(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(ri({dtstart:this._dtstart}))),this._rrule.forEach(function(r){t=t.concat(r.toString().split(`
`))}),this._exrule.forEach(function(r){t=t.concat(r.toString().split(`
`).map(function(s){return s.replace(/^RRULE:/,"EXRULE:")}).filter(function(s){return!/^DTSTART/.test(s)}))}),this._rdate.length&&t.push(Qa("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(Qa("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(r){return t.rrule(r.clone())}),this._exrule.forEach(function(r){return t.exrule(r.clone())}),this._rdate.forEach(function(r){return t.rdate(new Date(r.getTime()))}),this._exdate.forEach(function(r){return t.exdate(new Date(r.getTime()))}),t},e}(S);function qa(n,e){if(!(n instanceof S))throw new TypeError(String(n)+" is not RRule instance");H(e.map(String),String(n))||e.push(n)}function Ga(n,e){if(!(n instanceof Date))throw new TypeError(String(n)+" is not Date instance");H(e.map(Number),Number(n))||(e.push(n),Rr(e))}function Qa(n,e,t){var r=!t||t.toUpperCase()==="UTC",s=r?"".concat(n,":"):"".concat(n,";TZID=").concat(t,":"),i=e.map(function(a){return Ei(a.valueOf(),r)}).join(",");return"".concat(s).concat(i)}function bl(n){const e=n.startsWith("RRULE:")?n:`RRULE:${n}`,t=St(e);if(t instanceof S)return{...t.origOptions};if(t instanceof Tn){const r=t.rrules();if(r&&r.length>0)return{...r[0].origOptions};throw new Error("RRuleSet has no rrules")}else throw new Error("Unexpected parsed rule type")}function Xd(n,e){return`${encodeURIComponent(n)}::${encodeURIComponent(e)}`}class Vd{constructor(e=1e3){y(this,"cache",new Map);y(this,"maxSize");y(this,"totalHits",0);y(this,"totalMisses",0);if(e<1)throw new Error("Cache maxSize must be at least 1");this.maxSize=e}getOrParse(e,t,r,s){const i=this.cache.get(e);if(i)return this.totalHits++,i.hits++,i.lastAccess=Date.now(),this.cache.delete(e),this.cache.set(e,i),i.rrule;this.totalMisses++;const a=this.parseRRule(t,r,s);return this.set(e,a),a}parseRRule(e,t,r){try{const s=bl(e);return s.dtstart=t,r&&(s.tzid=r),new S(s)}catch(s){throw A("Failed to parse RRULE",{rruleString:e,error:s instanceof Error?s.message:String(s)}),s}}set(e,t){this.cache.size>=this.maxSize&&this.evictOldest();const r={rrule:t,key:e,hits:0,lastAccess:Date.now(),createdAt:Date.now()};this.cache.set(e,r)}evictOldest(){const e=this.cache.keys().next().value;e!==void 0&&this.cache.delete(e)}invalidate(e){return this.cache.delete(e)}invalidateTask(e){let t=0;const r=[];for(const s of this.cache.keys())s.startsWith(`${e}:`)&&r.push(s);for(const s of r)this.cache.delete(s)&&t++;return t}clear(){this.cache.clear(),this.totalHits=0,this.totalMisses=0}getStats(){const e=this.totalHits+this.totalMisses,t=e>0?this.totalHits/e:0;return{size:this.cache.size,maxSize:this.maxSize,hitRate:t,totalHits:this.totalHits,totalMisses:this.totalMisses}}get size(){return this.cache.size}has(e){return this.cache.has(e)}getEntry(e){return this.cache.get(e)}keys(){return Array.from(this.cache.keys())}pruneOld(e){const t=Date.now();let r=0;const s=[];for(const[i,a]of this.cache.entries())t-a.lastAccess>e&&s.push(i);for(const i of s)this.cache.delete(i)&&r++;return r>0&&ki("Pruned old cache entries",{pruned:r,maxAgeMs:e}),r}}class Zd{validate(e,t,r){const s=[],i=[];if(!e||typeof e!="string")return s.push("RRULE string is required"),{valid:!1,errors:s,warnings:i};if(!t||!(t instanceof Date)||isNaN(t.getTime()))return s.push("Valid DTSTART date is required"),{valid:!1,errors:s,warnings:i};try{const a=bl(e);if(a.dtstart=t,a.count!==void 0&&a.count!==null&&a.until!==void 0&&a.until!==null&&s.push("Cannot specify both COUNT and UNTIL in the same rule"),a.until&&t>a.until&&s.push(`DTSTART (${t.toISOString()}) is after UNTIL (${a.until.toISOString()})`),a.bymonthday&&a.bymonth){const c=this.validateMonthDayCombinations(a.bymonthday,a.bymonth);c.length>0&&i.push(...c)}return a.count!==void 0&&a.count!==null&&a.count<1&&s.push("COUNT must be at least 1"),a.interval!==void 0&&a.interval!==null&&a.interval<1&&s.push("INTERVAL must be at least 1"),r&&a.tzid&&r!==a.tzid&&i.push(`Timezone mismatch: task timezone (${r}) differs from RRULE timezone (${a.tzid})`),new S(a).after(t,!0)||(a.until&&a.until<new Date?i.push("Rule has expired (UNTIL date is in the past)"):a.count===0?s.push("Rule with COUNT=0 will never generate occurrences"):i.push("Rule may not generate any valid occurrences")),this.validateSpecificPatterns(a,i),{valid:s.length===0,errors:s,warnings:i}}catch(a){const o=a instanceof Error?a.message:"Invalid RRULE format";return s.push(o),A("RRULE validation failed",{rruleString:e,error:o}),{valid:!1,errors:s,warnings:i}}}validateMonthDayCombinations(e,t){const r=[],s=Array.isArray(e)?e:[e],i=Array.isArray(t)?t:[t],a=[31,28,31,30,31,30,31,31,30,31,30,31];for(const o of i){const l=o-1;if(l<0||l>11)continue;const c=a[l];for(const u of s)if(!(u<0)&&u>c){const h=["January","February","March","April","May","June","July","August","September","October","November","December"];r.push(`Day ${u} does not exist in ${h[l]} (max ${c} days)`)}}return r}validateSpecificPatterns(e,t){(e.freq===S.HOURLY||e.freq===S.MINUTELY||e.freq===S.SECONDLY)&&t.push("High-frequency rules (hourly/minutely/secondly) may cause performance issues"),e.count&&e.count>1e3&&t.push(`High COUNT value (${e.count}) may cause performance issues`),e.freq===S.MONTHLY&&e.byweekday&&!e.bysetpos&&t.push("MONTHLY with BYDAY but no BYSETPOS may produce unexpected results")}validateSyntax(e){if(!e||typeof e!="string")return!1;try{const t=e.startsWith("RRULE:")?e:`RRULE:${e}`;return St(t),!0}catch{return!1}}isExpired(e,t,r=new Date){try{const s=e.startsWith("RRULE:")?e:`RRULE:${e}`,i=St(s);let a;if(i instanceof S)a={...i.origOptions};else if(i instanceof Tn){const c=i.rrules();if(c&&c.length>0)a={...c[0].origOptions};else return!0}else return!1;return a.dtstart=t,new S(a).after(r,!1)===null}catch{return!1}}}function xr(){return Intl.DateTimeFormat().resolvedOptions().timeZone}class Jd{explain(e,t,r,s){var p,v,g;const i=[],a=[];let o=1;const l=this.getRecurrenceMode(e);i.push({step:o++,description:`Recurrence mode: ${l}`,value:l==="whenDone"?"Schedule slides based on completion date":"Schedule is fixed to DTSTART + rule"}),i.push({step:o++,description:"Reference date",value:t.toISOString()});const c=r.origOptions,u=((p=e.frequency)==null?void 0:p.rruleString)||"";i.push({step:o++,description:"RRULE string",value:u}),c.dtstart&&i.push({step:o++,description:"DTSTART (series start date)",value:c.dtstart.toISOString()});const h=this.getFrequencyName(c.freq);if(i.push({step:o++,description:"Frequency",value:`${h}${c.interval&&c.interval>1?` (every ${c.interval})`:""}`}),c.byweekday){const w=this.formatWeekdays(c.byweekday);i.push({step:o++,description:"By weekday",value:w})}if(c.bymonthday&&i.push({step:o++,description:"By month day",value:Array.isArray(c.bymonthday)?c.bymonthday.join(", "):String(c.bymonthday)}),c.bymonth){const w=this.formatMonths(c.bymonth);i.push({step:o++,description:"By month",value:w})}c.until&&(i.push({step:o++,description:"UNTIL (series ends)",value:c.until.toISOString()}),c.until<t&&a.push("Series has ended (UNTIL date is before reference date)")),c.count&&i.push({step:o++,description:"COUNT (max occurrences)",value:String(c.count)});const f=c.tzid||((v=e.frequency)==null?void 0:v.timezone)||e.timezone||xr();return i.push({step:o++,description:"Timezone",value:f}),i.push({step:o++,description:"Calculate next occurrence after reference date",value:s?`Next occurrence: ${s.toISOString()}`:"No next occurrence (series ended or invalid)"}),(g=e.frequency)!=null&&g.time&&s&&i.push({step:o++,description:"Apply fixed time",value:`Time set to ${e.frequency.time}`}),s===null?(i.push({step:o++,description:"Result",value:"Series has ended or no valid occurrence found"}),a.some(w=>w.includes("ended"))||a.push("No future occurrences available")):i.push({step:o++,description:"Result",value:`Next due date: ${s.toISOString()}`}),{taskId:e.id,referenceDate:t.toISOString(),rule:u,mode:l,resultDate:s?s.toISOString():null,evaluationSteps:i,timezone:f,warnings:a}}explainDate(e,t,r){const s=[],i=new Date(t);i.setHours(0,0,0,0);const a=new Date(t);a.setHours(23,59,59,999);const o=r.between(i,a,!0);if(o.length>0)s.push(`? ${t.toISOString()} IS a valid occurrence`),s.push(`  Matched ${o.length} time(s) on this date`),o.forEach((l,c)=>{s.push(`  [${c+1}] ${l.toISOString()}`)});else{s.push(`? ${t.toISOString()} is NOT a valid occurrence`);const l=r.origOptions;if(l.dtstart&&t<l.dtstart)s.push(`  Reason: Date is before DTSTART (${l.dtstart.toISOString()})`);else if(l.until&&t>l.until)s.push(`  Reason: Date is after UNTIL (${l.until.toISOString()})`);else if(l.byweekday){const c=t.getDay();s.push(`  Reason: Day of week (${this.getDayName(c)}) not in BYDAY constraint`)}else s.push("  Reason: Date does not match the RRULE pattern")}return s.join(`
`)}summarize(e,t){try{const r=e.startsWith("RRULE:")?e:`RRULE:${e}`,s=St(r);let i;if(s instanceof S)i=s;else if(s instanceof Tn){const l=s.rrules();if(l&&l.length>0)i=l[0];else return"Invalid RRuleSet"}else return"Unknown rule type";const a={...i.origOptions};return t&&!a.dtstart&&(a.dtstart=t),new S(a).toText()}catch(r){return A("Failed to summarize RRULE",{rruleString:e,error:r instanceof Error?r.message:String(r)}),e}}getRecurrenceMode(e){var r;return((r=e.frequency)==null?void 0:r.whenDone)??e.whenDone??!1?"whenDone":"fixed"}getFrequencyName(e){return{[S.YEARLY]:"YEARLY",[S.MONTHLY]:"MONTHLY",[S.WEEKLY]:"WEEKLY",[S.DAILY]:"DAILY",[S.HOURLY]:"HOURLY",[S.MINUTELY]:"MINUTELY",[S.SECONDLY]:"SECONDLY"}[e]||`Unknown(${e})`}formatWeekdays(e){const t=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];return Array.isArray(e)?e.map(r=>{if(typeof r=="number")return t[r]||`Day ${r}`;if(r&&typeof r=="object"&&"weekday"in r){const s=t[r.weekday]||`Day ${r.weekday}`;return r.n?`${r.n>0?"+":""}${r.n} ${s}`:s}return String(r)}).join(", "):String(e)}formatMonths(e){const t=["January","February","March","April","May","June","July","August","September","October","November","December"];return Array.isArray(e)?e.map(r=>t[r-1]||`Month ${r}`).join(", "):t[e-1]||`Month ${e}`}getDayName(e){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e]||`Day ${e}`}}const Xa=500,ev=100;class tv{constructor(e=1e3){y(this,"cache");y(this,"validator");y(this,"explainer");this.cache=new Vd(e),this.validator=new Zd,this.explainer=new Jd}next(e,t){var r;if(!((r=e.frequency)!=null&&r.rruleString))return W("Task has no RRULE string",{taskId:e.id}),null;try{const s=this.getRRule(e),i=this.getBaseDate(e,t),a=s.after(i,!1);return a?this.applyFixedTime(a,e):(ki("No next occurrence found",{taskId:e.id,baseDate:i.toISOString()}),null)}catch(s){return A("Failed to calculate next occurrence",{taskId:e.id,error:s instanceof Error?s.message:String(s)}),null}}preview(e,t,r){var i;if(!((i=e.frequency)!=null&&i.rruleString))return W("Task has no RRULE string",{taskId:e.id}),[];const s=Math.min(r,Xa);r>Xa&&W("Preview limit capped",{taskId:e.id,requested:r,capped:s});try{const a=this.getRRule(e),o=new Date(t.getTime()+365*24*60*60*1e3*10);return a.between(t,o,!1).slice(0,s).map(c=>this.applyFixedTime(c,e))}catch(a){return A("Failed to generate preview",{taskId:e.id,from:t.toISOString(),limit:s,error:a instanceof Error?a.message:String(a)}),[]}}between(e,t,r){var s;if(!((s=e.frequency)!=null&&s.rruleString))return W("Task has no RRULE string",{taskId:e.id}),[];try{return this.getRRule(e).between(t,r,!0).map(o=>this.applyFixedTime(o,e))}catch(i){return A("Failed to get occurrences between dates",{taskId:e.id,from:t.toISOString(),to:r.toISOString(),error:i instanceof Error?i.message:String(i)}),[]}}isValid(e,t){return this.validator.validate(e,t)}explain(e,t){var r;if(!((r=e.frequency)!=null&&r.rruleString))return{taskId:e.id,referenceDate:t.toISOString(),rule:"",mode:"fixed",resultDate:null,evaluationSteps:[{step:1,description:"Task has no RRULE string",value:"Cannot calculate recurrence"}],timezone:e.timezone||xr(),warnings:["Task has no RRULE configured"]};try{const s=this.getRRule(e),i=this.getBaseDate(e,t),a=s.after(i,!1),o=a?this.applyFixedTime(a,e):null;return this.explainer.explain(e,t,s,o)}catch(s){return A("Failed to generate explanation",{taskId:e.id,error:s instanceof Error?s.message:String(s)}),{taskId:e.id,referenceDate:t.toISOString(),rule:e.frequency.rruleString||"",mode:"fixed",resultDate:null,evaluationSteps:[{step:1,description:"Error occurred",value:s instanceof Error?s.message:"Unknown error"}],timezone:e.timezone||xr(),warnings:["Failed to calculate recurrence"]}}}getMissedOccurrences(e,t,r,s){var l;const i=(s==null?void 0:s.policy)||"skip",a=(s==null?void 0:s.maxMissed)||ev,o=[];if(i==="skip")return{missedDates:[],count:0,limitReached:!1,warnings:["Skip policy: missed occurrences are not tracked"]};if(!((l=e.frequency)!=null&&l.rruleString))return{missedDates:[],count:0,limitReached:!1,warnings:["Task has no RRULE configured"]};try{const u=this.between(e,t,r).filter(p=>p<r);let h=!1,f=u;if(u.length>a&&(h=!0,f=u.slice(0,a),o.push(`Limit reached: ${u.length} missed, returning first ${a}`)),s!=null&&s.onMissedOccurrence)for(const p of f)try{s.onMissedOccurrence(e.id,p)}catch(v){A("Error in onMissedOccurrence callback",{taskId:e.id,date:p.toISOString(),error:v instanceof Error?v.message:String(v)})}return{missedDates:f,count:u.length,limitReached:h,warnings:o}}catch(c){return A("Failed to calculate missed occurrences",{taskId:e.id,error:c instanceof Error?c.message:String(c)}),{missedDates:[],count:0,limitReached:!1,warnings:["Failed to calculate missed occurrences"]}}}getRRule(e){var i,a;const t=Xd(e.id,e.frequency.rruleString),r=(i=e.frequency)!=null&&i.dtstart?new Date(e.frequency.dtstart):new Date(e.dueAt),s=((a=e.frequency)==null?void 0:a.timezone)||e.timezone||xr();return this.cache.getOrParse(t,e.frequency.rruleString,r,s)}getBaseDate(e,t){var s;return((s=e.frequency)==null?void 0:s.whenDone)??e.whenDone??!1,t}applyFixedTime(e,t){var r;if(!((r=t.frequency)!=null&&r.time))return e;try{const s=t.frequency.time.split(":").map(Number),i=s[0],a=s[1];if(i===void 0||a===void 0||!Number.isFinite(i)||!Number.isFinite(a))return e;const o=new Date(e);return o.setHours(i,a,0,0),o}catch(s){return W("Failed to apply fixed time",{taskId:t.id,time:t.frequency.time,error:s instanceof Error?s.message:String(s)}),e}}clearCache(){this.cache.clear()}getCacheStats(){return this.cache.getStats()}invalidateTask(e){return this.cache.invalidateTask(e)}isOccurrenceOn(e,t){var r;if(!((r=e.frequency)!=null&&r.rruleString))return!1;try{const s=this.getRRule(e),i=new Date(t);i.setHours(0,0,0,0);const a=new Date(t);return a.setHours(23,59,59,999),s.between(i,a,!0).length>0}catch(s){return A("Failed to check if date is occurrence",{taskId:e.id,date:t.toISOString(),error:s instanceof Error?s.message:String(s)}),!1}}toNaturalLanguage(e,t){return this.explainer.summarize(e,t)}}class nv{constructor(){y(this,"rruleCache",new Map);y(this,"legacyTaskCounter",0)}getNextOccurrence(e,t){var r;if(!((r=e.frequency)!=null&&r.rruleString))return W("Task has no RRULE string",{taskId:e.id}),null;try{const s=this.getRRule(e),i=this.getBaseDate(e,t),a=s.after(i,!1);return a?this.applyFixedTime(a,e.frequency):null}catch(s){return A("Failed to get next occurrence",{taskId:e.id,error:s instanceof Error?s.message:String(s)}),null}}getOccurrencesBetween(e,t,r){var s;if(!((s=e.frequency)!=null&&s.rruleString))return W("Task has no RRULE string",{taskId:e.id}),[];try{return this.getRRule(e).between(t,r,!0).map(o=>this.applyFixedTime(o,e.frequency))}catch(i){return A("Failed to get occurrences between dates",{taskId:e.id,from:t.toISOString(),to:r.toISOString(),error:i instanceof Error?i.message:String(i)}),[]}}isOccurrenceOn(e,t){var r;if(!((r=e.frequency)!=null&&r.rruleString))return!1;try{const s=this.getRRule(e),i=new Date(t);i.setHours(0,0,0,0);const a=new Date(t);return a.setHours(23,59,59,999),s.between(i,a,!0).length>0}catch(s){return A("Failed to check if date is occurrence",{taskId:e.id,date:t.toISOString(),error:s instanceof Error?s.message:String(s)}),!1}}validateRRule(e){if(!e||typeof e!="string")return{valid:!1,error:"RRULE string is required"};try{const t=e.startsWith("RRULE:")?e:`RRULE:${e}`,r=St(t);let s;if(r instanceof Tn){const l=r.rrules();if(l&&l.length>0)s={...l[0].origOptions};else return{valid:!1,error:"RRuleSet has no rrules"}}else if(r instanceof S)s={...r.origOptions};else return{valid:!1,error:"Unexpected parsed rule type"};s.dtstart||(s.dtstart=new Date);const i=new S(s),a=new Date;if(!i.after(a,!0)){if(s.until&&s.until<a)return{valid:!1,error:"RRULE has expired (UNTIL date is in the past)"};if(s.count&&s.count===0)return{valid:!1,error:"RRULE COUNT is 0"}}return{valid:!0}}catch(t){return{valid:!1,error:t instanceof Error?t.message:"Invalid RRULE format"}}}toNaturalLanguage(e){if(!e)return"";try{const t=e.startsWith("RRULE:")?e:`RRULE:${e}`,r=St(t);let s;if(r instanceof Tn){const a=r.rrules();if(a&&a.length>0)s=a[0].origOptions;else return e}else if(r instanceof S)s=r.origOptions;else return e;return s.dtstart||(s={...s,dtstart:new Date}),new S(s).toText()}catch(t){return A("Failed to convert RRULE to natural language",{rruleString:e,error:t instanceof Error?t.message:String(t)}),e}}getRRule(e){const t=`${e.id}:${e.frequency.rruleString}`;let r=this.rruleCache.get(t);if(r)return r;const s=e.frequency.rruleString,i=s.startsWith("RRULE:")?s:`RRULE:${s}`,a=St(i);let o;if(a instanceof Tn){const c=a.rrules();if(c&&c.length>0)o={...c[0].origOptions};else throw new Error("RRuleSet has no rrules")}else if(a instanceof S)o={...a.origOptions};else throw new Error("Unexpected parsed rule type");e.frequency.dtstart?o.dtstart=new Date(e.frequency.dtstart):e.dueAt&&(o.dtstart=new Date(e.dueAt));const l=e.frequency.timezone||e.timezone||xr();return o.tzid=l,r=new S(o),this.rruleCache.set(t,r),r}getBaseDate(e,t){return e.frequency.whenDone??e.whenDone??!1,t}applyFixedTime(e,t){if(!t.time)return e;try{const r=t.time.split(":").map(Number),s=r[0],i=r[1];if(s==null||i==null||!Number.isFinite(s)||!Number.isFinite(i))return e;const a=new Date(e);return a.setHours(s,i,0,0),a}catch(r){return W("Failed to apply fixed time",{time:t.time,error:r instanceof Error?r.message:String(r)}),e}}clearCache(){this.rruleCache.clear()}getCacheSize(){return this.rruleCache.size}legacyFrequencyToRRule(e,t){const r=["daily","weekly","monthly","yearly"];if(!r.includes(e.type.toLowerCase()))throw new Error(`Invalid frequency type: ${e.type}. Must be one of: ${r.join(", ")}`);const s=e.type.toUpperCase(),i=e.interval||1,a=[`FREQ=${s}`,`INTERVAL=${i}`];if(e.type==="weekly"&&e.weekdays&&e.weekdays.length>0){const o=["MO","TU","WE","TH","FR","SA","SU"],l=e.weekdays.map(c=>o[c]).join(",");a.push(`BYDAY=${l}`)}return e.type==="monthly"&&e.dayOfMonth&&(e.dayOfMonth===31?a.push("BYMONTHDAY=-1"):e.dayOfMonth===30?a.push("BYMONTHDAY=30,-1"):e.dayOfMonth===29?a.push("BYMONTHDAY=29,-1"):a.push(`BYMONTHDAY=${e.dayOfMonth}`)),e.type==="yearly"&&(e.month!==void 0&&a.push(`BYMONTH=${e.month+1}`),e.dayOfMonth&&(e.dayOfMonth===31?a.push("BYMONTHDAY=-1"):e.dayOfMonth===30?a.push("BYMONTHDAY=30,-1"):e.dayOfMonth===29?a.push("BYMONTHDAY=29,-1"):a.push(`BYMONTHDAY=${e.dayOfMonth}`))),`RRULE:${a.join(";")}`}createLegacyTask(e,t,r){return{id:this.nextLegacyId(),name:`legacy-frequency-${e.type}`,frequency:e,dueAt:t.toISOString(),createdAt:t.toISOString(),enabled:!0,whenDone:(r==null?void 0:r.whenDone)??e.whenDone??!1,timezone:(r==null?void 0:r.timezone)||e.timezone||void 0}}calculateNext(e,t,r){const s={...t};s.rruleString||(s.rruleString=this.legacyFrequencyToRRule(s,e),s.dtstart=e.toISOString());const i=this.createLegacyTask(s,e,r),o=((r==null?void 0:r.whenDone)??t.whenDone??!1)&&(r!=null&&r.completionDate)?r.completionDate:e,l=this.getNextOccurrence(i,o);return l||(F("RecurrenceEngineRRULE.calculateNext: RRULE series exhausted, no more occurrences"),null)}getOccurrencesInRange(e,t,r,s){const i={...r};i.rruleString||(i.rruleString=this.legacyFrequencyToRRule(i,s),i.dtstart=s.toISOString());const a=this.createLegacyTask(i,s);return this.getOccurrencesBetween(a,e,t)}getMissedOccurrences(e,t,r,s){if(e>=t)return[];const i={...r};i.rruleString||(i.rruleString=this.legacyFrequencyToRRule(i,s),i.dtstart=s.toISOString());const a=this.createLegacyTask(i,s),o=this.getOccurrencesBetween(a,e,t).filter(l=>l>e&&l<t);return o.length>Xs?o.slice(0,Xs):o}nextLegacyId(){return this.legacyTaskCounter+=1,`legacy-${Date.now()}-${this.legacyTaskCounter}`}}function rv(n){if(!n||typeof n!="string")throw new Error("Time string is required and must be a string");const e=n.split(":");if(e.length!==2)throw new Error(`Invalid time format: ${n}. Expected HH:mm`);const t=Number(e[0]),r=Number(e[1]);if(isNaN(t)||isNaN(r))throw new Error(`Invalid time values in: ${n}`);if(t<0||t>23)throw new Error(`Hours must be between 0 and 23, got: ${t}`);if(r<0||r>59)throw new Error(`Minutes must be between 0 and 59, got: ${r}`);return{hours:t,minutes:r}}class sv{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toTimezone(e,t){if(!t)return new Date(e);try{const s=new Intl.DateTimeFormat("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(e),i=a=>{var o;return parseInt(((o=s.find(l=>l.type===a))==null?void 0:o.value)??"0",10)};return new Date(i("year"),i("month")-1,i("day"),i("hour"),i("minute"),i("second"))}catch{return new Date(e)}}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:r,minutes:s}=rv(t);if(!Number.isFinite(r)||!Number.isFinite(s))return new Date(e);const i=new Date(e);return i.setHours(r,s,0,0),i}isSameLocalDay(e,t){const r=new Date(e),s=new Date(t);return r.getFullYear()===s.getFullYear()&&r.getMonth()===s.getMonth()&&r.getDate()===s.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,r=e.getTime()-t.getTime(),s=Math.trunc(r/(1e3*60)),i=Math.trunc(r/(1e3*60*60)),a=Math.trunc(r/(1e3*60*60*24));return Math.abs(r)<1e3*60?"now":Math.abs(s)<60?s>0?`in ${s}m`:`${-s}m ago`:Math.abs(i)<24?i>0?`in ${i}h`:`${-i}h ago`:a>0?`in ${a}d`:`${-a}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const r=new Date(e);return r.setDate(r.getDate()+t),r}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class iv{constructor(e,t){y(this,"siyuanApi");y(this,"archiveStorage");this.siyuanApi=e,this.archiveStorage=t}async execute(e,t){try{if(typeof t=="string")return this.executeSimpleAction(e,t);const r=t;switch(r.action){case"keep":return this.executeKeepAction(e);case"delete":return this.executeDeleteAction(e);case"archive":return this.executeArchiveAction(e);case"customTransition":return this.executeCustomTransition(e,r.nextStatus,r.customHandler);default:return{success:!1,error:`Unknown onCompletion action: ${r.action}`}}}catch(r){return A("Failed to execute onCompletion action",{taskId:e.id,action:t,error:r}),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}async executeSimpleAction(e,t){switch(t){case"keep":return this.executeKeepAction(e);case"delete":return this.executeDeleteAction(e);case"archive":return this.executeArchiveAction(e);default:return{success:!1,error:`Unknown onCompletion action: ${t}`}}}async executeKeepAction(e){return F(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0}}async executeDeleteAction(e){if(!e.linkedBlockId)return W(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return W("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),F(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return W("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}async executeArchiveAction(e){if(!this.archiveStorage)return W("Archive storage not configured, falling back to keep"),this.executeKeepAction(e);try{return await this.archiveStorage.archive(e),F(`Task "${e.name}" completed and archived`,{taskId:e.id}),e.linkedBlockId&&this.siyuanApi&&this.siyuanApi.updateBlock&&F("Task block archived",{blockId:e.linkedBlockId}),{success:!0}}catch(t){return A("Failed to archive task",{taskId:e.id,error:t}),{success:!1,error:`Failed to archive task: ${t instanceof Error?t.message:"Unknown error"}`}}}async executeCustomTransition(e,t,r){if(!t)return{success:!1,error:"Custom transition requires nextStatus to be specified"};const s={...e,status:t,updatedAt:new Date().toISOString()};return r&&F(`Executing custom handler: ${r}`,{taskId:e.id}),F(`Task "${e.name}" transitioned to status: ${t}`,{taskId:e.id}),{success:!0,updatedTask:s}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return W("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return A("Failed to check for nested items",{blockId:e,error:t}),!0}}}function av(n){var r;const e=new Date,t=e.toISOString();if(n.completionCount=(n.completionCount||0)+1,n.currentStreak=(n.currentStreak||0)+1,n.bestStreak=Math.max(n.bestStreak||0,n.currentStreak),n.recentCompletions||(n.recentCompletions=[]),n.recentCompletions.push(t),n.recentCompletions.length>ga&&(n.recentCompletions=n.recentCompletions.slice(-ga)),(r=n.smartRecurrence)!=null&&r.enabled){n.completionHistory||(n.completionHistory=[]);const s=new Date(n.dueAt),i=Math.round((e.getTime()-s.getTime())/(1e3*60)),a={scheduledFor:n.dueAt,completedAt:t,delayMinutes:i,dayOfWeek:e.getDay(),context:{tags:n.tags||[],relatedBlocks:n.linkedBlockId?[n.linkedBlockId]:[]}};n.completionHistory.push(a),n.completionHistory.length>100&&(n.completionHistory=n.completionHistory.slice(-100))}n.snoozeCount=0,n.lastCompletedAt=t,n.updatedAt=t}function ov(n){n.missCount=(n.missCount||0)+1,n.currentStreak=0,n.updatedAt=new Date().toISOString()}class lv{constructor(e,t){y(this,"intervalMs");y(this,"timeoutId",null);y(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:Xo,r=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},r)}}const Bn=class Bn{constructor(e,t=Xo,r){y(this,"storage");y(this,"recurrenceEngine");y(this,"onCompletionHandler");y(this,"emittedDue",new Set);y(this,"emittedMissed",new Set);y(this,"timezoneHandler");y(this,"isChecking",!1);y(this,"lastCheckStartTime",0);y(this,"plugin",null);y(this,"listeners",{"task:due":new Set,"task:overdue":new Set});y(this,"MAX_EMITTED_ENTRIES",1e3);y(this,"EMITTED_RETENTION_DAYS",30);y(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);y(this,"persistTimeoutId",null);y(this,"emittedStateReady",null);y(this,"timer");this.storage=e,this.recurrenceEngine=new nv,this.onCompletionHandler=new iv(r),this.timezoneHandler=new sv,this.plugin=r||null,this.timer=new lv(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().then(()=>{this.checkDueTasks(),this.timer.start(),F("Scheduler started")},e=>{A("Failed to load emitted state; starting scheduler with empty state",e),this.checkDueTasks(),this.timer.start(),F("Scheduler started (with empty emitted state)")})}async stop(){this.timer.stop(),this.persistTimeoutId!==null&&(globalThis.clearTimeout(this.persistTimeoutId),this.persistTimeoutId=null);try{await this.persistEmittedState()}catch(e){A("Failed to persist emitted state during stop",e)}F("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)W("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const r of t){if(!this.isActive(r))continue;const s=new Date(r.dueAt),i=s<=e;if(i){const o=this.buildOccurrenceKey(r.id,s,"hour");this.emittedDue.has(o)||(this.emitEvent("task:due",{taskId:r.id,dueAt:s,context:"today",task:r}),this.registerEmittedKey("due",o),F(`Task due: ${r.name}`,{taskId:r.id,dueAt:r.dueAt}))}const a=r.lastCompletedAt?new Date(r.lastCompletedAt):null;if(i&&e.getTime()-s.getTime()>=Ch&&(!a||a<s)){const o=this.buildOccurrenceKey(r.id,s,"hour");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:r.id,dueAt:s,context:"overdue",task:r}),this.registerEmittedKey("missed",o),W(`Task missed: ${r.name}`,{taskId:r.id,dueAt:r.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),r=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=r.set,(t.didTrim||r.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,r){const s=r.getTime(),i=Array.from(t).map(c=>({entry:c,time:this.parseOccurrenceKeyTimestamp(c)}));let a=i.filter(({time:c})=>c===null||c>=s),o=a.length!==i.length;a.length>this.MAX_EMITTED_ENTRIES&&(a=a.sort((c,u)=>(c.time??0)-(u.time??0)).slice(-this.MAX_EMITTED_ENTRIES),o=!0);const l=new Set(a.map(({entry:c})=>c));return o&&F(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${l.size}`),{set:l,didTrim:o}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const r=e.slice(t+1);if(!r)return null;const s=r.length===13?`${r}:00:00.000Z`:r,i=new Date(s);return Number.isNaN(i.getTime())?null:i.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const r=JSON.parse(JSON.stringify(t)),s=new Date;r.doneAt=s.toISOString(),av(r);const i=JSON.parse(JSON.stringify(r));try{await this.storage.archiveTask(i)}catch(u){A(`Failed to archive task "${r.name}"`,{taskId:r.id,error:u instanceof Error?u.message:String(u)})}const a=r.onCompletion||"keep",o=await this.onCompletionHandler.execute(r,a);if(o.success||A(`OnCompletion action failed for task "${r.name}"`,{taskId:r.id,action:a,error:o.error}),o.warnings)for(const u of o.warnings)W(u,{taskId:r.id});const l=new Date(r.dueAt),c=this.recurrenceEngine.calculateNext(l,r.frequency,{completionDate:s,whenDone:r.whenDone});if(!c){r.enabled=!1,await this.storage.saveTask(r),F(`Task "${r.name}" recurrence series exhausted, disabled`);return}r.dueAt=c.toISOString(),r.doneAt=void 0,await this.storage.saveTask(r),F(`Task "${r.name}" completed and rescheduled to ${c.toISOString()}`)}async delayTask(e,t){const r=this.storage.getTask(e);if(!r)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(r);const s=new Date(r.dueAt),i=new Date(s.getTime()+t*60*1e3);r.dueAt=i.toISOString(),r.snoozeCount=(r.snoozeCount||0)+1,await this.storage.saveTask(r),F(`Task "${r.name}" delayed by ${t} minutes to ${i.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const r=new Date(t.dueAt),s=this.timezoneHandler.tomorrow();s.setHours(r.getHours(),r.getMinutes(),0,0),t.dueAt=s.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),F(`Task "${t.name}" delayed to tomorrow: ${s.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);ov(t);const r=new Date(t.dueAt),s=this.recurrenceEngine.calculateNext(r,t.frequency);if(!s){t.enabled=!1,await this.storage.saveTask(t),F(`Task "${t.name}" recurrence series exhausted on skip, disabled`);return}t.dueAt=s.toISOString(),await this.storage.saveTask(t),F(`Task "${t.name}" skipped to ${s.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),F("First run detected, no recovery needed");return}F(`Recovering missed tasks since ${e.toISOString()}`);let r=0;for(const s of this.storage.getEnabledTasks())try{const i=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));let a=0;i.length>Bn.MAX_MISSED_EMISSIONS_PER_TASK&&W(`Task "${s.name}" has ${i.length} missed occurrences, capping to ${Bn.MAX_MISSED_EMISSIONS_PER_TASK}`);for(const o of i){if(a>=Bn.MAX_MISSED_EMISSIONS_PER_TASK)break;const l=this.buildOccurrenceKey(s.id,o,"exact");this.emittedMissed.has(l)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:o,context:"overdue",task:s}),this.registerEmittedKey("missed",l),a++,r++)}await this.advanceToNextFutureOccurrence(s,t)}catch(i){A(`Failed to recover task ${s.id}:`,i)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),F(`Missed task recovery completed: ${r} overdue events emitted`)}async advanceToNextFutureOccurrence(e,t){const r=new Date(e.dueAt);if(r>=t)return;let s=r,i=0;for(;s<t&&i<Xs;){const a=this.recurrenceEngine.calculateNext(s,e.frequency);if(!a){e.enabled=!1,await this.storage.saveTask(e),F(`Task "${e.name}" recurrence series exhausted during recovery, disabled`);return}s=a,i++}s>r&&(e.dueAt=s.toISOString(),await this.storage.saveTask(e),F(`Advanced task "${e.name}" to ${s.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(ma);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){A("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(ma,{timestamp:e.toISOString()})}catch(t){A("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const r=this.listeners[e];for(const s of r)try{const i=s(t);i instanceof Promise&&i.catch(a=>{A(`Scheduler listener error for ${e}:`,a)})}catch(i){A(`Scheduler listener error for ${e}:`,i)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Nh,r=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(r>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(fa),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(s=>typeof s=="string"):[],r=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(s=>typeof s=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(r.slice(-this.MAX_EMITTED_ENTRIES)),F("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){A("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(fa,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){A("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,r){return r==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}};y(Bn,"MAX_MISSED_EMISSIONS_PER_TASK",50);let si=Bn;const cv=7,Va=2e3;class uv{constructor(e,t){y(this,"plugin");y(this,"storageKey");y(this,"notifications",new Map);y(this,"escalations",new Map);y(this,"lastCleanup",new Date);y(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const r of t.notifications)this.notifications.set(r.taskKey,r);if(Array.isArray(t.escalations))for(const r of t.escalations)this.escalations.set(r.taskId,r);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),F(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){A("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,ki("Saved notification state")}catch(e){A("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(`due:${e}`);return t!==void 0&&t.type==="due"}markNotified(e){if(this.notifications.set(`due:${e}`,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>Va){const t=Array.from(this.notifications.entries()).sort((s,i)=>new Date(s[1].notifiedAt).getTime()-new Date(i[1].notifiedAt).getTime());t.slice(0,t.length-Va+100).forEach(([s])=>this.notifications.delete(s))}}hasMissed(e){const t=this.notifications.get(`missed:${e}`);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(`missed:${e}`,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const r=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:r,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,r}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const r=new Date(t);return`${e}:${r.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const r=new Date(e.getTime()-cv*24*60*60*1e3);let s=0;for(const[i,a]of this.notifications.entries())new Date(a.notifiedAt)<r&&(this.notifications.delete(i),s++);s>0&&(F(`Cleaned up ${s} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function hv(n){return{id:n.id,name:n.name,dueAt:n.dueAt,frequency:n.frequency,linkedBlockId:n.linkedBlockId,linkedBlockContent:n.linkedBlockContent,priority:n.priority,tags:n.tags,notificationChannels:n.notificationChannels,completionCount:n.completionCount,missCount:n.missCount,currentStreak:n.currentStreak,bestStreak:n.bestStreak}}const fv=30*1e3,dv=30*60*1e3,rn=500;class vv{constructor(e,t={}){y(this,"plugin");y(this,"config");y(this,"queue",[]);y(this,"dedupeKeys",new Set);y(this,"flushIntervalId",null);y(this,"fetcher");y(this,"notificationState");y(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...da},this.notificationState=t.notificationState??new uv(this.plugin,Oh)}async init(){try{await this.notificationState.load()}catch(e){A("Failed to load notification state",e)}try{await this.loadConfig()}catch(e){A("Failed to load event config",e)}try{await this.loadQueue()}catch(e){A("Failed to load event queue",e),this.queue=[],this.dedupeKeys=new Set}try{await this.flushQueueOnStartup()}catch(e){A("Failed to flush queue on startup",e)}this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(F(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(ua);e&&(this.config={...da,...e})}catch(e){A("Failed to load event config",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(ua,e)}async loadQueue(){try{const e=await this.plugin.loadData(ha);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>rn){const r=this.queue.length-rn;this.queue=this.queue.slice(-rn),W(`Event queue trimmed to ${rn} entries (dropped ${r})`)}}}catch(e){A("Failed to load event queue",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-Is);await this.plugin.saveData(ha,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue().catch(e=>A("Periodic queue flush failed",e))},Mh))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker();try{await this.notificationState.forceSave()}catch(e){A("Failed to save notification state during shutdown",e)}try{await this.persistQueue()}catch(e){A("Failed to persist queue during shutdown",e)}}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t).catch(r=>{A("Failed to handle task due event",r)})}),e.on("task:overdue",t=>{this.handleTaskOverdue(t).catch(r=>{A("Failed to handle task overdue event",r)})})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const r=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,r),this.notificationState.markNotified(t),this.notificationState.save().catch(s=>{A("Failed to save notification state after task due",s)})}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const r=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,r),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save().catch(s=>{A("Failed to save notification state after task overdue",s)})}async emitTaskEvent(e,t,r=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const s=this.buildDedupeKey(e,t);if(this.isDuplicate(s))return;const i=this.buildPayload(e,t,s,1,r);await this.sendPayload(i)?(this.markDelivered(s),await this.persistQueue()):this.enqueue(i)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:va,version:pa,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},r=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return r.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${r.status}: ${r.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e instanceof Error?e.message:String(e)}`}}}async flushQueue(){var s;if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const r=[];for(const i of this.queue){if(new Date(i.nextAttemptAt).getTime()>e){r.push(i);continue}const a={...i.payload,delivery:{...i.payload.delivery,attempt:i.attempt}};try{if(await this.sendPayload(a))this.markDelivered(a.delivery.dedupeKey),t=!0;else{const l=i.attempt+1,c=this.getRetryDelay(l);r.push({...i,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}catch(o){A("Error sending queued event",{event:a.event,taskId:(s=a.task)==null?void 0:s.id,attempt:a.delivery.attempt,error:o instanceof Error?o.message:String(o)});const l=i.attempt+1,c=this.getRetryDelay(l);r.push({...i,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}if(t){this.queue=r;try{await this.persistQueue()}catch(i){A("Failed to persist queue after flush",i)}}}getConfig(){return{...this.config}}buildPayload(e,t,r,s,i=0){const a=new Date,o=new Date(t.dueAt),l=a.getTime()-o.getTime();return{event:e,source:va,version:pa,occurredAt:a.toISOString(),task:hv(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:i,channels:t.notificationChannels||[]},delivery:{dedupeKey:r,attempt:s}}}buildDedupeKey(e,t){const r=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${r}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>Is){const t=Array.from(this.dedupeKeys).slice(-Is);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=rn){const r=this.queue.length-rn+1;this.queue.splice(0,r),W(`Event queue capped at ${rn}. Dropped ${r} oldest entr${r===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue().catch(r=>{A("Failed to persist event queue",r)})}getRetryDelay(e){const t=fv*Math.pow(2,e-1);return Math.min(t,dv)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const r=new TextEncoder,s=r.encode(t),i=r.encode(e),a=await crypto.subtle.importKey("raw",s,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),o=await crypto.subtle.sign("HMAC",a,i);return Array.from(new Uint8Array(o)).map(c=>c.toString(16).padStart(2,"0")).join("")}return W("Web Crypto API not available - signature generation disabled"),""}catch(r){return A("Failed to generate signature",r),""}}async buildHeaders(e){const t=JSON.stringify(e),r=new Date().toISOString();let s="";this.config.n8n.sharedSecret&&(s=await this.generateSignature(t+r,this.config.n8n.sharedSecret));const i={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":r};return s&&(i["X-Shehab-Signature"]=s),this.config.n8n.useLegacyAuth&&this.config.n8n.sharedSecret&&(i["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),i}async sendPayload(e,t=!1){try{const r=JSON.stringify(e),s=await this.buildHeaders(e),i=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:s,body:r});if(!i.ok)return A("n8n webhook failed",{status:i.status,statusText:i.statusText}),!1;if(t){const a=await i.json().catch(()=>null);return!!(a&&a.ok)}return!0}catch(r){return A("Failed to send n8n event",r),!1}}}class pv{constructor(){y(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var r;return(r=this.handlers.get(e))==null?void 0:r.delete(t)}}emit(e,t){var r;(r=this.handlers.get(e))==null||r.forEach(s=>{try{s(t)}catch(i){A(`PluginEventBus handler error for "${String(e)}"`,i)}})}clear(){this.handlers.clear()}}function gv(n){if(n&&typeof n=="object"){const t=n;if(t.element instanceof HTMLElement)return{element:t.element};if(t.data&&typeof t.data=="object"){const r=t.data;if(r.element instanceof HTMLElement)return{element:r.element}}}if(n instanceof HTMLElement)return{element:n};if(n&&typeof n=="object"&&"querySelector"in n)return{element:n};A("[DockAdapter] Could not resolve dock element from argument",{type:typeof n,value:n});const e=document.createElement("div");return e.className="rtm-dock-fallback",e.style.cssText="width:100%;height:100%;overflow:auto;",typeof document<"u"&&document.body&&W("[DockAdapter] Using detached fallback container. Dashboard may not be visible."),{element:e}}function mv(n){return n?n.isConnected?!0:(W("[DockAdapter] Dock element is not connected to DOM"),!1):!1}const Za="task-recurring-notfication-mangmant-dock";class yv extends Wi.Plugin{constructor(){super(...arguments);y(this,"pluginEventBus");y(this,"taskStorage");y(this,"recurrenceEngine");y(this,"scheduler");y(this,"eventService");y(this,"dashboardComponent",null);y(this,"dockEl",null);y(this,"topBarElement",null);y(this,"initialized",!1)}async onload(){var t;console.log(`[${this.name}] Loading plugin v${this.version||"1.0.0"}...`);try{this.pluginEventBus=new pv,this.recurrenceEngine=new tv,this.taskStorage=new Vf(this),await this.taskStorage.init(),this.scheduler=new si(this.taskStorage,void 0,this),this.eventService=new vv(this),await this.eventService.init(),this.eventService.bindScheduler(this.scheduler),this.registerTopBarButton(),this.addDock({config:{position:"RightBottom",size:{width:380,height:550},icon:"iconCalendar",title:((t=this.i18n)==null?void 0:t.dockTitle)||"Recurring Tasks",hotkey:"‚åò‚å•T"},data:{text:"Recurring Tasks"},type:Za,init:r=>{const{element:s}=gv(r);this.dockEl=s,mv(s)||console.warn(`[${this.name}] Dock element validation failed ‚Äî mounting anyway`),this.mountDashboard(s)},destroy:()=>{this.unmountDashboard()}}),this.initialized=!0,console.log(`[${this.name}] ‚úÖ Plugin loaded successfully`)}catch(r){console.error(`[${this.name}] ‚ùå Plugin load failed:`,r),this.safeShowMessage(`Plugin load error: ${r.message}`,"error")}}onLayoutReady(){if(!this.initialized){console.warn(`[${this.name}] onLayoutReady skipped: plugin not initialized`);return}console.log(`[${this.name}] Layout ready ‚Äî starting scheduler`),this.scheduler.start()}async onunload(){var t;console.log(`[${this.name}] Unloading plugin...`);try{this.scheduler&&await this.scheduler.stop(),this.unmountDashboard(),(t=this.topBarElement)!=null&&t.parentElement&&(this.topBarElement.parentElement.removeChild(this.topBarElement),this.topBarElement=null),this.taskStorage&&(await this.taskStorage.flush(),this.taskStorage.stopSyncRetryProcessor()),this.eventService&&await this.eventService.shutdown(),this.pluginEventBus&&this.pluginEventBus.clear(),this.initialized=!1,console.log(`[${this.name}] ‚úÖ Plugin unloaded successfully`)}catch(r){console.error(`[${this.name}] Error during unload:`,r)}}registerTopBarButton(){var t;try{this.topBarElement=this.addTopBar({icon:"iconCalendar",title:((t=this.i18n)==null?void 0:t.topBarTitle)||"Recurring Tasks",position:"right",callback:()=>{this.toggleDock()}}),console.log(`[${this.name}] Top bar button registered`)}catch(r){console.warn(`[${this.name}] Top bar registration failed:`,r)}}toggleDock(){try{let t=this.dockEl;if(!t){const s=document.querySelectorAll(`[data-type="${Za}"]`);t=s.length>0?s[0]:null}if(!t)return;if(t.style.display!=="none"&&t.offsetParent!==null)t.style.display="none";else{t.style.display="";const s=t.querySelector("input, button, [tabindex]");s&&setTimeout(()=>s.focus(),100)}}catch(t){console.error(`[${this.name}] Toggle dock failed:`,t),this.safeShowMessage("Failed to toggle task panel","error")}}mountDashboard(t){this.dashboardComponent&&(console.warn(`[${this.name}] Dashboard already mounted, unmounting first`),this.unmountDashboard());try{this.dashboardComponent=Nu(Ih,{target:t,props:{taskStorage:this.taskStorage,recurrenceEngine:this.recurrenceEngine,taskScheduler:this.scheduler,notificationService:this.eventService,eventBus:this.pluginEventBus,plugin:this}}),console.log(`[${this.name}] Dashboard mounted successfully`)}catch(r){console.error(`[${this.name}] Dashboard mount failed:`,r),this.safeShowMessage("Failed to initialize task dashboard","error")}}unmountDashboard(){var t;if(this.dashboardComponent){try{$u(this.dashboardComponent),console.log(`[${this.name}] Dashboard unmounted from`,((t=this.dockEl)==null?void 0:t.tagName)||"unknown")}catch(r){console.error(`[${this.name}] Dashboard unmount error:`,r)}this.dashboardComponent=null,this.dockEl=null}}safeShowMessage(t,r="info"){try{Wi.showMessage(t,6e3,r)}catch{console.warn(`[${this.name}] showMessage unavailable: ${t}`)}}}module.exports=yv;typeof module<"u"&&module.exports&&(module.exports=module.exports.default||module.exports);
